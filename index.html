<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- ç§»åŠ¨ç«¯è§†å£è®¾ç½®ï¼šç¦æ­¢ç¼©æ”¾ï¼Œé€‚é…è®¾å¤‡å®½åº¦ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- iOS Web App å…¨å±æ¨¡å¼æ”¯æŒ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="PhD Flow">

    <title>PhD Flow</title>
    
    <!-- å›¾æ ‡æ”¯æŒ (éœ€æ±‚3: ä½¿ç”¨ä¸Šä¼ çš„å›¾æ ‡) -->
    <!-- iOS æ¡Œé¢å›¾æ ‡ -->
    <link rel="apple-touch-icon" sizes="180x180" href="./icon-180.png">

    <!-- é€šç”¨ favicon / Android å›¾æ ‡ -->
    <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./icon-192.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./icon-192.png">
    <link rel="shortcut icon" href="./icon-192.png">
    
    <!-- å…³é”®æ ·å¼ç›´æ¥å†…è” (Critical CSS) -->
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #f9fafb; }
        
        /* --- å¯åŠ¨åŠ è½½å±‚æ ·å¼ (éœ€æ±‚4) --- */
        #app-loading {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #f9fafb; /* bg-slate-50 */
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.6s ease-out, visibility 0.6s;
        }
        
        #app-loading.fade-out {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        /* ç®€å•çš„è„‰å†²åŠ¨ç”» */
        .loading-pulse {
            animation: pulse-text 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-text {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* --- åŸæœ‰åŠ¨ç”»å®šä¹‰ --- */
        @keyframes slide-up { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scale-in { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes pulse-soft { 0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.2); } 70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); } 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); } }
        @keyframes bounce-slow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
        @keyframes spin { to { transform: rotate(360deg); } }

        .animate-slide-up { animation: slide-up 0.3s ease-out; }
        .animate-fade-in { animation: fade-in 0.2s ease-out; }
        .animate-scale-in { animation: scale-in 0.2s ease-out; }
        .animate-pulse-soft { animation: pulse-soft 2s infinite; }
        .animate-bounce-slow { animation: bounce-slow 2s infinite ease-in-out; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .primary-gradient { background: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%); }
        .bg-gradient-psych { background: linear-gradient(135deg, #F5F3FF 0%, #EEF2FF 100%); border: 1px solid #E0E7FF; }
        .card-gradient-1 { background: linear-gradient(135deg, #F5F3FF 0%, #EEF2FF 100%); }
        .card-gradient-2 { background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%); }
        .card-gradient-done { background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%); }
        .logo-gradient { background: linear-gradient(135deg, #818CF8 0%, #4F46E5 100%); }

        .goal-tag { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 999px; font-size: 11px; font-weight: 700; letter-spacing: 0.05em; color: white; box-shadow: 0 2px 6px rgba(0,0,0,0.08); transform: translateY(-1px); }
        .tag-purple { background: linear-gradient(135deg, #a78bfa 0%, #818cf8 100%); }
        .tag-blue { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); }
        .tag-cyan { background: linear-gradient(135deg, #22d3ee 0%, #06b6d4 100%); }
        .tag-green { background: linear-gradient(135deg, #34d399 0%, #10b981 100%); }
        .tag-orange { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
        .tag-gray { background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%); }

        .progress-track { background-color: rgba(255,255,255,0.6); border-radius: 9999px; height: 14px; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.8); }
        .progress-jelly { height: 100%; border-radius: 9999px; background: linear-gradient(90deg, #7c3aed 0%, #4f46e5 100%); position: relative; transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .progress-jelly::after { content: ''; position: absolute; right: 2px; top: 50%; transform: translateY(-50%); width: 6px; height: 6px; background: white; border-radius: 50%; opacity: 0.8; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .progress-jelly.done { background: linear-gradient(90deg, #10B981 0%, #059669 100%); }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #ffffff; border: 2px solid #6366F1; cursor: pointer; box-shadow: 0 2px 6px rgba(99, 102, 241, 0.3); margin-top: -10px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #E0E7FF; border-radius: 999px; }

        .mood-icon { transition: all 0.2s; filter: grayscale(100%); opacity: 0.5; transform: scale(0.9); }
        .mood-icon.selected { transform: scale(1.15); filter: grayscale(0%); opacity: 1; }

        .spinner { border: 2px solid rgba(0,0,0,0.1); border-top-color: #6366F1; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        /* Loading Screen specific styles */
        #loading-text { font-size: 0.75rem; }
        
        /* Timeline Connector */
        .timeline-line { position: absolute; left: 6px; top: 12px; bottom: -20px; width: 2px; background-color: #e2e8f0; z-index: 0; }
        .group:last-child .timeline-line { display: none; }
        
        /* Article Type Tags */
        .badge-journal { background-color: #eff6ff; color: #3b82f6; border: 1px solid #dbeafe; }
        .badge-conf { background-color: #f5f3ff; color: #8b5cf6; border: 1px solid #ede9fe; }
        .badge-project { background-color: #ecfdf5; color: #10b981; border: 1px solid #d1fae5; }
        .badge-grant { background-color: #fff7ed; color: #f97316; border: 1px solid #ffedd5; }
        .badge-book { background-color: #fff1f2; color: #be123c; border: 1px solid #ffe4e6; }
        .badge-other { background-color: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; }
        
        /* Scrollbar for milestones */
        .milestones-scroll::-webkit-scrollbar { width: 4px; }
        .milestones-scroll::-webkit-scrollbar-track { background: transparent; }
        .milestones-scroll::-webkit-scrollbar-thumb { background-color: #e2e8f0; border-radius: 20px; }

        /* Custom Calendar Styles */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { display: flex; align-items: center; justify-content: center; height: 36px; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.2s; }
        .calendar-day:hover { background-color: #f3f4f6; }
        .calendar-day.selected { background-color: #4f46e5; color: white; font-weight: bold; }
        .calendar-day.today { border: 1px solid #6366f1; color: #6366f1; }
        .calendar-day.empty { pointer-events: none; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 selection:bg-indigo-100 min-h-screen">

    <!-- 1. åŠ è½½å±‚ (éœ€æ±‚4) -->
    <div id="app-loading">
        <div class="text-center text-slate-500 text-sm">
            <div class="mb-3 loading-pulse font-medium text-slate-600 text-lg">æ­£åœ¨å”¤é†’ PhD Flowâ€¦</div>
            <div class="text-xs opacity-80">å¦‚æœåŠ è½½æ—¶é—´æœ‰ç‚¹ä¹…ï¼Œè¯·ç¨ç­‰ç‰‡åˆ»ã€‚</div>
        </div>
    </div>

    <!-- 2. åº”ç”¨ä¸»å®¹å™¨ï¼šåˆå§‹ä¸ºç©ºï¼Œç­‰å¾… JS å¡«å…… -->
    <div id="app" class="max-w-md mx-auto min-h-screen bg-gray-50 shadow-2xl overflow-hidden relative flex flex-col">
        <!-- å†…å®¹ç”± JS ç”Ÿæˆ -->
    </div>
    
    <!-- ç‹¬ç«‹çš„æ—¥å†æŒ‚è½½ç‚¹ï¼Œé¿å…ä¸»æ¸²æŸ“åˆ·æ–°å¯¼è‡´çš„é—ªé€€ -->
    <div id="calendar-mount" class="relative z-[100]"></div>

    <!-- å…³é”®è„šæœ¬ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- æ ¸å¿ƒé€»è¾‘ -->
    <script>
        // --- æ ¸å¿ƒæ•°æ® ---
        
        const psychQuotes = [
            "ä»Šå¤©å†™çš„æ¯ä¸€ä¸ªå­—ï¼Œéƒ½ä¼šåœ¨æœªæ¥ä¸ºä½ å‘å…‰ âœ¨",
            "ä¸å¿…ä¸€ä¸‹å­å†™å®Œä¸€ç« ï¼Œåªè¦ä»Šå¤©æ¯”æ˜¨å¤©å¤šä¸€ç‚¹ç‚¹å°±å¥½ã€‚",
            "ä¸€ç¯‡è®ºæ–‡çš„è¯ç”Ÿï¼Œå°±æ˜¯æ— æ•°æ¬¡å°ä¿®æ”¹å åŠ å‡ºæ¥çš„å¥‡è¿¹ ğŸŒ±",
            "æ‹’ç¨¿åªæ˜¯è·¯çº¿ä¸Šçš„ä¸€ä¸ªå¼¯é“ï¼Œä¸æ˜¯ç»ˆç‚¹ ğŸƒâ€â™€ï¸",
            "ä½ å†™ä¸‹çš„æ¯ä¸€ä¸ªå­—ï¼Œéƒ½æ˜¯åœ¨ä¸ºæœªæ¥çš„è‡ªå·±é“ºè·¯ã€‚",
            "è¯„èŒç§°æ˜¯ä¸€é˜µé£ï¼Œä½ çš„æˆé•¿æ˜¯é•¿ä¹…çš„åº•æ°” ğŸ’¨",
            "å­¦æœ¯æ˜¯ä¸€åœºé©¬æ‹‰æ¾ï¼Œå…è®¸è‡ªå·±å¶å°”åœä¸‹æ¥ç³»é‹å¸¦ ğŸ‘Ÿ",
            "ä¸è¦å®³æ€•åˆç¨¿çš„ç²—ç³™ï¼Œé‚£æ˜¯ç²¾é›•ç»†ç¢çš„åŸææ–™ ğŸ’",
            "æ¯ä¸€ä¸ªè§£å†³çš„å°bugï¼Œéƒ½æ˜¯é€šå¾€å­¦ä½çš„åšå®å°é˜¶ã€‚",
            "æ²¡æœ‰ä»€ä¹ˆç™½èµ°çš„è·¯ï¼Œè¿™ä¸€åˆ»çš„è¿·èŒ«ä¹Ÿæ˜¯æ¢ç´¢çš„ä¸€éƒ¨åˆ† ğŸ—ºï¸",
            "å®¡ç¨¿äººçš„æ„è§è™½ç„¶å°–é”ï¼Œä½†èƒ½è®©ä½ çš„é€»è¾‘é“ ç”²æ›´åšå›º ğŸ›¡ï¸",
            "é¡¹ç›®ç”³è¯·ä¹¦çš„æ¯ä¸€æ¬¡æ‰“ç£¨ï¼Œéƒ½åœ¨è®©ä½ å¯¹ç ”ç©¶é—®é¢˜çœ‹å¾—æ›´æ¸… ğŸ’¡",
            "ä»Šå¤©ä¸æƒ³å†™ä¹Ÿæ²¡å…³ç³»ï¼Œå¤§è„‘åœ¨åå°æ‚„æ‚„æ•´ç†æ€è·¯å‘¢ ğŸ§ ",
            "ä½ çš„ä»·å€¼ä¸åªæ˜¯ä¸€å¼ å½•ç”¨é€šçŸ¥ï¼Œè€Œåœ¨äºæ¢ç´¢æœªçŸ¥çš„å‹‡æ°” ğŸ¦",
            "åœ¨è¿™ä¸ªç»†åˆ†é¢†åŸŸï¼Œä½ å°±æ˜¯æœ€æƒå¨çš„å£°éŸ³ï¼Œç›¸ä¿¡è‡ªå·± ğŸ¤",
            "æ— è®ºå¤šæ…¢ï¼Œåªè¦åœ¨èµ°ï¼Œå°±æ˜¯åœ¨é è¿‘ç»ˆç‚¹ ğŸ¢",
            "å“ªæ€•åªæ”¹å¥½äº†ä¸€ä¸ªå›¾è¡¨ï¼Œä»Šå¤©ä¹Ÿæ˜¯æœ‰äº§å‡ºçš„ä¸€å¤© ğŸ“Š",
            "ä¸è¦å’Œåˆ«äººçš„é«˜å…‰æ—¶åˆ»å¯¹æ¯”ï¼Œä¸“æ³¨è‡ªå·±çš„æ¯ä¸€æ­¥è„šå° ğŸ‘£",
            "ä¼‘æ¯ä¸æ˜¯å·æ‡’ï¼Œæ˜¯ä¸ºäº†è®©çµæ„Ÿæœ‰ç©ºéš™é’»è¿›æ¥ â˜•",
            "ä½ æ­£åœ¨æ­å»ºäººç±»çŸ¥è¯†è¾¹ç•Œçš„ä¸€å—å°ç§¯æœ¨ï¼Œè¿™å¾ˆäº†ä¸èµ· ğŸ§±",
            "è¿”ä¿®è™½ç„¶ç—›è‹¦ï¼Œä½†é‚£æ˜¯è®ºæ–‡èœ•å˜æˆè¶çš„å¿…ç»é˜µç—› ğŸ¦‹",
            "æŠŠå¤§ç›®æ ‡æ‹†æˆå°ä»»åŠ¡ï¼Œåä¸‹è¿™åªåä¸º'è®ºæ–‡'çš„å¤§è±¡ ğŸ˜",
            "æœ‰æ—¶å€™ï¼Œ'å®Œæˆ'æ¯”'å®Œç¾'æ›´é‡è¦ï¼Œå…ˆè®©å®ƒå­˜åœ¨ âœ…",
            "å…³ä¸Šç”µè„‘å»æ•£æ­¥å§ï¼Œå¥½ç‚¹å­å¾€å¾€åœ¨è·¯ä¸Šç­‰ä½  ğŸŒ³",
            "ç§‘ç ”å¾ˆè‹¦ï¼Œä½†æ¢ç´¢çœŸç†çš„è¿‡ç¨‹å¾ˆé…· ğŸ˜",
            "å…è®¸è‡ªå·±æœ‰ä½è°·æœŸï¼Œé‚£æ˜¯èµ·è·³å‰çš„æ·±è¹² ğŸ“‰",
            "ä½ ä¸æ˜¯å­¤å†›å¥‹æˆ˜ï¼Œæ— æ•°å‰äººä¹Ÿæ›¾åœ¨è¿™ä¸ªè·¯å£å¾˜å¾Š ğŸ¤",
            "æ‰€æœ‰çš„ç„¦è™‘éƒ½æºäºæƒ³å¾—å¤ªå¤šè€Œåšå¾—å¤ªå°‘ï¼Œè¯•ç€å†™ä¸‹ç¬¬ä¸€å¥ ğŸ“",
            "ä¹¦ç¨¿çš„åšåº¦ï¼Œæ˜¯ä½ æ€æƒ³æ·±åº¦çš„ç‰©ç†åˆ»åº¦ ğŸ“",
            "è¢«æ‹’ç¨¿ä¸ä»£è¡¨ä½ ä¸è¡Œï¼Œåªæ˜¯ç¼˜åˆ†æœªåˆ°ï¼Œæ¢ä¸ªæœŸåˆŠè¯•è¯• ğŸ’Œ",
            "èŒç§°è¯„å®šåªæ˜¯å¤–éƒ¨è¯„ä»·ï¼Œå†…å¿ƒçš„å­¦æœ¯ç«ç„°ç”±ä½ è‡ªå·±æŒæ§ ğŸ”¥",
            "ä¿æŒå¥½å¥‡å¿ƒï¼Œå®ƒæ˜¯å¸¦ä½ èµ°å‡ºç“¶é¢ˆæœŸæœ€å¥½çš„å‘å¯¼ ğŸ§­",
            "ä»Šå¤©ä¹Ÿæ˜¯åŠªåŠ›çš„ä¸€å¤©ï¼Œç»™è‡ªå·±ä¸€ä¸ªå°å°çš„å¥–åŠ±å§ ğŸ¬",
            "æ–‡çŒ®çœ‹ä¸å®Œæ²¡å…³ç³»ï¼ŒæŠ“ä½æ ¸å¿ƒè„‰ç»œå°±æ˜¯èƒœåˆ© ğŸ“–",
            "ä½ çš„ç ”ç©¶æˆ–è®¸æš‚æ—¶æ— äººå–å½©ï¼Œä½†æ—¶é—´ä¼šè¯æ˜å®ƒçš„ä»·å€¼ â³",
            "ä¸è¦è®©'å†’å……è€…ç»¼åˆå¾'æ‰“è´¥ä½ ï¼Œä½ å€¼å¾—ç°åœ¨çš„ä½ç½® ğŸ‘‘",
            "æ¯ä¸€ä¸ªæ·±å¤œçš„åšæŒï¼Œéƒ½åœ¨æŠŠæ¢¦æƒ³å˜æˆç°å® ğŸŒ™",
            "å®éªŒå¤±è´¥äº†ï¼Ÿé‚£æ˜¯æ’é™¤äº†ä¸€ä¸ªé”™è¯¯ç­”æ¡ˆï¼Œä¹Ÿæ˜¯è¿›å±• ğŸ§ª",
            "å†™ä¸å‡ºæ¥çš„æ—¶å€™ï¼Œè¯•ç€å»è¯»è¯»ç»å…¸ï¼Œæ‰¾æ‰¾è¯­æ„Ÿ ğŸ“š",
            "ä¿æŒé˜…è¯»ï¼Œä¿æŒæ€è€ƒï¼Œä¿æŒè¾“å‡ºï¼Œä¿æŒçƒ­çˆ± â¤ï¸",
            "å­¦æœ¯åœˆå¾ˆå°ï¼Œä½†ä¸–ç•Œå¾ˆå¤§ï¼Œåˆ«æŠŠçœ¼å‰çš„å›°éš¾å½“æˆå…¨éƒ¨ ğŸŒ",
            "ä½ çš„åŠªåŠ›ï¼Œè—åœ¨æ¯ä¸€è¡Œå‚è€ƒæ–‡çŒ®å’Œæ¯ä¸€ä¸ªè„šæ³¨é‡Œ ğŸ“‘",
            "åˆ«å¿˜äº†ï¼Œä½ å½“åˆä¸ºä»€ä¹ˆå‡ºå‘ï¼Œåˆå¿ƒæ˜¯æœ€å¥½çš„ç‡ƒæ–™ â›½",
            "å“ªæ€•æ˜¯çˆ¬ï¼Œåªè¦æ–¹å‘å¯¹ï¼Œä¹Ÿèƒ½åˆ°è¾¾å±±é¡¶ ğŸ”ï¸",
            "ç»™è‡ªå·±ä¸€ç‚¹è€å¿ƒï¼Œå¥½ä¸œè¥¿éƒ½éœ€è¦æ—¶é—´å»é…é…¿ ğŸ·",
            "ä»Šå¤©çš„ä½ ï¼Œæ¯”åˆšå…¥å­¦çš„ä½ ï¼Œå·²ç»å¼ºå¤§äº†å¤ªå¤š ğŸ’ª",
            "ä¸è¦ä¸ºäº†å‘è¡¨è€Œå‘è¡¨ï¼Œä¸ºäº†çœŸç†è€Œå†™ä½œ âœ’ï¸",
            "æŠŠå¿ƒæƒ…ç…§é¡¾å¥½ï¼Œä¹Ÿæ˜¯ç§‘ç ”å·¥ä½œçš„ä¸€éƒ¨åˆ† ğŸ’†",
            "æ¯ä¸€ä¸ªå¼•ç”¨ï¼Œéƒ½æ˜¯ä½ ä¸å­¦æœ¯å…±åŒä½“çš„ä¸€æ¬¡æ¡æ‰‹ ğŸ¤",
            "ç›¸ä¿¡å¤åˆ©çš„åŠ›é‡ï¼Œæ¯å¤©å‡ ç™¾å­—ï¼Œä¸€å¹´å°±æ˜¯ä¸€æœ¬ä¹¦ ğŸ“ˆ",
            "ä¸ç”¨æ—¶åˆ»ç´§ç»·ï¼Œæ¾å¼›æ„Ÿèƒ½å¸®ä½ è·‘å¾—æ›´è¿œ ğŸƒ",
            "ä½ çš„ç ”ç©¶æœ‰ç‹¬ç‰¹çš„æ„ä¹‰ï¼Œæ²¡äººèƒ½æ›¿ä»£ä½ çš„è§†è§’ ğŸ”­",
            "è¿™ä¹Ÿæ˜¯ä¸€ç§ç”Ÿæ´»ï¼Œåœ¨å¹³æ·¡ä¸­å¯»æ‰¾å‘ç°çš„ä¹è¶£ ğŸ”",
            "é‡åˆ°ç“¶é¢ˆæ—¶ï¼Œä¸å¦¨å›å¤´çœ‹çœ‹å·²ç»èµ°è¿‡çš„è·¯ ğŸ”™",
            "å†™è®ºæ–‡åƒå»ºæˆ¿å­ï¼Œä»Šå¤©æˆ‘ä»¬åªè´Ÿè´£æ¬ä¸€å—ç – ğŸ—ï¸",
            "ä¸è¦å› ä¸ºåˆ«äººçš„ä¼˜ç§€è€Œå¦å®šè‡ªå·±ï¼ŒèŠ±æœŸä¸åŒè€Œå·² ğŸŒº",
            "å­¦æœ¯è‡ªç”±æ˜¯æœ€å¤§çš„å¥¢ä¾ˆå“ï¼Œäº«å—è¿™æ®µçº¯ç²¹çš„æ—¶å…‰ ğŸ•°ï¸",
            "å³ä½¿æ˜¯æœ€ä¼Ÿå¤§çš„å­¦è€…ï¼Œä¹Ÿæ›¾é¢å¯¹è¿‡ç©ºç™½æ–‡æ¡£å‘å‘† ğŸ“„",
            "æ¥å—ä¸å®Œç¾çš„åˆç¨¿ï¼Œå®ƒæ˜¯é€šå‘å®Œç¾çš„å”¯ä¸€æ¡¥æ¢ ğŸŒ‰",
            "ä½ æ­£åœ¨åšçš„äº‹æƒ…å¾ˆéš¾ï¼Œæ‰€ä»¥æ„Ÿåˆ°å›°éš¾æ˜¯æ­£å¸¸çš„ ğŸ§—",
            "ç°åœ¨çš„ç„¦è™‘ï¼Œåå¹´åå†çœ‹ï¼Œå¯èƒ½åªæ˜¯èŒ¶ä½™é¥­åçš„è°ˆèµ„ ğŸµ",
            "ä¸“æ³¨å½“ä¸‹ï¼Œæœªæ¥è‡ªç„¶ä¼šæ¥ ğŸ",
            "åˆ«è®© deadline æˆä¸ºææ…Œçš„æºå¤´ï¼ŒæŠŠå®ƒå½“æˆè¡ŒåŠ¨çš„å·è§’ ğŸº",
            "ä½ çš„æ¯ä¸€æ¬¡æ€è€ƒï¼Œéƒ½åœ¨æ‹“å±•äººç±»è®¤çŸ¥çš„è¾¹ç•Œ ğŸŒŒ",
            "ç´¯äº†å°±ç¡è§‰ï¼Œé†’äº†å†æˆ˜æ–—ï¼Œèº«ä½“æ˜¯ç§‘ç ”çš„æœ¬é’± ğŸ›Œ",
            "ä¸è¦æŠŠè‡ªæˆ‘ä»·å€¼å®Œå…¨ç»‘å®šåœ¨äº§å‡ºä¸Šï¼Œä½ æœ¬èº«å°±å¾ˆçè´µ âœ¨",
            "æ…¢æ…¢æ¥ï¼Œæ¯”è¾ƒå¿« ğŸš²",
            "æµæ°´ä¸äº‰å…ˆï¼Œäº‰çš„æ˜¯æ»”æ»”ä¸ç» ğŸŒŠ",
            "åœ¨è¿™ä¸ªæµ®èºçš„ä¸–ç•Œé‡Œï¼Œå®‰é™åœ°åšå­¦é—®æ˜¯ä¸€ç§ä¿®è¡Œ ğŸ§˜",
            "æ¯ä¸€æ¬¡ä¿®æ”¹ï¼Œéƒ½åœ¨è®©ä½ çš„è§‚ç‚¹æ›´çŠ€åˆ©ï¼Œé€»è¾‘æ›´ä¸¥å¯† ğŸ”ª",
            "ä¸è¦é¢„æ”¯æ˜å¤©çš„çƒ¦æ¼ï¼Œè¿‡å¥½ä»Šå¤©çš„ç§‘ç ”ç”Ÿæ´» ğŸ“…",
            "ä½ æ˜¯åœ¨ä¸ºäººç±»çš„çŸ¥è¯†åº“æ·»ç –åŠ ç“¦ï¼Œè¿™å¾ˆç¥åœ£ ğŸ›ï¸",
            "å“ªæ€•åªæ˜¯å˜æ¸…äº†ä¸€ä¸ªå°æ¦‚å¿µï¼Œä¹Ÿæ˜¯å€¼å¾—åº†ç¥çš„è¿›æ­¥ ğŸ‰",
            "ä¿æŒèŠ‚å¥ï¼Œä¸è¦å†²åˆºï¼Œè¿™æ˜¯ä¸€åœºæŒä¹…æˆ˜ âš”ï¸",
            "ä½ çš„æ¯ä¸€ä»½åŠªåŠ›ï¼Œéƒ½ä¸ä¼šè¢«è¾œè´Ÿï¼Œå“ªæ€•ä»¥æ„æƒ³ä¸åˆ°çš„æ–¹å¼ ğŸ",
            "åšä¸€ä¸ªå¿«ä¹çš„ç§‘ç ”äººï¼Œæ¯”åšä¸€ä¸ªé«˜äº§çš„æœºå™¨æ›´é‡è¦ ğŸ˜Š",
            "ä»Šå¤©é˜³å…‰å¾ˆå¥½ï¼Œé€‚åˆå†™å‡ºæ¸©æš–çš„æ–‡å­— â˜€ï¸",
            "æŠŠå¤§ä»»åŠ¡åˆ‡ç¢ï¼Œåˆ‡åˆ°è‡ªå·±æ„¿æ„åŠ¨æ‰‹çš„ç¨‹åº¦ ğŸ°",
            "ä¸è¦ç­‰åˆ°ä¸‡äº‹ä¿±å¤‡æ‰å¼€å§‹ï¼Œå¼€å§‹æœ¬èº«å°±æ˜¯ä¸€ç§å‡†å¤‡ ğŸš€",
            "ä½ çš„è®ºæ–‡æ­£åœ¨æˆé•¿çš„è·¯ä¸Šï¼Œç»™å®ƒä¸€ç‚¹æ—¶é—´ ğŸŒ±",
            "ç›¸ä¿¡è¿‡ç¨‹ï¼Œç»“æœä¼šè‡ªç„¶å‘ç”Ÿ ğŸŒˆ",
            "åªè¦åœ¨å†™ï¼Œå°±æœ‰å¸Œæœ› ğŸŒŸ"
        ];

        const encouragementRules = [
            { keywords: ['éš¾', 'å¡', 'ä¸åŠ¨', 'çƒ¦', 'ä¹±'], msg: "æŠ±æŠ±ä½  (ã¥ï½¡â—•â€¿â€¿â—•ï½¡)ã¥ å…è®¸è‡ªå·±å¡é¡¿ï¼Œæ˜å¤©åˆæ˜¯æ–°çš„ä¸€å¤©ã€‚" },
            { keywords: ['ç´¯', 'å›°', 'ä¹', 'å€¦'], msg: "è¾›è‹¦å•¦ï¼å¤§è„‘é«˜è´Ÿè·è¿è½¬è¿™ä¹ˆä¹…ï¼Œå¿«å»åƒç‚¹å¥½åƒçš„çŠ’åŠ³ä¸€ä¸‹è‡ªå·±ï¼ğŸµ" },
            { keywords: ['å¼€å¿ƒ', 'é¡º', 'æ£’', 'çˆ½', 'å¿«'], msg: "å¤ªæ£’äº†ï¼è¿™ç§å¿ƒæµçŠ¶æ€ç®€ç›´æ˜¯å­¦æœ¯ç•Œçš„é¡¶çº§äº«å—ï¼ğŸ‰" },
            { keywords: ['å¹³', 'ç¨³', 'è¡Œ'], msg: "å¹³ç¨³å°±æ˜¯èƒœåˆ©ï¼Œä¿æŒè¿™ä¸ªèŠ‚å¥ï¼Œç»ˆå°†æ±‡èšæˆæ²³ã€‚ğŸ’§" }
        ];

        const comfortMessages = {
            tired: ["è¾›è‹¦å•¦ï¼ä¼‘æ¯æ˜¯ä¸ºäº†æ›´å¥½çš„é‡å¯ã€‚æ‘¸æ‘¸å¤´ï¼Œå¿«å»å……ç”µå§ï¼ğŸ”‹"],
            sad: ["æŠ±æŠ±ä½ ï¼Œå†™ä¸å‡ºæ¥ä¹Ÿæ²¡å…³ç³»ï¼Œçµæ„Ÿæ­£åœ¨èµ¶æ¥çš„è·¯ä¸Šã€‚"],
            neutral: ["å¹³ç¨³å°±æ˜¯èƒœåˆ©ï¼Œæ¯ä¸€å¤©å¾®å°çš„ç§¯ç´¯ï¼Œç»ˆå°†æ±‡èšæˆæ²³ã€‚"],
            happy: ["å¤ªæ£’äº†ï¼è®°ä½è¿™ç§æˆå°±æ„Ÿï¼Œå®ƒæ˜¯ä½ å‰è¡Œçš„ç‡ƒæ–™ã€‚ğŸ‰"]
        };

        const autoReflections = {
            happy: ["ä»Šå¤©çŠ¶æ€ç¥å‹‡ï¼Œé”®ç›˜éƒ½è¦å†’ç«æ˜Ÿäº†ï¼ğŸ”¥", "æ€è·¯æ¸…æ™°ï¼Œå†™èµ·æ¥é¡ºé£é¡ºæ°´ï¼Œå¼€å¿ƒï¼ğŸ‘"],
            neutral: ["å¹³å¹³æ·¡æ·¡æ‰æ˜¯çœŸï¼ŒæŒ‰éƒ¨å°±ç­å®Œæˆä»»åŠ¡ã€‚", "è¿›åº¦æ¡ç¼“æ…¢ä½†åšå®šåœ°ç§»åŠ¨ä¸­ã€‚"],
            sad: ["ä»Šå¤©æœ‰ç‚¹è‰°éš¾ï¼Œä½†è‡³å°‘æˆ‘åšæŒä¸‹æ¥äº†ã€‚", "å¿ƒæƒ…æœ‰ç‚¹ä½è½ï¼Œæˆ–è®¸æ˜¯è¯¥æ¢ä¸ªæ€è·¯äº†ã€‚"],
            tired: ["è„‘ç»†èƒå·²è€—å°½ï¼Œæ€¥éœ€å……ç”µï¼ğŸ”‹", "å®åœ¨æ˜¯å¤ªå›°äº†ï¼Œå…ˆè‹Ÿä½ï¼Œæ˜å¤©å†æˆ˜ï¼ğŸ’¤"]
        };

        const MOCK_LEADERBOARD = [
            { username: "å­¦æœ¯å·ç‹", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Felix", wordCount: 3200 },
            { username: "æ–‡çŒ®æ€æ‰‹", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Aneka", wordCount: 2100 },
            { username: "æ·±å¤œæˆ˜ç¥", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Milo", wordCount: 1800 },
            { username: "æ—©èµ·é¸Ÿ", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Bella", wordCount: 500 }
        ];
        
        // --- æ ¸å¿ƒé…ç½®ï¼šæ–‡ç« ç±»å‹ã€æ¨èèŠ‚ç‚¹ã€æç¤ºè¯­ ---
        const ARTICLE_CONFIG = {
            'æœŸåˆŠè®ºæ–‡': {
                titlePlaceholder: 'ä¾‹å¦‚ï¼šå…³äº XX çš„å®è¯ç ”ç©¶',
                journalLabel: 'æœŸåˆŠ/ä¼šè®®åç§°',
                journalPlaceholder: 'ä¾‹å¦‚ï¼šJournal of Finance',
                stages: ['åˆç¨¿å‡†å¤‡', 'å·²æŠ•ç¨¿', 'å®¡ç¨¿ä¸­', 'ä¸€å®¡è¿”å›', 'è¿”ä¿®ä¸­', 'äºŒå®¡ä¸­', 'å·²æ¥æ”¶', 'åœ¨çº¿å‘è¡¨', 'çº¸åˆŠè§åˆŠ'],
                milestones: ['å®Œæˆåˆç¨¿', 'æŠ•ç¨¿', 'å®¡ç¨¿ä¸­', 'ä¸€å®¡è¿”å›', 'è¿”ä¿®æäº¤', 'äºŒå®¡è¿”å›', 'å†æ¬¡è¿”ä¿®æäº¤', 'æ¥å—é€šçŸ¥', 'åœ¨çº¿å‘è¡¨', 'çº¸åˆŠè§åˆŠ']
            },
            'ä¼šè®®è®ºæ–‡': {
                titlePlaceholder: 'ä¾‹å¦‚ï¼šæ·±åº¦å­¦ä¹ ä¼˜åŒ–ç®—æ³•ç ”ç©¶',
                journalLabel: 'ä¼šè®®åç§°',
                journalPlaceholder: 'ä¾‹å¦‚ï¼šICML 2025',
                stages: ['åˆç¨¿å‡†å¤‡', 'å·²æŠ•ç¨¿', 'å®¡ç¨¿ä¸­', 'å½•ç”¨é€šçŸ¥', 'ç»ˆç¨¿æäº¤', 'æ³¨å†Œå‚ä¼š', 'æ±‡æŠ¥å®Œæˆ'],
                milestones: ['å®Œæˆåˆç¨¿', 'æŠ•ç¨¿', 'å®¡ç¨¿ä¸­', 'å½•ç”¨é€šçŸ¥', 'ç»ˆç¨¿æäº¤', 'æ³¨å†Œå‚ä¼š', 'ä¼šè®®æŠ¥å‘Šå®Œæˆ']
            },
            'é¡¹ç›®': {
                titlePlaceholder: 'ä¾‹å¦‚ï¼šXX åŸºé‡‘é’å¹´é¡¹ç›®',
                journalLabel: 'ç”³æŠ¥å•ä½/æ¥æº',
                journalPlaceholder: 'ä¾‹å¦‚ï¼šå›½å®¶è‡ªç„¶ç§‘å­¦åŸºé‡‘å§”',
                stages: ['ç«‹é¡¹ç”³æŠ¥ä¸­', 'è¯„å®¡ä¸­', 'å·²ç«‹é¡¹', 'ä¸­æœŸæ£€æŸ¥', 'éªŒæ”¶/ç»“é¢˜ä¸­', 'å·²ç»“é¢˜'],
                milestones: ['ç«‹é¡¹ç”³æŠ¥ææ–™å®Œæˆ', 'æäº¤ç«‹é¡¹ç”³è¯·', 'ç«‹é¡¹è¯„å®¡', 'ç«‹é¡¹è·æ‰¹', 'ç»è´¹åˆ°è´¦', 'ä¸­æœŸæ£€æŸ¥èµ„æ–™æäº¤', 'ä¸­æœŸæ£€æŸ¥é€šè¿‡', 'ç»“é¢˜ææ–™æäº¤', 'ç»“é¢˜é€šè¿‡']
            },
            'è¯¾é¢˜': {
                titlePlaceholder: 'ä¾‹å¦‚ï¼šåšå£«å­¦ä½è®ºæ–‡è¯¾é¢˜',
                journalLabel: 'è¯¾é¢˜æ¥æº',
                journalPlaceholder: 'ä¾‹å¦‚ï¼šå¯¼å¸ˆæ¨ªå‘è¯¾é¢˜',
                stages: ['å¼€é¢˜ç”³è¯·', 'å¼€é¢˜è®ºè¯', 'ä¸­æœŸæ£€æŸ¥', 'é˜¶æ®µæˆæœæ•´ç†', 'ç»“é¢˜ç”³è¯·', 'ç»“é¢˜é€šè¿‡'],
                milestones: ['å¼€é¢˜æŠ¥å‘Šå®Œæˆ', 'å¼€é¢˜è®ºè¯', 'ä¸­æœŸæ£€æŸ¥', 'é˜¶æ®µæˆæœå½¢æˆ', 'ç»“é¢˜ææ–™æäº¤', 'ç»“é¢˜é€šè¿‡']
            },
            'è‘—ä½œ': {
                titlePlaceholder: 'ä¾‹å¦‚ï¼šä¸­å›½ä¼ ç»Ÿå»ºç­‘ç ”ç©¶',
                journalLabel: 'å‡ºç‰ˆç¤¾',
                journalPlaceholder: 'ä¾‹å¦‚ï¼šç§‘å­¦å‡ºç‰ˆç¤¾',
                stages: ['é€‰é¢˜ç¡®å®š', 'å†™ä½œæ ·ç« ', 'å‡ºç‰ˆç¤¾ç«‹é¡¹', 'åˆåŒç­¾è®¢', 'å…¨ç¨¿å®Œæˆ', 'ä¸‰å®¡é€šè¿‡', 'æ’ç‰ˆæ ¡å¯¹', 'å‡ºç‰ˆå‘è¡Œ'],
                milestones: ['é€‰é¢˜ç¡®å®š', 'æ ·ç« å®Œæˆ', 'å‡ºç‰ˆç¤¾ç«‹é¡¹', 'åˆåŒç­¾è®¢', 'å…¨ç¨¿äº¤ä»˜', 'ä¸‰å®¡é€šè¿‡', 'æ’ç‰ˆæ ¡å¯¹', 'å‡ºç‰ˆå‘è¡Œ']
            },
            'å…¶ä»–': {
                titlePlaceholder: 'ä¾‹å¦‚ï¼šå­¦æœ¯è®²åº§/çŸ­æœŸè®¿å­¦',
                journalLabel: 'ç›¸å…³æœºæ„',
                journalPlaceholder: 'å¤‡æ³¨è¯´æ˜',
                stages: ['è®¡åˆ’ä¸­', 'è¿›è¡Œä¸­', 'æš‚ç¼“', 'å·²å®Œæˆ'],
                milestones: ['åˆ¶å®šè®¡åˆ’', 'æ‰§è¡Œä¸­', 'é˜¶æ®µåé¦ˆ', 'è°ƒæ•´æ–¹æ¡ˆ', 'å®Œæˆ']
            }
        };

        const ARTICLE_TYPES = Object.keys(ARTICLE_CONFIG);

        // --- çŠ¶æ€ç®¡ç† ---
        const state = {
            view: 'loading',
            activeTab: 'dashboard', 
            user: null, 
            entries: [],
            dailyPlans: [], 
            customGoals: [],
            articles: [], 
            totalWordGoal: 100000,
            graduationDate: '',
            // æ–°å¢å…¨å±€ç›®æ ‡é…ç½®
            globalGoalType: 'æ¯•ä¸š',
            globalGoalName: 'æ¯•ä¸šè®ºæ–‡',
            
            currentSession: null, 
            leaderboard: [],
            loadingLeaderboard: false,
            loginMode: 'login',
            showSidebar: false,
            showFeedback: false,
            feedbackData: {},
            showGoalModal: false,
            editingGoalId: null,
            showPlanModal: false, 
            editingPlanId: null,
            showLogoutModal: false,
            showProfileModal: false,
            showGradSettings: false,
            showArticleModal: false, 
            articleStatusTouched: false, 
            viewDate: new Date().toISOString().split('T')[0],
            dailyQuote: psychQuotes[0],
            formData: { 
                date: '', 
                startCount: 0, 
                endCount: 0, 
                mood: 'neutral', 
                reflection: '', 
                linkedGoalId: '', 
                chapter: '', 
                duration: '', 
                durationNum: 0 
            },
            entryDrafts: {}, 
            newGoalData: { name: '', targetQty: 1, unit: 'ç¯‡', targetWords: 10000 },
            planFormData: { target: 1000, content: '', linkedGoalId: 'thesis' },
            tempProfile: { name: '', avatar: '' },
            // æ–‡ç« è¡¨å•æ•°æ®
            articleFormData: {
                id: null,
                title: '',
                journal: '',
                type: 'æœŸåˆŠè®ºæ–‡',
                status: '',
                milestones: [], 
                reviewNotes: '',
                notes: ''
            },
            // æ—¥å†ç»„ä»¶çŠ¶æ€
            calendar: {
                visible: false,
                targetIndex: null, // æ­£åœ¨ç¼–è¾‘çš„ milestones ç´¢å¼•
                currentYear: new Date().getFullYear(),
                currentMonth: new Date().getMonth()
            }
        };

        // --- å®‰å…¨çš„æœ¬åœ°å­˜å‚¨å°è£… ---
        const Storage = {
            get: (key, defaultVal = null) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultVal;
                } catch (e) {
                    return defaultVal;
                }
            },
            set: (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (e) {}
            },
            remove: (key) => {
                try {
                    localStorage.removeItem(key);
                } catch(e) {}
            }
        };

        function parseSafeDate(dateStr) {
            if (!dateStr || typeof dateStr !== 'string') return null;
            const match = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (!match) return null;
            const year = parseInt(match[1], 10);
            const month = parseInt(match[2], 10) - 1;
            const day = parseInt(match[3], 10);
            const date = new Date(year, month, day);
            if (date.getFullYear() !== year || date.getMonth() !== month || date.getDate() !== day) return null;
            return date;
        }

        // --- ç”¨æˆ·ç³»ç»Ÿ ---
        function getUsersDirectory() { return Storage.get('phd_users_directory', {}); }
        function saveUsersDirectory(dir) { Storage.set('phd_users_directory', dir); }

        function loadLocalUser(username) {
            try {
                const dir = getUsersDirectory();
                if (!dir[username]) {
                    dir[username] = { password: 'any', avatar: `https://api.dicebear.com/7.x/notionists/svg?seed=${Date.now()}` };
                    saveUsersDirectory(dir);
                    Storage.set(`phd_data_${username}`, { entries: [], customGoals: [{ id: 'g1', name: 'æ¯•ä¸šè®ºæ–‡', currentQty: 0, targetQty: 1, unit: 'ç¯‡', accumulatedWords: 0, targetWords: 100000 }] });
                }

                state.user = { username: username, avatar: dir[username].avatar };
                const data = Storage.get(`phd_data_${username}`, {});
                
                state.entries = Array.isArray(data.entries) ? data.entries : [];
                state.customGoals = Array.isArray(data.customGoals) ? data.customGoals : [{ id: 'g1', name: 'æ¯•ä¸šè®ºæ–‡', currentQty: 0, targetQty: 1, unit: 'ç¯‡', accumulatedWords: 0, targetWords: 100000 }];
                state.dailyPlans = Array.isArray(data.dailyPlans) ? data.dailyPlans : [];
                
                // åŠ è½½å…¨å±€ç›®æ ‡é…ç½®
                state.globalGoalType = data.globalGoalType || 'æ¯•ä¸š';
                state.globalGoalName = data.globalGoalName || 'æ¯•ä¸šè®ºæ–‡';
                
                // æ•°æ®å…¼å®¹å¤„ç†
                let loadedArticles = Array.isArray(data.articles) ? data.articles : [];
                state.articles = loadedArticles.map(a => {
                    if (!a.milestones && a.submissionDate) {
                        const ms = [{ label: 'æŠ•ç¨¿', date: a.submissionDate, note: '' }];
                        if (a.reviewDate) ms.push({ label: 'ä¸€å®¡è¿”å›', date: a.reviewDate, note: '' });
                        if (a.revisionDate) ms.push({ label: 'è¿”ä¿®æäº¤', date: a.revisionDate, note: '' });
                        if (a.acceptDate) ms.push({ label: 'æ­£å¼å½•ç”¨', date: a.acceptDate, note: '' });
                        if (a.customMilestones) {
                            a.customMilestones.forEach(c => ms.push({ label: c.label, date: c.date, note: c.note }));
                        }
                        a.milestones = ms;
                    }
                    return a;
                });

                state.totalWordGoal = data.totalWordGoal || 100000;
                
                let safeGradDate = '';
                if (data.graduationDate) {
                    const parsed = parseSafeDate(data.graduationDate);
                    if (parsed) safeGradDate = data.graduationDate;
                }
                state.graduationDate = safeGradDate;
                state.currentSession = Storage.get(`phd_session_${username}`, null);
                
                Storage.set('phd_current_user', username);
                state.view = 'app';
                state.dailyQuote = psychQuotes[Math.floor(Math.random() * psychQuotes.length)];
                
                render();
            } catch(e) {
                console.error("User load failed:", e);
                state.view = 'login';
                render();
            }
        }

        function saveUserData() {
            if (!state.user) return;
            setTimeout(() => {
                const data = { 
                    entries: state.entries, 
                    customGoals: state.customGoals, 
                    dailyPlans: state.dailyPlans, 
                    totalWordGoal: state.totalWordGoal, 
                    graduationDate: state.graduationDate, 
                    articles: state.articles,
                    globalGoalType: state.globalGoalType,
                    globalGoalName: state.globalGoalName
                };
                Storage.set(`phd_data_${state.user.username}`, data);
                if (state.currentSession) Storage.set(`phd_session_${state.user.username}`, state.currentSession);
                else Storage.remove(`phd_session_${state.user.username}`);
            }, 0);
        }

        // --- ä¸šåŠ¡è¾…åŠ©å‡½æ•° ---
        const getTodayStr = () => new Date().toISOString().split('T')[0];
        
        // è·å–å…è®¸é€‰æ‹©çš„æœ€å¤§æ—¥æœŸï¼ˆæ¯•ä¸šæ—¥æœŸ æˆ– ä»Šå¤©+1å¹´ï¼‰
        const getMaxDate = () => {
            const today = new Date();
            const oneYearLater = new Date(today);
            oneYearLater.setFullYear(today.getFullYear() + 1);
            
            if (state.graduationDate) {
                const grad = parseSafeDate(state.graduationDate);
                // å¦‚æœæ¯•ä¸šæ—¥æœŸæ¯”ä¸€å¹´åè¿˜æ™šï¼Œå°±ç”¨æ¯•ä¸šæ—¥æœŸï¼Œå¦åˆ™ç”¨ä¸€å¹´åï¼ˆè‡³å°‘å…è®¸ä¸€å¹´ï¼‰
                if (grad && grad > oneYearLater) {
                    return grad;
                }
            }
            return oneYearLater;
        };
        
        const calcStats = (targetDate) => {
            const total = state.entries.reduce((acc, e) => acc + e.dailyCount, 0); 
            const today = state.entries.reduce((acc, e) => e.date === targetDate ? acc + e.dailyCount : acc, 0);
            const uniqueDays = new Set(state.entries.map(e => e.date)).size;
            const avg = uniqueDays > 0 ? Math.round(total / uniqueDays) : 0;
            return { total, today, avg };
        };

        // è®¡ç®—æ—¥å‡äº§å‡º (ä»ç¬¬ä¸€æ¬¡ä½¿ç”¨åˆ°ä»Šå¤©)
        const getDailyAverage = () => {
            if (!state.entries || state.entries.length === 0) return 0;
            
            const total = state.entries.reduce((acc, e) => acc + e.dailyCount, 0);
            
            // æ‰¾åˆ°æœ€æ—©çš„æ‰“å¡è®°å½•æ—¥æœŸ
            const entryDates = state.entries.map(e => parseSafeDate(e.date)).filter(d => d);
            if (entryDates.length === 0) return 0;
            
            // æŒ‰æ—¶é—´æ’åºæ‰¾æœ€æ—©çš„
            entryDates.sort((a, b) => a - b);
            const firstDate = entryDates[0];
            
            // è®¡ç®—ä»Šå¤©å’Œæœ€æ—©æ—¥æœŸçš„å¤©æ•°å·®
            const now = new Date();
            // å½’ä¸€åŒ–åˆ°åˆå¤œï¼Œé¿å…æ—¶åˆ†ç§’å½±å“
            firstDate.setHours(0,0,0,0);
            now.setHours(0,0,0,0);
            
            // æ¯«ç§’è½¬å¤©æ•°
            let diffDays = Math.floor((now - firstDate) / (1000 * 60 * 60 * 24)) + 1;
            
            // è‡³å°‘ä¸º1å¤©
            diffDays = Math.max(1, diffDays);
            
            return Math.round(total / diffDays);
        };
        
        const getDaysLeft = () => {
            const gradDate = parseSafeDate(state.graduationDate);
            if (!gradDate) return null;
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            const diffTime = gradDate - now;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        };
        
        const getPlanProgress = (planId, targetDate) => {
            return state.entries
                .filter(e => e.date === targetDate && e.linkedPlanId === planId)
                .reduce((acc, e) => acc + e.dailyCount, 0);
        };

        const getLastCountForGoal = (goalId) => {
            if (!goalId) return 0;
            const relevantEntries = state.entries.filter(e => e.linkedGoalId === goalId);
            if (relevantEntries.length === 0) return 0;
            return Math.max(...relevantEntries.map(e => e.endCount));
        };
        
        const getSmartResponse = (reflection, mood) => {
            const text = (reflection || "").toLowerCase();
            for (const rule of encouragementRules) {
                if (rule.keywords.some(k => text.includes(k))) return rule.msg;
            }
            const fallbackMsgs = comfortMessages[mood] || comfortMessages.neutral;
            return fallbackMsgs[Math.floor(Math.random() * fallbackMsgs.length)];
        };

        const cleanOldPlans = () => {
            // ç§»é™¤æ—§çš„æ¸…ç†é€»è¾‘ï¼Œå› ä¸ºç°åœ¨å…è®¸ä¿ç•™å†å²è®¡åˆ’
            // const today = getTodayStr();
            // if (state.dailyPlans && state.dailyPlans.length > 0 && state.dailyPlans[0].date !== today) {
            //     state.dailyPlans = [];
            //     saveUserData();
            // }
        };

        const getGoalTagStyle = (name) => {
            if (!name) return { emoji: 'ğŸŒ±', cls: 'tag-green' };
            const n = name.toLowerCase();
            if (n.includes('è®ºæ–‡') || n.includes('å†™') || n.includes('ç¨¿')) return { emoji: 'ğŸ“', cls: 'tag-purple' };
            if (n.includes('é˜…è¯»') || n.includes('æ–‡çŒ®') || n.includes('ä¹¦')) return { emoji: 'ğŸ“–', cls: 'tag-blue' };
            if (n.includes('æ•°æ®') || n.includes('å®éªŒ') || n.includes('åˆ†æ')) return { emoji: 'ğŸ’¡', cls: 'tag-cyan' };
            if (n.includes('æ€è€ƒ') || n.includes('æƒ³') || n.includes('è®¡åˆ’')) return { emoji: 'ğŸŒ±', cls: 'tag-green' };
            return { emoji: 'ğŸ“Œ', cls: 'tag-orange' }; 
        };

        const getArticleTypeClass = (type) => {
            switch(type) {
                case 'æœŸåˆŠè®ºæ–‡': return 'badge-journal';
                case 'ä¼šè®®è®ºæ–‡': return 'badge-conf';
                case 'é¡¹ç›®': return 'badge-project';
                case 'è¯¾é¢˜': return 'badge-project';
                case 'è‘—ä½œ': return 'badge-book';
                case 'å…¶ä»–': return 'badge-other';
                default: return 'badge-journal';
            }
        };

        // --- æ’åºèŠ‚ç‚¹çš„é€»è¾‘ ---
        function sortMilestones(milestones) {
            return milestones.sort((a,b) => {
                if(!a.date && !b.date) return 0;
                if(!a.date) return 1; // æ— æ—¥æœŸçš„æ’åé¢
                if(!b.date) return -1;
                return new Date(a.date) - new Date(b.date);
            });
        }

        // --- æ™ºèƒ½çŠ¶æ€æ›´æ–°é€»è¾‘ ---
        function updateStatusFromMilestones() {
            if (state.articleStatusTouched) return; 

            const milestones = state.articleFormData.milestones || [];
            const withDate = milestones.filter(m => m.date);
            
            if (withDate.length === 0) return;

            withDate.sort((a, b) => new Date(a.date) - new Date(b.date));
            const latest = withDate[withDate.length - 1];
            const suggested = (latest.label || '').trim();
            
            if (!suggested) return;

            state.articleFormData.status = suggested;
            const inputEl = document.getElementById('article-status-input');
            if (inputEl) inputEl.value = suggested;
        }

        // --- å±€éƒ¨æ¸²æŸ“ DOM è¾…åŠ©å‡½æ•° ---
        function renderMilestonesList() {
            const container = document.getElementById('milestone-list-container');
            if(!container) return; 

            const ms = state.articleFormData.milestones;
            
            // æ³¨æ„ï¼šè¿™é‡ŒæŠŠ <input type="date"> æ¢æˆäº†è‡ªå®šä¹‰ divï¼Œç‚¹å‡»è§¦å‘ actions.openCalendar(idx)
            const html = ms.map((m, idx) => `
                <div class="border border-slate-200 rounded-xl p-3 bg-white mb-2 transition-all hover:shadow-sm group">
                    <div class="flex items-center gap-2">
                        <button type="button" onclick="actions.toggleMilestoneNote(${idx})" class="text-slate-400 hover:text-indigo-500 w-6 h-6 flex items-center justify-center transition-transform ${m.expanded ? 'rotate-180 text-indigo-500' : ''}">
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </button>
                        
                        <input type="text" placeholder="èŠ‚ç‚¹åç§°" value="${m.label}" oninput="actions.updateMilestoneText(${idx}, 'label', this.value)" class="flex-1 text-sm font-bold text-slate-700 outline-none bg-transparent placeholder-slate-300">
                        
                        <!-- è‡ªå®šä¹‰æ—¥æœŸé€‰æ‹©å™¨è§¦å‘åŒº -->
                        <div onclick="actions.openCalendar(${idx})" class="cursor-pointer text-xs font-mono bg-slate-50 border border-slate-200 rounded px-2 py-1.5 w-28 text-center hover:border-indigo-500 hover:text-indigo-600 transition-colors ${m.date ? 'text-slate-700 font-bold' : 'text-slate-400'}">
                            ${m.date || 'é€‰æ‹©æ—¥æœŸ'}
                        </div>
                        
                        <button type="button" onclick="actions.removeMilestone(${idx})" class="text-slate-200 hover:text-red-400 p-1 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    
                    <div id="ms-note-${idx}" class="${m.expanded ? '' : 'hidden'} mt-3 pt-2 border-t border-slate-100 animate-fade-in">
                        <textarea placeholder="æ·»åŠ å¤‡æ³¨ (å¦‚ï¼šå®¡ç¨¿äººæ„è§è¦ç‚¹ã€æ²Ÿé€šè®°å½•...)" oninput="actions.updateMilestoneText(${idx}, 'note', this.value)" class="w-full text-xs text-slate-600 bg-slate-50 rounded-lg p-2 outline-none border border-transparent focus:border-indigo-100 resize-none h-16 block">${m.note}</textarea>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
            if (window.lucide) lucide.createIcons();
        }

        // --- ç‹¬ç«‹çš„æ—¥å†ç»„ä»¶æ¸²æŸ“å‡½æ•° ---
        // æ¸²æŸ“åˆ° #calendar-mount è€Œä¸æ˜¯ #appï¼Œé¿å…ä¸»è§†å›¾åˆ·æ–°
        function renderCalendarComponent() {
            const mount = document.getElementById('calendar-mount');
            if (!mount) return;

            if (!state.calendar.visible) {
                mount.innerHTML = '';
                return;
            }

            const { currentYear, currentMonth } = state.calendar;
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const firstDay = new Date(currentYear, currentMonth, 1).getDay(); // 0 is Sunday
            
            const monthNames = ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"];

            let daysHtml = '';
            // Empty slots for previous month
            for (let i = 0; i < firstDay; i++) {
                daysHtml += `<div class="calendar-day empty"></div>`;
            }
            // Days
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = (today.getFullYear() === currentYear && today.getMonth() === currentMonth && today.getDate() === day);
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                // æ£€æŸ¥å½“å‰èŠ‚ç‚¹æ˜¯å¦å·²é€‰ä¸­è¯¥æ—¥æœŸ
                const targetIdx = state.calendar.targetIndex;
                const currentSelected = (targetIdx !== null && state.articleFormData.milestones[targetIdx]) ? state.articleFormData.milestones[targetIdx].date : '';
                const isSelected = currentSelected === dateStr;

                daysHtml += `<div onclick="actions.selectCalendarDate(${day})" class="calendar-day ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''}">${day}</div>`;
            }

            mount.innerHTML = `
                <div class="fixed inset-0 bg-black/20 z-[100] flex items-center justify-center p-4 animate-fade-in" onclick="actions.closeCalendar()">
                    <div class="bg-white rounded-2xl p-5 w-full max-w-[300px] shadow-2xl animate-scale-in" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <button onclick="actions.calendarPrevMonth()" class="p-1 hover:bg-slate-100 rounded text-slate-400 hover:text-indigo-600"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                            <span class="font-bold text-slate-800">${currentYear}å¹´ ${monthNames[currentMonth]}</span>
                            <button onclick="actions.calendarNextMonth()" class="p-1 hover:bg-slate-100 rounded text-slate-400 hover:text-indigo-600"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                        </div>
                        <div class="calendar-grid mb-2">
                            <span class="text-xs text-center text-slate-300 font-bold">æ—¥</span>
                            <span class="text-xs text-center text-slate-300 font-bold">ä¸€</span>
                            <span class="text-xs text-center text-slate-300 font-bold">äºŒ</span>
                            <span class="text-xs text-center text-slate-300 font-bold">ä¸‰</span>
                            <span class="text-xs text-center text-slate-300 font-bold">å››</span>
                            <span class="text-xs text-center text-slate-300 font-bold">äº”</span>
                            <span class="text-xs text-center text-slate-300 font-bold">å…­</span>
                        </div>
                        <div class="calendar-grid">
                            ${daysHtml}
                        </div>
                        <div class="mt-4 flex justify-center">
                            <button onclick="actions.closeCalendar()" class="text-xs text-slate-400 hover:text-slate-600">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            `;
            if (window.lucide) lucide.createIcons();
        }

        function updateArticleTypeUI(type) {
            const config = ARTICLE_CONFIG[type] || ARTICLE_CONFIG['æœŸåˆŠè®ºæ–‡'];
            
            const titleInput = document.getElementById('article-title-input');
            const journalInput = document.getElementById('article-journal-input');
            const journalLabel = document.getElementById('article-journal-label');
            const datalist = document.getElementById('stage-options');

            if(titleInput) titleInput.placeholder = config.titlePlaceholder;
            if(journalInput) journalInput.placeholder = config.journalPlaceholder;
            if(journalLabel) journalLabel.innerText = config.journalLabel + " *";
            
            if(datalist) {
                datalist.innerHTML = config.stages.map(s => `<option value="${s}">${s}</option>`).join('');
            }
        }

        // --- äº¤äº’ Action ---
        window.actions = {
            // ... Auth & System ...
            auth: (e) => { e.preventDefault(); const u = e.target.username.value.trim() || "åŒ¿ååšå£«"; loadLocalUser(u); },
            askLogout: () => { state.showSidebar = false; state.showLogoutModal = true; render(); },
            confirmLogout: () => { Storage.remove('phd_current_user'); state.user = null; state.showLogoutModal = false; state.view = 'login'; render(); },
            cancelLogout: () => { state.showLogoutModal = false; render(); },
            
            setTab: (t) => { 
                state.activeTab = t; 
                if(t==='add' && !state.currentSession) { 
                    const defaultGoalId = state.customGoals.length > 0 ? state.customGoals[0].id : 'thesis';
                    const lastCount = getLastCountForGoal(defaultGoalId);
                    state.formData = { date: getTodayStr(), linkedGoalId: defaultGoalId, startCount: lastCount, endCount: lastCount, chapter: '', mood: 'neutral', reflection: '', duration: '', durationNum: 0 };
                } 
                if(t==='rank') { state.loadingLeaderboard = true; render(); setTimeout(() => { state.loadingLeaderboard = false; render(); }, 500); } 
                else { render(); }
            },
            toggleSidebar: () => { state.showSidebar = !state.showSidebar; render(); },
            
            // ... Date & Plans ...
            setViewDate: (d) => { state.viewDate = d; render(); },
            
            // ä¿®æ”¹ï¼šå…è®¸å‘æœªæ¥ç¿»é¡µ (éœ€æ±‚2ï¼šç§»é™¤é™åˆ¶)
            changeDate: (days) => { 
                const current = parseSafeDate(state.viewDate) || new Date(); 
                current.setDate(current.getDate() + days); 
                const newDateStr = current.toISOString().split('T')[0];
                
                state.viewDate = newDateStr; 
                render(); 
            },
            
            // ä¿®æ”¹ï¼šå›åˆ°ä»Šå¤©ï¼Œä¸å¸¦æ¡ä»¶é™åˆ¶
            goToToday: () => { 
                state.viewDate = getTodayStr(); 
                render(); 
            },
            
            openAddPlan: () => { state.editingPlanId = null; const defaultGoal = state.customGoals.length > 0 ? state.customGoals[0].id : ''; state.planFormData = { target: 1000, content: '', linkedGoalId: defaultGoal }; state.showPlanModal = true; render(); },
            openEditPlan: (id) => { const plan = state.dailyPlans.find(p => p.id === id); if(plan) { state.editingPlanId = id; state.planFormData = { ...plan }; state.showPlanModal = true; render(); } },
            closePlanModal: () => { state.showPlanModal = false; render(); },
            setPlanForm: (f, v) => state.planFormData[f] = v,
            savePlan: (e) => {
                e.preventDefault();
                const newPlan = { ...state.planFormData, id: state.editingPlanId || Date.now().toString(), date: state.viewDate };
                if (state.editingPlanId) state.dailyPlans = state.dailyPlans.map(p => p.id === state.editingPlanId ? newPlan : p);
                else state.dailyPlans.push(newPlan);
                state.showPlanModal = false; saveUserData(); render();
            },
            deletePlan: (id) => { if(confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªç›®æ ‡å—ï¼Ÿ")) { state.dailyPlans = state.dailyPlans.filter(p => p.id !== id); saveUserData(); render(); } },

            // ... Work Session ...
            start: (planId) => { 
                const plan = state.dailyPlans.find(p => p.id === planId);
                const linkedGoalId = plan ? plan.linkedGoalId : '';
                const lastMax = getLastCountForGoal(linkedGoalId);
                state.currentSession = { start: Date.now(), startCount: lastMax, isActive: true, planId: planId, linkedGoalId: linkedGoalId }; 
                saveUserData(); 
                render(); 
            },
            adjustStart: () => { const newStart = prompt("ä¿®æ­£å¼€å§‹å­—æ•°:", state.currentSession.startCount); if (newStart !== null && !isNaN(newStart)) { state.currentSession.startCount = parseInt(newStart); saveUserData(); render(); } },
            adjustManualStart: (d) => {
                const oldStart = parseInt(state.formData.startCount) || 0;
                const newStart = Math.max(0, oldStart + d);
                actions.setFormData('startCount', newStart);
                const el = document.querySelector('input[name="startCount"]');
                if(el) el.value = newStart;
                actions.setFormData('endCount', state.formData.endCount);
            },
            autoGenReflection: () => {
                const mood = state.formData.mood;
                const opts = autoReflections[mood] || autoReflections.neutral;
                const text = opts[Math.floor(Math.random() * opts.length)];
                state.formData.reflection = text;
                const el = document.querySelector('textarea[name="reflection"]');
                if(el) el.value = text;
            },
            setFormData: (f, v) => { 
                state.formData[f] = v;
                if (f === 'endCount') {
                    const isFocus = !!state.currentSession;
                    const start = isFocus ? state.currentSession.startCount : parseInt(state.formData.startCount);
                    const diff = (parseInt(v)||0) - (parseInt(start)||0);
                    const el = document.getElementById('net-word-display');
                    if(el) { el.innerText = diff > 0 ? `+${diff}` : diff; el.style.color = diff > 0 ? '#10B981' : (diff < 0 ? '#EF4444' : '#94A3B8'); }
                }
                if (f === 'linkedGoalId') {
                    const lastCount = getLastCountForGoal(v);
                    state.formData.startCount = lastCount;
                    state.formData.endCount = lastCount;
                }
            },
            updateDuration: (val) => {
                state.formData.durationNum = val;
                const display = val > 0 ? `${val} å°æ—¶` : '';
                state.formData.duration = display;
                const el = document.getElementById('duration-display');
                if(el) el.innerText = val > 0 ? display : '0 å°æ—¶';
            },

            end: (e) => {
                e.preventDefault();
                const isFocus = !!state.currentSession;
                const start = isFocus ? state.currentSession.startCount : parseInt(state.formData.startCount);
                const end = parseInt(e.target.endCount.value);
                if (end < start && !confirm("ç»“æŸå­—æ•°å°‘äºå¼€å§‹å­—æ•°ï¼Ÿ(è®°å½•ä¸ºè´Ÿäº§å‡º)")) return;
                const diff = end - start;
                
                let planId = null, linkedGoalId = isFocus ? state.currentSession.linkedGoalId : state.formData.linkedGoalId;
                if (!linkedGoalId && state.customGoals.length > 0) { linkedGoalId = state.customGoals[0].id; }
                
                let goalName = "æœªåˆ†ç±»ç›®æ ‡", planContent = state.formData.chapter || "æ‰“å¡è®°å½•";
                let mood = state.formData.mood, reflection = state.formData.reflection;
                
                if(!reflection) {
                    const opts = autoReflections[mood] || autoReflections.neutral;
                    reflection = opts[Math.floor(Math.random() * opts.length)];
                }
                let encourageMsg = getSmartResponse(reflection, mood);
                if(diff > 2000) encourageMsg = "å¤©å“ªï¼2000+å­—ï¼ä½ å°±æ˜¯ä¼ è¯´ä¸­çš„å­¦æœ¯è¶…äººï¼è¯·æ”¶ä¸‹æˆ‘çš„è†ç›–ï¼ğŸ™‡â€â™‚ï¸";

                if (isFocus) {
                    planId = state.currentSession.planId;
                    const plan = state.dailyPlans.find(p => p.id === planId);
                    if (plan) planContent = plan.content;
                } 

                if(linkedGoalId) {
                    const g = state.customGoals.find(x=>x.id===linkedGoalId);
                    if(g) { 
                        g.accumulatedWords = (g.accumulatedWords || 0) + diff; 
                        goalName = g.name;
                        if(g.unit === 'å­—') g.current = (g.current || 0) + diff;
                    }
                }
                
                const recordDate = state.formData.date || getTodayStr();
                let finalDuration = state.formData.duration;
                if(isFocus) finalDuration = Math.round((Date.now() - state.currentSession.start)/60000) + "m";

                state.entries.push({ 
                    id: Date.now(), date: recordDate, startCount: start, endCount: end, dailyCount: diff, 
                    duration: finalDuration, 
                    mood, reflection, linkedPlanContent: planContent, linkedGoalName: goalName, linkedPlanId: planId, linkedGoalId: linkedGoalId
                });
                state.entries.sort((a,b)=> new Date(b.date)-new Date(a.date));
                
                state.currentSession = null;
                state.formData = { date: getTodayStr(), startCount: 0, endCount: 0, mood: 'neutral', reflection: '', chapter: '', linkedGoalId: '', duration: '', durationNum: 0 }; 
                state.feedbackData = { diff, linkedGoalName: goalName, encourageMsg }; 
                state.showFeedback = true;
                
                render(); 
                saveUserData(); 
            },
            cancelSession: () => { if(confirm("æ”¾å¼ƒæœ¬æ¬¡ä¸“æ³¨ï¼Ÿ")) { state.currentSession = null; saveUserData(); render(); } },
            setMood: (m) => { state.formData.mood = m; render(); },
            closeFeedback: () => { state.showFeedback = false; state.activeTab = 'history'; render(); },
            
            // ... Goals ...
            openAddGoal: () => { state.editingGoalId = null; state.newGoalData = { name: '', targetQty: 1, unit: 'ç¯‡', targetWords: 50000 }; state.showGoalModal = true; render(); },
            openEditGoal: (id) => { const g = state.customGoals.find(x => x.id === id); if (g) { state.editingGoalId = id; state.newGoalData = { ...g }; state.showGoalModal = true; render(); } },
            setNewGoal: (f, v) => state.newGoalData[f] = v,
            saveGoal: () => {
                if(!state.newGoalData.name) return;
                const goalData = { name: state.newGoalData.name, targetQty: parseInt(state.newGoalData.targetQty) || 1, unit: state.newGoalData.unit || 'ä¸ª', targetWords: parseInt(state.newGoalData.targetWords) || 0 };
                if (state.editingGoalId) state.customGoals = state.customGoals.map(g => g.id === state.editingGoalId ? { ...g, ...goalData } : g);
                else state.customGoals.push({ ...goalData, id: Date.now().toString(), currentQty: 0, accumulatedWords: 0 });
                state.showGoalModal = false; saveUserData(); render();
            },
            delGoal: (id) => { if(confirm("åˆ é™¤æ­¤ç›®æ ‡ï¼Ÿ")) { state.customGoals = state.customGoals.filter(x=>x.id!==id); saveUserData(); render(); } },
            addQty: (id) => { const g = state.customGoals.find(x=>x.id===id); if(g) { g.currentQty++; saveUserData(); render(); } },
            
            toggleGrad: () => { state.showGradSettings = !state.showGradSettings; render(); },
            saveGradSettings: () => {
                const dateInput = document.getElementById('grad-date-input');
                const typeInput = document.getElementById('global-type-input');
                const nameInput = document.getElementById('global-name-input');

                if(dateInput) {
                    const val = dateInput.value;
                    if (parseSafeDate(val)) state.graduationDate = val;
                    else if (val === '') state.graduationDate = '';
                }

                if (typeInput) state.globalGoalType = typeInput.value || 'æ¯•ä¸š';
                if (nameInput) {
                    state.globalGoalName = nameInput.value || 'æ¯•ä¸šè®ºæ–‡';
                    // è”åŠ¨æ›´æ–°ç¬¬ä¸€ä¸ªç›®æ ‡å¡ç‰‡çš„åç§°ï¼Œä¿æŒä¸€è‡´
                    if (state.customGoals.length > 0) {
                        state.customGoals[0].name = state.globalGoalName;
                    }
                }

                state.showGradSettings = false;
                saveUserData();
                render();
            },
            
            toggleGoalModal: () => { state.showGoalModal = !state.showGoalModal; render(); },
            setTotalGoal: () => { const v = prompt("ç›®æ ‡å­—æ•°:", state.totalWordGoal); if(v) { state.totalWordGoal = Number(v); saveUserData(); render(); } },
            
            editProfile: () => { state.tempProfile = {...state.user}; state.showProfileModal = true; state.showSidebar = false; render(); },
            closeProfile: () => { state.showProfileModal = false; render(); },
            setTempProfile: (f,v) => state.tempProfile[f]=v,
            randAvatar: () => { state.tempProfile.avatar = `https://api.dicebear.com/7.x/notionists/svg?seed=${Date.now()}`; render(); },
            saveProfile: (e) => { e.preventDefault(); state.user = {...state.user, ...state.tempProfile}; state.showProfileModal = false; saveUserData(); render(); },

            // --- Custom Calendar Actions (Independent of Main Render) ---
            openCalendar: (index) => {
                state.calendar.visible = true;
                state.calendar.targetIndex = index;
                const currentVal = state.articleFormData.milestones[index].date;
                if (currentVal) {
                    const d = parseSafeDate(currentVal);
                    if (d) {
                        state.calendar.currentYear = d.getFullYear();
                        state.calendar.currentMonth = d.getMonth();
                    }
                } else {
                    const now = new Date();
                    state.calendar.currentYear = now.getFullYear();
                    state.calendar.currentMonth = now.getMonth();
                }
                renderCalendarComponent();
            },
            closeCalendar: () => {
                state.calendar.visible = false;
                state.calendar.targetIndex = null;
                renderCalendarComponent();
            },
            calendarPrevMonth: () => {
                let { currentMonth, currentYear } = state.calendar;
                if (currentMonth === 0) { currentMonth = 11; currentYear--; } 
                else { currentMonth--; }
                state.calendar.currentMonth = currentMonth;
                state.calendar.currentYear = currentYear;
                renderCalendarComponent();
            },
            calendarNextMonth: () => {
                let { currentMonth, currentYear } = state.calendar;
                if (currentMonth === 11) { currentMonth = 0; currentYear++; } 
                else { currentMonth++; }
                state.calendar.currentMonth = currentMonth;
                state.calendar.currentYear = currentYear;
                renderCalendarComponent();
            },
            selectCalendarDate: (day) => {
                const { currentYear, currentMonth, targetIndex } = state.calendar;
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                if (targetIndex !== null) {
                    // Update Data
                    state.articleFormData.milestones[targetIndex].date = dateStr;
                    state.articleFormData.milestones = sortMilestones(state.articleFormData.milestones);
                    
                    // Partial Update DOM
                    renderMilestonesList();
                    updateStatusFromMilestones();
                }
                
                actions.closeCalendar();
            },

            // --- Article Actions ---
            openAddArticle: () => {
                state.articleStatusTouched = false; 
                const defaultType = 'æœŸåˆŠè®ºæ–‡';
                const defaultMilestones = ARTICLE_CONFIG[defaultType].milestones.map(label => ({ label, date: '', note: '' }));
                
                state.articleFormData = {
                    id: null,
                    title: '',
                    journal: '',
                    type: defaultType,
                    status: '',
                    milestones: defaultMilestones, 
                    reviewNotes: '',
                    notes: ''
                };
                state.showArticleModal = true;
                render();
                setTimeout(() => {
                    updateArticleTypeUI(defaultType);
                    renderMilestonesList();
                    updateStatusFromMilestones();
                }, 0);
            },
            openEditArticle: (id) => {
                const article = state.articles.find(a => a.id === id);
                if (article) {
                    state.articleFormData = JSON.parse(JSON.stringify(article));
                    
                    if (article.status && article.status.trim() !== '') {
                        state.articleStatusTouched = true;
                    } else {
                        state.articleStatusTouched = false;
                        setTimeout(() => updateStatusFromMilestones(), 0);
                    }

                    state.showArticleModal = true;
                    render();
                    setTimeout(() => {
                        updateArticleTypeUI(state.articleFormData.type);
                        renderMilestonesList();
                    }, 0);
                }
            },
            toggleArticleModal: () => { state.showArticleModal = !state.showArticleModal; render(); },
            toggleArticleDetails: (id) => {
                const el = document.getElementById(`article-details-${id}`);
                const btn = document.getElementById(`article-toggle-btn-${id}`);
                if(el) el.classList.toggle('hidden');
                if(btn) btn.classList.toggle('rotate-180');
            },
            setArticleForm: (f, v) => { 
                state.articleFormData[f] = v; 
                if (f === 'type') actions.changeArticleType(v);
                if (f === 'status') state.articleStatusTouched = true;
            },
            changeArticleType: (newType) => {
                state.articleFormData.type = newType;
                if (!state.articleFormData.id) {
                    const hasDates = state.articleFormData.milestones.some(m => m.date);
                    if (!hasDates) {
                        const templates = ARTICLE_CONFIG[newType].milestones || [];
                        state.articleFormData.milestones = templates.map(label => ({ label, date: '', note: '' }));
                        renderMilestonesList(); 
                    }
                }
                updateArticleTypeUI(newType); 
                updateStatusFromMilestones();
            },
            addMilestone: () => {
                const ms = state.articleFormData.milestones;
                let insertIndex = ms.length; 
                for (let i = ms.length - 1; i >= 0; i--) {
                    if (ms[i].date) {
                        insertIndex = i + 1;
                        break;
                    }
                }
                if (insertIndex === ms.length && ms.every(m => !m.date)) {
                     insertIndex = ms.length > 0 ? 1 : 0;
                }
                const newNode = { label: '', date: '', note: '', expanded: true };
                ms.splice(insertIndex, 0, newNode);
                renderMilestonesList();
                updateStatusFromMilestones(); 
                setTimeout(() => {
                     const inputs = document.querySelectorAll('#milestone-list-container input[type="text"]');
                     if(inputs[insertIndex]) inputs[insertIndex].focus();
                }, 0);
            },
            appendRecommendedNodes: () => {
                const type = state.articleFormData.type || 'æœŸåˆŠè®ºæ–‡';
                const templates = ARTICLE_CONFIG[type].milestones || [];
                const currentLabels = state.articleFormData.milestones.map(m => m.label);
                const newNodes = templates.filter(t => !currentLabels.includes(t))
                                          .map(label => ({ label, date: '', note: '' }));
                if (newNodes.length > 0) {
                    state.articleFormData.milestones = [...state.articleFormData.milestones, ...newNodes];
                    state.articleFormData.milestones = sortMilestones(state.articleFormData.milestones);
                    renderMilestonesList();
                    updateStatusFromMilestones(); 
                } else {
                    alert("æ¨èèŠ‚ç‚¹å·²å…¨éƒ¨å­˜åœ¨");
                }
            },
            removeMilestone: (index) => {
                if (state.articleFormData.milestones.length <= 1) {
                    alert("è¯·è‡³å°‘ä¿ç•™ä¸€ä¸ªèŠ‚ç‚¹");
                    return;
                }
                state.articleFormData.milestones.splice(index, 1);
                renderMilestonesList();
                updateStatusFromMilestones();
            },
            updateMilestoneText: (index, field, value) => {
                state.articleFormData.milestones[index][field] = value;
                if (field === 'label') updateStatusFromMilestones();
            },
            // Note: updateMilestoneDate is replaced by selectCalendarDate
            toggleMilestoneNote: (index) => {
                const m = state.articleFormData.milestones[index];
                m.expanded = !m.expanded;
                const noteEl = document.getElementById(`ms-note-${index}`);
                const iconBtn = noteEl.parentElement.querySelector('button i');
                if (noteEl) {
                    if (m.expanded) {
                        noteEl.classList.remove('hidden');
                        if(iconBtn) iconBtn.closest('button').classList.add('rotate-180', 'text-indigo-500');
                    } else {
                        noteEl.classList.add('hidden');
                        if(iconBtn) iconBtn.closest('button').classList.remove('rotate-180', 'text-indigo-500');
                    }
                }
            },
            saveArticle: (e) => {
                e.preventDefault();
                const d = state.articleFormData;
                if(!d.title) { alert("æ ‡é¢˜ä¸èƒ½ä¸ºç©º"); return; }
                const newArticle = {
                    ...d,
                    id: d.id || Date.now(),
                    submissionDate: d.milestones.find(m => m.date)?.date || getTodayStr() 
                };
                if (d.id) {
                    state.articles = state.articles.map(a => a.id === d.id ? newArticle : a);
                } else {
                    state.articles.push(newArticle);
                }
                state.articles.sort((a, b) => new Date(b.submissionDate) - new Date(a.submissionDate));
                state.showArticleModal = false;
                saveUserData();
                render();
            },
            deleteArticle: (id) => {
                if(confirm("ç¡®å®šåˆ é™¤è¿™æ¡æ–‡ç« è®°å½•å—ï¼Ÿ")) {
                    state.articles = state.articles.filter(a => a.id !== id);
                    saveUserData();
                    render();
                }
            }
        };

        // --- Render Components ---
        const Icons = {
            Menu: `<i data-lucide="menu" class="w-6 h-6"></i>`, Target: `<i data-lucide="target" class="w-6 h-6"></i>`, History: `<i data-lucide="history" class="w-6 h-6"></i>`,
            Medal: `<i data-lucide="medal" class="w-6 h-6"></i>`, Edit: `<i data-lucide="pencil" class="w-4 h-4"></i>`, Plus: `<i data-lucide="plus" class="w-5 h-5"></i>`,
            Trash: `<i data-lucide="trash-2" class="w-4 h-4"></i>`, Check: `<i data-lucide="check-circle-2" class="w-5 h-5"></i>`, User: `<i data-lucide="user" class="w-5 h-5"></i>`,
            LogOut: `<i data-lucide="log-out" class="w-5 h-5"></i>`, Switch: `<i data-lucide="users" class="w-5 h-5"></i>`, Settings: `<i data-lucide="settings" class="w-5 h-5"></i>`,
            Play: `<i data-lucide="play" class="w-5 h-5"></i>`, X: `<i data-lucide="x" class="w-5 h-5"></i>`, Star: `<i data-lucide="star" class="w-4 h-4"></i>`,
            Wand: `<i data-lucide="wand-2" class="w-3 h-3"></i>`, Cal: `<i data-lucide="calendar" class="w-4 h-4"></i>`,
            Left: `<i data-lucide="chevron-left" class="w-5 h-5"></i>`, Right: `<i data-lucide="chevron-right" class="w-5 h-5"></i>`,
            File: `<i data-lucide="file-text" class="w-6 h-6"></i>`, Book: `<i data-lucide="book" class="w-4 h-4"></i>`,
            Refresh: `<i data-lucide="refresh-cw" class="w-3 h-3"></i>`, Down: `<i data-lucide="chevron-down" class="w-4 h-4"></i>`,
            Trophy: `<i data-lucide="trophy" class="w-5 h-5"></i>`
        };

        function AppLogo(size = "w-12 h-12") {
            return `<div class="${size} logo-gradient rounded-xl flex items-center justify-center shadow-lg transform rotate-3"><i data-lucide="graduation-cap" class="text-white w-1/2 h-1/2"></i><div class="absolute -bottom-1 -right-1 bg-white rounded-full p-0.5 border-2 border-indigo-500"><i data-lucide="pen-tool" class="w-3 h-3 text-indigo-600"></i></div></div>`;
        }

        function MoodIcon(mood, selected) {
            const cls = `mood-icon w-6 h-6 ${selected ? 'selected' : 'opacity-60'}`;
            const emoji = {happy:'ğŸ˜Š', neutral:'ğŸ˜', sad:'ğŸ˜”', tired:'ğŸ˜´'};
            return `<div class="${cls} text-xl flex items-center justify-center cursor-pointer transition-transform hover:scale-110">${emoji[mood]}</div>`;
        }

        function renderProgressBar(current, target, label) {
            const pct = Math.max(0, Math.min(100, target > 0 ? (current / target) * 100 : 0));
            const isDone = pct >= 100;
            return `<div class="relative pt-6 pb-2"><div class="progress-track"><div class="progress-jelly ${isDone?'done':''}" style="width: ${pct}%"></div></div>${isDone ? '<div class="absolute -top-1 right-0 animate-bounce-slow text-xl">ğŸ‰</div>' : ''}<div class="flex justify-between text-xs text-slate-400 mt-2 font-medium px-1"><span>0</span><span class="${isDone?'text-green-600 font-bold':''}">${label} ${isDone?'å®Œæˆ!':''}</span><span>${target>1000?(target/10000).toFixed(1)+'w':target}</span></div></div>`;
        }

        function renderLogin() {
            return `<div class="flex flex-col items-center justify-center h-screen px-8 bg-white"><div class="mb-6 animate-float">${AppLogo("w-24 h-24")}</div><h1 class="text-2xl font-bold text-slate-800 mb-2">PhD Flow</h1><p class="text-slate-400 text-sm mb-10">æš–å¿ƒé™ªä¼´ Â· å¿«ä¹å†™ä½œ</p><form onsubmit="actions.auth(event)" class="w-full space-y-4"><input name="username" placeholder="ä¾‹å¦‚ï¼šæœªæ¥çš„æåšå£«" class="w-full bg-gray-50 border border-gray-200 p-4 rounded-2xl outline-none focus:border-indigo-500 text-center font-bold text-slate-700" required><input name="password" type="password" placeholder="è¯·è¾“å…¥å¯†ç " class="w-full bg-gray-50 border border-gray-200 p-4 rounded-2xl outline-none focus:border-indigo-500 text-center"><button class="w-full primary-gradient text-white font-bold py-4 rounded-2xl shadow-lg shadow-indigo-200 active:scale-95 transition-transform">è¿›å…¥ä¹¦æˆ¿</button></form><p class="mt-8 text-xs text-slate-300">Tip: ä¸ç®¡è¾“å…¥ä»€ä¹ˆï¼Œç‚¹å‡»æŒ‰é’®éƒ½ä¼šè¿›å…¥å“¦</p></div>`;
        }

        function renderDashboard() {
            const { total, today } = calcStats(state.viewDate);
            const dailyAvg = getDailyAverage(); // ä½¿ç”¨æ–°å‡½æ•°è®¡ç®—æ—¥å‡
            const days = getDaysLeft();
            const isToday = state.viewDate === getTodayStr();
            
            let dateStr = state.viewDate;
            let weekStr = '';
            const d = parseSafeDate(state.viewDate);
            if (d) {
                dateStr = `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
                weekStr = d.toLocaleDateString('zh-CN', { weekday: 'long' });
            }
            
            const dayPlans = state.dailyPlans.filter(p => p.date === state.viewDate);
            
            // éœ€æ±‚2ï¼šç§»é™¤ maxDate é™åˆ¶ï¼Œå…è®¸å‘æœªæ¥åˆ‡æ¢
            // ä»ç„¶ä¿ç•™ getMaxDate() å‡½æ•°å¯èƒ½ç”¨äºå…¶ä»–é€»è¾‘ï¼Œä½†ä¸å†ç”¨äºé™åˆ¶ç¿»é¡µ
            
            let plansHtml = dayPlans.length > 0 ? dayPlans.map(plan => {
                const currentProgress = getPlanProgress(plan.id, state.viewDate);
                const isDone = currentProgress >= plan.target;
                const pct = Math.min(100, Math.round(((currentProgress || 0) / plan.target) * 100));
                const goal = state.customGoals.find(g => g.id === plan.linkedGoalId);
                const goalName = goal ? goal.name : 'è‡ªç”±å†™ä½œ';
                const tagStyle = getGoalTagStyle(goalName);
                return `<div class="${isDone ? 'card-gradient-done border-green-200' : 'card-gradient-1 border-white'} rounded-[24px] p-6 shadow-[0_10px_30px_rgba(0,0,0,0.06)] mb-6 relative transition-all hover:scale-[1.01] border"><div class="absolute top-5 right-5 flex gap-2"><button onclick="actions.openEditPlan('${plan.id}')" class="text-slate-300 hover:text-indigo-500">${Icons.Edit}</button><button onclick="actions.deletePlan('${plan.id}')" class="text-slate-300 hover:text-red-500">${Icons.Trash}</button></div><div class="flex flex-col items-start mb-4 pr-16 mt-2"><div class="mb-3"><span class="goal-tag ${tagStyle.cls}"><span class="text-sm">${tagStyle.emoji}</span> ${goalName}</span></div><h2 class="text-lg font-bold text-slate-800">${plan.content}</h2></div><div class="flex items-baseline gap-2 mb-3"><span class="text-4xl font-black ${isDone ? 'text-green-600' : 'text-indigo-600'}">${currentProgress}</span><span class="text-xs text-slate-400 font-bold">/ ${plan.target} å­—</span></div><div class="progress-track mb-5"><div class="progress-jelly ${isDone?'done':''}" style="width: ${pct}%"></div></div>${isDone ? `<div class="w-full py-3 text-center text-green-700 font-bold text-sm bg-white/60 rounded-xl flex items-center justify-center gap-2">ğŸ‰ æ­å–œè¾¾æˆï¼</div>` : `<button onclick="actions.start('${plan.id}')" class="w-full bg-white text-indigo-600 py-3 rounded-xl font-bold shadow-sm border border-indigo-100 flex items-center justify-center gap-2 active:scale-95 transition-transform hover:bg-indigo-50">${Icons.Play} å¼€å§‹ä¸“æ³¨</button>`}</div>`;
            }).join('') : `<div class="text-center py-12 text-slate-300"><div class="mb-2 text-4xl opacity-50">ğŸƒ</div><p class="text-xs font-medium">${isToday ? 'ä»Šå¤©' : 'è¿™ä¸€å¤©'}è¿™é‡Œå¾ˆå®‰é™ï¼Œæ·»åŠ ä¸€ä¸ªç›®æ ‡å§</p></div>`;

            const goals = state.customGoals.map(g => {
                const qtyPct = Math.min(100, Math.round((g.currentQty / g.targetQty) * 100));
                const isQtyDone = g.currentQty >= g.targetQty;
                return `<div class="bg-white rounded-[20px] p-5 border border-slate-100 mb-4 relative group transition-all hover:shadow-lg shadow-sm"><div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="actions.openEditGoal('${g.id}')" class="text-slate-300 hover:text-indigo-500"><i data-lucide="pencil" class="w-3 h-3"></i></button><button onclick="actions.delGoal('${g.id}')" class="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div><div class="flex justify-between items-center mb-4"><div class="flex items-center gap-2"><span class="font-bold text-lg text-slate-800">${g.name}</span>${isQtyDone ? '<span class="text-[10px] bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full border border-yellow-200 font-bold">å·²è¾¾æˆ</span>' : ''}</div><div class="text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded font-medium">ç›®æ ‡: ${g.targetQty} ${g.unit}</div></div>${renderProgressBar(g.accumulatedWords, g.targetWords, "å­—æ•°è¿›åº¦")}<div class="flex items-center gap-3 mt-4 pt-3 border-t border-slate-50"><span class="text-xs font-bold text-slate-400">æ•°é‡è¿›åº¦</span><div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden"><div class="h-full bg-yellow-400 rounded-full" style="width: ${qtyPct}%"></div></div><div class="text-xs font-mono text-slate-500 w-12 text-right">${g.currentQty}/${g.targetQty}</div><button onclick="actions.addQty('${g.id}')" class="w-8 h-8 bg-green-50 text-green-600 rounded-full flex items-center justify-center font-bold text-xs hover:bg-green-100 transition-colors shadow-sm border border-green-100">+1</button></div></div>`;
            }).join('');

            // éœ€æ±‚1ï¼šæ›´æ–°å€’è®¡æ—¶è®¾ç½®å¼¹çª—æ–‡æ¡ˆä¸æ ·å¼
            return `<div class="flex flex-col h-full bg-gray-50 overflow-hidden"><div class="bg-slate-800 text-white p-5 pb-8 rounded-b-[30px] shadow-lg shrink-0 -mb-6 z-10 relative"><div class="flex justify-between items-center"><div><div class="text-xs text-indigo-300 font-bold uppercase tracking-wider mb-1 flex items-center gap-1">ğŸ“ ${state.globalGoalType}å€’è®¡æ—¶</div><div class="text-2xl font-bold tracking-tight">${days !== null ? `è¿˜æœ‰ <span class="text-yellow-400 font-black text-3xl mx-1">${days}</span> å¤©` : 'ç‚¹å‡»è®¾ç½®'}</div></div><button onclick="actions.toggleGrad()" class="bg-white/10 p-2 rounded-full text-white hover:bg-white/20 transition">${Icons.Settings}</button></div>
            
            ${state.showGradSettings ? `<div class="absolute inset-x-4 top-20 bg-white shadow-xl p-5 rounded-2xl z-30 animate-scale-in border border-slate-100 flex flex-col gap-4">
                <h3 class="text-lg font-bold text-slate-800 border-b border-slate-50 pb-2">è®¾ç½®å€’è®¡æ—¶ç›®æ ‡</h3>
                <div>
                    <label class="text-[13px] font-bold text-slate-700 mb-1 block">å€’è®¡æ—¶æ—¥æœŸ</label>
                    <input type="date" id="grad-date-input" value="${state.graduationDate}" class="w-full bg-slate-50 text-slate-800 border border-slate-200 rounded-lg p-2.5 outline-none font-medium">
                </div>
                <div class="pt-2">
                    <label class="text-[13px] font-bold text-indigo-600 mb-3 block">ç›®æ ‡ä¿¡æ¯</label>
                    <div class="grid grid-cols-1 gap-3">
                        <div>
                            <label class="text-[13px] font-bold text-slate-700 block mb-1.5">ç›®æ ‡ç±»å‹ï¼ˆå¦‚ï¼šæ¯•ä¸šã€ç»“é¢˜ã€è¯„èŒç§°ï¼‰</label>
                            <input type="text" id="global-type-input" value="${state.globalGoalType}" placeholder="ä¾‹å¦‚ï¼šè¯¾ç¨‹æ¯•ä¸š / åšå£«ç­”è¾© / é¡¹ç›®ç»“é¢˜ / èŒç§°è¯„å®¡" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 text-[15px] outline-none text-slate-900 placeholder:text-gray-400 font-medium">
                        </div>
                        <div>
                            <label class="text-[13px] font-bold text-slate-700 block mb-1.5">ç›®æ ‡åç§°ï¼ˆå¦‚ï¼šè®ºæ–‡é¢˜ç›®ã€é¡¹ç›®åç§°ï¼‰</label>
                            <input type="text" id="global-name-input" value="${state.globalGoalName}" placeholder="ä¾‹å¦‚ï¼šåšå£«è®ºæ–‡ / åŸºé‡‘é¡¹ç›® / ä¸“è‘— / æ•™å­¦æˆæœ" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 text-[15px] outline-none text-slate-900 placeholder:text-gray-400 font-medium">
                        </div>
                    </div>
                </div>
                <button onclick="actions.saveGradSettings()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-200 active:scale-95 transition-transform mt-2">ä¿å­˜è®¾ç½®</button>
            </div>` : ''}
            
            </div><div class="flex-1 overflow-y-auto px-4 pt-10 pb-32 space-y-6"><div class="flex justify-between items-center bg-white p-2 rounded-2xl shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-slate-50"><button onclick="actions.changeDate(-1)" class="p-3 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition">${Icons.Left}</button><div class="flex flex-col items-center cursor-pointer group" onclick="actions.goToToday()"><span class="text-lg font-bold text-slate-800">${dateStr}</span>${isToday ? `<span class="text-xs text-indigo-600 font-bold bg-indigo-50 px-3 py-0.5 rounded-full mt-1 border border-indigo-100 flex items-center gap-1">ä»Šå¤© Â· ${weekStr}</span>` : `<span class="text-xs text-slate-400 font-bold bg-slate-50 px-3 py-0.5 rounded-full mt-1 border border-slate-100 group-hover:bg-indigo-50 group-hover:text-indigo-500 transition flex items-center gap-1"><i data-lucide="rotate-ccw" class="w-3 h-3"></i> å›åˆ°ä»Šå¤©</span>`}</div><button onclick="actions.changeDate(1)" class="p-3 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition">${Icons.Right}</button></div><div class="bg-gradient-psych p-4 rounded-[20px] flex gap-3 items-start shadow-sm relative overflow-hidden"><div class="absolute -right-2 -top-2 text-6xl opacity-10">âœ¨</div><div class="mt-1 bg-white p-1.5 rounded-full shadow-sm text-indigo-500"><i data-lucide="sparkles" class="w-4 h-4"></i></div><div><h4 class="text-xs font-bold text-indigo-400 mb-1 uppercase tracking-wider">å¿ƒç†èƒ½é‡ç«™</h4><p class="text-sm text-slate-700 italic font-medium leading-relaxed">"${state.dailyQuote}"</p></div></div><div><h3 class="text-sm font-bold text-slate-400 mb-4 uppercase tracking-wider px-1 flex items-center gap-2"><div class="w-1 h-4 bg-indigo-400 rounded-full"></div> ${isToday?'ä»Šæ—¥':weekStr}ä¸“æ³¨</h3>${plansHtml}<button onclick="actions.openAddPlan()" class="w-full bg-white border-2 border-dashed border-indigo-100 rounded-[24px] p-4 text-indigo-400 font-bold flex items-center justify-center gap-2 hover:bg-indigo-50 transition-colors mt-6">${Icons.Plus} æ·»åŠ ${isToday?'ä»Šæ—¥':'è¯¥æ—¥'}ä¸“æ³¨</button></div>
            
            <div class="grid grid-cols-3 gap-2">
                <div class="bg-white p-3 rounded-[20px] border border-indigo-50 shadow-sm flex flex-col justify-center items-center text-center">
                    <div class="text-[10px] text-slate-400 mb-1 font-bold">å·²å†™æ€»å­—æ•°</div>
                    <div class="text-xl font-black text-slate-800">${total.toLocaleString()}</div>
                </div>
                <div class="bg-white p-3 rounded-[20px] border border-purple-50 shadow-sm flex flex-col justify-center items-center text-center">
                    <div class="text-[10px] text-slate-400 mb-1 font-bold">æ—¥å‡äº§å‡º</div>
                    <div class="text-xl font-black text-slate-800">${dailyAvg.toLocaleString()}</div>
                </div>
                <div class="bg-white p-3 rounded-[20px] border border-orange-50 shadow-sm flex flex-col justify-center items-center text-center">
                    <div class="text-[10px] text-slate-400 mb-1 font-bold">ä»Šå¤©æ–°å¢</div>
                    <div class="text-xl font-black text-slate-800">${today.toLocaleString()}</div>
                </div>
            </div>
            
            <div><div class="flex justify-between items-center mb-4 px-1 mt-6"><h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2"><div class="w-1 h-4 bg-yellow-400 rounded-full"></div> ${state.globalGoalType}æ€»ç›®æ ‡</h3><button onclick="actions.openAddGoal()" class="text-xs text-indigo-600 font-bold bg-indigo-50 hover:bg-indigo-100 px-3 py-1.5 rounded-lg transition">+ æ–°å»ºç›®æ ‡</button></div>${goals}</div></div></div>`;
        }

        function renderWorking() {
            const plan = state.dailyPlans.find(p => p.id === state.currentSession.planId);
            const goalTitle = plan ? plan.content : 'è‡ªç”±å†™ä½œ';
            const net = (parseInt(state.formData.endCount)||state.currentSession.startCount) - state.currentSession.startCount;
            return `<div class="flex flex-col h-full bg-gray-50 pb-safe overflow-y-auto"><div class="bg-white p-6 pb-8 border-b border-slate-100 shadow-sm mb-4 relative overflow-hidden"><div class="absolute top-0 right-0 w-40 h-40 bg-indigo-50 rounded-full -mr-12 -mt-12 blur-3xl opacity-60"></div><div class="flex justify-between items-start mb-6 relative z-10"><div class="inline-flex items-center gap-1 bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold animate-pulse-soft border border-indigo-100"><span class="w-2 h-2 bg-indigo-500 rounded-full"></span> ä¸“æ³¨æ¨¡å¼</div><button onclick="actions.cancelSession()" class="text-slate-400 hover:text-red-500 bg-slate-50 p-2 rounded-full">${Icons.X}</button></div><h2 class="text-3xl font-bold text-slate-800 mb-2 relative z-10">${goalTitle}</h2><div class="text-slate-500 text-sm mb-6 relative z-10">å¼€å§‹äº <span class="font-mono font-bold text-indigo-500">${new Date(state.currentSession.start).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div><div class="flex items-center gap-2 text-sm text-slate-400 mb-6 relative z-10 bg-slate-50 p-3 rounded-xl border border-slate-100 inline-flex"><span>åˆå§‹å­—æ•°: ${state.currentSession.startCount}</span><button onclick="actions.adjustStart()" class="text-indigo-500 text-xs font-bold hover:underline bg-white px-2 py-1 rounded shadow-sm">ä¿®æ­£</button></div><div class="bg-gradient-to-br from-indigo-50 to-white rounded-2xl p-5 border border-indigo-100 relative z-10 text-center shadow-sm"><div class="text-xs text-indigo-400 font-bold mb-1 uppercase tracking-wider">æœ¬æ¬¡äº§å‡º</div><div class="text-5xl font-black text-indigo-600" id="net-word-display">${net > 0 ? '+' + net : net}</div></div></div><form onsubmit="actions.end(event)" class="px-4 space-y-4 flex-1 flex flex-col"><div class="bg-white p-5 rounded-[24px] shadow-sm border border-slate-100"><label class="text-sm font-bold text-slate-500 mb-3 block text-center">ç»“æŸå­—æ•°</label><input type="number" name="endCount" required value="${state.formData.endCount||''}" oninput="actions.setFormData('endCount',this.value)" class="text-5xl font-black text-slate-800 w-full text-center outline-none border-b-2 border-transparent focus:border-indigo-100 bg-transparent py-2 placeholder-slate-200" placeholder="${state.currentSession.startCount}"></div><div class="bg-white p-5 rounded-[24px] shadow-sm border border-slate-100 space-y-4 flex-1"><div><label class="text-sm font-bold text-slate-500 mb-3 block">çŠ¶æ€ & æ„Ÿæƒ³</label><div class="flex justify-around mb-6">${['happy','neutral','sad','tired'].map(m => `<button type="button" onclick="actions.setMood('${m}')"><i data-lucide="${{happy:'smile',neutral:'meh',sad:'frown',tired:'coffee'}[m]}" class="w-10 h-10 mood-icon ${state.formData.mood===m?'selected text-indigo-500':'text-slate-300'}"></i></button>`).join('')}</div><textarea name="reflection" placeholder="å†™å¾—æ€ä¹ˆæ ·ï¼Ÿè®°å½•ä¸€ä¸‹æ­¤åˆ»çš„å¿ƒæƒ…..." oninput="actions.setFormData('reflection',this.value)" class="w-full bg-slate-50 border border-slate-100 rounded-2xl p-4 text-sm h-32 resize-none outline-none focus:ring-2 focus:ring-indigo-100 transition">${state.formData.reflection}</textarea></div></div><button class="w-full primary-gradient text-white font-bold py-4 rounded-[20px] shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 mt-4 active:scale-95 transition-transform">${Icons.Check} å®Œæˆæ‰“å¡</button></form></div>`;
        }

        function renderAddEntry() {
            const goalOptions = state.customGoals.map(g => `<option value="${g.id}" ${g.id === state.formData.linkedGoalId ? 'selected' : ''}>${g.name} (ä¸Šæ¬¡ç»“æŸ: ${getLastCountForGoal(g.id)})</option>`).join('');
            const net = (parseInt(state.formData.endCount)||state.formData.startCount) - state.formData.startCount;
            return `<div class="pb-safe h-full overflow-y-auto bg-gray-50"><div class="px-5 pt-8 pb-32"><h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2">ğŸ“ è¡¥å½•æ‰“å¡</h2><form onsubmit="actions.end(event)" class="space-y-5"><div class="bg-white p-6 rounded-[24px] shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-slate-50"><div class="mb-5"><label class="text-xs font-bold text-slate-400 mb-2 block uppercase tracking-wider">æ—¥æœŸ</label><input type="date" name="date" value="${state.formData.date || getTodayStr()}" onchange="actions.setFormData('date',this.value)" class="w-full bg-slate-50 border border-slate-100 rounded-xl p-3 text-sm outline-none focus:border-indigo-500 font-medium"></div><div class="mb-5"><label class="text-xs font-bold text-slate-400 mb-2 block uppercase tracking-wider">å…³è”ç›®æ ‡</label><select onchange="actions.setFormData('linkedGoalId',this.value)" class="w-full bg-slate-50 border border-slate-100 rounded-xl p-3 text-sm outline-none focus:border-indigo-500 font-medium appearance-none">${goalOptions}</select></div><div class="grid grid-cols-2 gap-4 mb-5"><div><label class="text-xs font-bold text-slate-400 mb-2 block uppercase tracking-wider">å¼€å§‹å­—æ•°</label><div class="flex items-center"><button type="button" onclick="actions.adjustManualStart(-100)" class="p-3 bg-slate-100 rounded-l-xl text-slate-500 hover:bg-slate-200 font-bold">-</button><input type="number" name="startCount" value="${state.formData.startCount}" oninput="actions.setFormData('startCount',this.value)" class="w-full text-center bg-slate-50 border-y border-slate-100 py-3 text-sm font-bold outline-none"><button type="button" onclick="actions.adjustManualStart(100)" class="p-3 bg-slate-100 rounded-r-xl text-slate-500 hover:bg-slate-200 font-bold">+</button></div></div><div><label class="text-xs font-bold text-slate-400 mb-2 block uppercase tracking-wider">ç»“æŸå­—æ•°</label><input type="number" name="endCount" required value="${state.formData.endCount}" oninput="actions.setFormData('endCount',this.value)" class="w-full bg-white border-2 border-indigo-100 rounded-xl p-2.5 text-lg font-bold text-center outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-50 transition"></div></div><div class="flex justify-between items-center bg-indigo-50 p-4 rounded-xl"><span class="text-sm text-indigo-400 font-bold">æœ¬æ¬¡å‡€å¢</span><span id="net-word-display" class="font-black text-2xl text-indigo-600">${net} å­—</span></div></div><div class="bg-white p-6 rounded-[24px] shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-slate-50 space-y-6"><div><div class="flex justify-between items-center mb-4"><label class="text-xs font-bold text-slate-400 uppercase tracking-wider">çŠ¶æ€ & æ„Ÿæƒ³</label><button type="button" onclick="actions.autoGenReflection()" class="text-xs bg-purple-50 text-purple-600 px-3 py-1.5 rounded-lg flex items-center gap-1 font-bold hover:bg-purple-100 transition">${Icons.Wand} å¸®æˆ‘å†™</button></div><div class="flex justify-around mb-6">${['happy','neutral','sad','tired'].map(m => `<button type="button" onclick="actions.setMood('${m}')">${MoodIcon(m, state.formData.mood === m)}</button>`).join('')}</div><textarea name="reflection" placeholder="å¦‚æœä¸å†™ï¼Œæˆ‘å°±å¸®ä½ è‡ªåŠ¨ç”Ÿæˆå•¦~" oninput="actions.setFormData('reflection',this.value)" class="w-full bg-slate-50 border border-slate-100 rounded-xl p-4 text-sm h-28 resize-none outline-none focus:ring-2 focus:ring-indigo-100 transition">${state.formData.reflection}</textarea></div><div><div class="flex justify-between items-center mb-3"><label class="text-xs font-bold text-slate-400 uppercase tracking-wider">æŠ•å…¥æ—¶é•¿</label><span id="duration-display" class="text-sm font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded-lg min-w-[4rem] text-center">${state.formData.duration || '0 å°æ—¶'}</span></div><div class="px-2 py-2"><input type="range" min="0" max="12" step="0.5" value="${state.formData.durationNum || 0}" oninput="actions.updateDuration(this.value)"><div class="flex justify-between text-[10px] text-slate-300 mt-2 font-mono"><span>0h</span><span>6h</span><span>12h</span></div></div></div><div><label class="text-xs font-bold text-slate-400 mb-2 block uppercase tracking-wider">å®Œæˆå†…å®¹ (é€‰å¡«)</label><input type="text" name="chapter" value="${state.formData.chapter}" oninput="actions.setFormData('chapter',this.value)" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸‰ç« æ–‡çŒ®ç»¼è¿°" class="w-full bg-slate-50 border border-slate-100 rounded-xl p-3 text-sm outline-none focus:border-indigo-300"></div></div><button class="w-full primary-gradient text-white font-bold py-4 rounded-[20px] shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 active:scale-95 transition-transform">${Icons.Check} æäº¤æ‰“å¡</button></form></div></div>`;
        }

        function renderRank() {
            if(state.loadingLeaderboard) return `<div class="p-10 text-center text-slate-400 flex flex-col items-center gap-2"><div class="spinner"></div><p class="text-xs">æ¦œå•åˆ·æ–°ä¸­...</p></div>`;
            const list = state.leaderboard.map((u,i)=> {
                let rankBadge = `<span class="font-bold w-6 text-center text-slate-400">${i+1}</span>`;
                if(i===0) rankBadge = `<span class="text-xl">ğŸ¥‡</span>`;
                if(i===1) rankBadge = `<span class="text-xl">ğŸ¥ˆ</span>`;
                if(i===2) rankBadge = `<span class="text-xl">ğŸ¥‰</span>`;
                return `<div class="flex items-center gap-3 p-4 bg-white border border-slate-100 rounded-[20px] mb-3 shadow-[0_2px_10px_rgba(0,0,0,0.02)]"><div class="w-8 flex justify-center">${rankBadge}</div><img src="${u.avatar}" class="w-10 h-10 rounded-full border-2 border-white shadow-sm"><span class="flex-1 font-bold text-sm text-slate-700">${u.username}</span><div class="bg-indigo-50 px-3 py-1 rounded-full"><span class="font-black text-indigo-600 text-sm">${u.wordCount}</span> <span class="text-xs text-indigo-400">å­—</span></div></div>`;
            }).join('');
            return `<div class="p-4 bg-gray-50 h-full overflow-y-auto pb-32"><div class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white p-6 rounded-[24px] shadow-lg mb-6 relative overflow-hidden"><div class="absolute right-0 top-0 text-6xl opacity-20">ğŸ†</div><h2 class="font-bold text-xl mb-1">ä»Šæ—¥é¾™è™æ¦œ</h2><p class="text-xs opacity-90">çœ‹è§åšæŒçš„åŠ›é‡ Â· å…¨ç½‘åŒæ­¥</p></div>${list||'<div class="flex flex-col items-center justify-center py-20 opacity-50"><div class="text-4xl mb-2">ğŸƒ</div><p class="text-sm">ä»Šæ—¥è¿˜æ²¡æœ‰äººæ‰“å¡å“¦</p></div>'}</div>`;
        }

        function renderHistory() {
            const list = state.entries.slice().reverse().map(e=>`<div class="bg-white p-5 rounded-[24px] border border-slate-100 shadow-sm mb-4 relative overflow-hidden"><div class="absolute left-0 top-0 bottom-0 w-2 bg-indigo-500"></div><div class="pl-3"><div class="flex justify-between mb-2"><span class="text-xs font-bold text-slate-400 bg-slate-50 px-2 py-0.5 rounded">${e.date}</span><span class="text-green-600 font-bold bg-green-50 px-2 py-0.5 rounded">+${e.dailyCount}å­—</span></div><div class="text-base font-bold text-slate-800 mb-2">${e.linkedPlanContent || e.linkedGoalName || 'è‡ªç”±å†™ä½œ'}</div><div class="text-sm text-slate-500 bg-slate-50 p-3 rounded-xl italic">"${e.reflection||'æ— æ„Ÿæƒ³'}"</div>${e.duration ? `<div class="mt-2 text-xs text-slate-400 flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> æŠ•å…¥æ—¶é•¿: ${e.duration}</div>` : ''}</div></div>`).join('');
            return `<div class="p-4 bg-gray-50 h-full overflow-y-auto pb-32"><div class="flex justify-between items-center mb-6 px-1"><h2 class="font-bold text-xl text-slate-800">å†å²è¶³è¿¹</h2><span class="text-xs text-slate-400 bg-white px-2 py-1 rounded-full border border-slate-100 shadow-sm">å½“å‰è´¦å·: ${state.user.username}</span></div>${list||'<p class="text-center text-slate-400 mt-20">ç©ºç©ºå¦‚ä¹Ÿï¼Œå»å†™ä¸‹ç¬¬ä¸€ç¬”å§ï¼</p>'}</div>`;
        }

        // --- æ–‡ç« çŠ¶æ€é¡µé¢ (å‡çº§ç‰ˆ: æŠ˜å è¯¦æƒ…) ---
        function renderArticles() {
            let articleList = '';
            if (state.articles.length > 0) {
                articleList = state.articles.map(article => {
                    // 1. è¿›åº¦è®¡ç®—
                    const milestones = article.milestones || [];
                    const totalSteps = milestones.length > 0 ? milestones.length : 1;
                    const completedSteps = milestones.filter(m => m.date).length;
                    const progressPct = Math.min(100, Math.round((completedSteps / totalSteps) * 100));

                    // 2. æ—¶é—´çº¿æ¸²æŸ“ (å…ˆæ’åº)
                    const sortedMilestones = [...milestones].sort((a,b) => {
                        if(!a.date) return 1; 
                        if(!b.date) return -1;
                        return new Date(a.date) - new Date(b.date);
                    });

                    const timelineHtml = sortedMilestones.map((node, index) => {
                        const isDone = !!node.date;
                        return `
                        <div class="flex gap-3 relative group">
                            <div class="timeline-line"></div>
                            <div class="flex flex-col items-center relative z-10">
                                <div class="w-3 h-3 rounded-full ${isDone ? 'bg-indigo-500' : 'bg-slate-300'} border-2 border-white shadow-sm"></div>
                            </div>
                            <div class="pb-6 flex-1">
                                <div class="flex items-center justify-between mb-0.5">
                                    <span class="text-sm font-bold ${isDone ? 'text-slate-800' : 'text-slate-400'}">${node.label}</span>
                                    ${node.date ? `<span class="text-xs text-slate-500 font-mono bg-slate-50 px-1.5 rounded">${node.date}</span>` : ''}
                                </div>
                                ${node.note ? `<div class="text-xs text-slate-400 mt-1">${node.note}</div>` : ''}
                            </div>
                        </div>`;
                    }).join('');

                    return `
                    <div class="bg-white rounded-[24px] p-5 shadow-[0_4px_20px_rgba(0,0,0,0.03)] mb-5 border border-slate-50 relative group transition-all duration-300">
                        <!-- æ¦‚è§ˆåŒºåŸŸ (å§‹ç»ˆæ˜¾ç¤º) -->
                        <div class="mb-4">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center flex-wrap gap-2">
                                    <span class="${getArticleTypeClass(article.type)} text-[10px] font-bold px-2 py-0.5 rounded-full">${article.type || 'æœŸåˆŠè®ºæ–‡'}</span>
                                    <span class="bg-indigo-50 text-indigo-600 text-[10px] font-bold px-2 py-0.5 rounded-full border border-indigo-100">${article.status || 'æœªè®¾ç½®çŠ¶æ€'}</span>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="actions.openEditArticle(${article.id})" class="text-slate-300 hover:text-indigo-500 p-1.5 rounded-full hover:bg-indigo-50 transition"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></button>
                                    <button onclick="actions.deleteArticle(${article.id})" class="text-slate-300 hover:text-red-500 p-1.5 rounded-full hover:bg-red-50 transition"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                                </div>
                            </div>
                            <h3 class="text-lg font-bold text-slate-800 leading-tight mb-1 pr-4">${article.title}</h3>
                            <div class="text-xs text-slate-400 font-medium">${article.journal || 'æœªå¡«å†™æœŸåˆŠ/æ¥æº'}</div>
                        </div>

                        <!-- è¿›åº¦æ¡ + å±•å¼€æŒ‰é’® -->
                        <div class="flex items-end gap-3 mb-2">
                            <div class="flex-1">
                                <div class="flex justify-between text-[10px] text-slate-400 mb-1">
                                    <span class="font-bold text-indigo-400 uppercase tracking-wider">è¿›åº¦æ¦‚è§ˆ</span>
                                    <span>å·²å®Œæˆ ${completedSteps} / ${totalSteps} èŠ‚ç‚¹</span>
                                </div>
                                <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-indigo-500 rounded-full transition-all duration-500" style="width: ${progressPct}%"></div>
                                </div>
                            </div>
                            <button id="article-toggle-btn-${article.id}" onclick="actions.toggleArticleDetails(${article.id})" class="text-slate-400 hover:text-indigo-600 transition-transform duration-300 p-1">
                                <i data-lucide="chevron-down" class="w-5 h-5"></i>
                            </button>
                        </div>

                        <!-- è¯¦æƒ…åŒºåŸŸ (é»˜è®¤æŠ˜å ) -->
                        <div id="article-details-${article.id}" class="hidden pt-4 mt-4 border-t border-slate-50 animate-fade-in">
                            <div class="pl-1 mb-2">
                                ${timelineHtml}
                            </div>

                            ${(article.reviewNotes || article.notes) ? `
                            <div class="bg-gray-50 rounded-xl p-3 space-y-3 mt-4 border border-slate-100">
                                ${article.reviewNotes ? `
                                    <div>
                                        <div class="text-[10px] font-bold text-indigo-400 uppercase mb-1">å®¡ç¨¿æ‘˜è¦</div>
                                        <div class="text-xs text-slate-600 leading-relaxed whitespace-pre-wrap">${article.reviewNotes}</div>
                                    </div>` : ''}
                                ${article.notes ? `
                                    <div>
                                        <div class="text-[10px] font-bold text-indigo-400 uppercase mb-1">å¤‡æ³¨</div>
                                        <div class="text-xs text-slate-600 leading-relaxed whitespace-pre-wrap">${article.notes}</div>
                                    </div>` : ''}
                            </div>` : ''}
                        </div>
                    </div>`;
                }).join('');
            } else {
                articleList = `<div class="text-center py-20 opacity-50"><div class="text-4xl mb-4">ğŸ“„</div><p class="text-sm font-medium text-slate-500">è¿˜æ²¡æœ‰æ–‡ç« è®°å½•<br>ç‚¹å‡»å³ä¸Šè§’æ·»åŠ ç¬¬ä¸€ç¯‡å§</p></div>`;
            }

            return `<div class="flex flex-col h-full bg-gray-50 overflow-hidden"><div class="px-5 pt-6 pb-2 shrink-0 flex justify-between items-end mb-2"><div><h2 class="text-2xl font-bold text-slate-800">æ–‡ç« çŠ¶æ€</h2><p class="text-xs text-slate-400 mt-1">ä»æŠ•ç¨¿åˆ°å½•ç”¨ï¼Œä¸€ç›®äº†ç„¶</p></div><button onclick="actions.openAddArticle()" class="bg-indigo-600 text-white rounded-xl px-4 py-2 font-bold text-xs shadow-lg shadow-indigo-200 active:scale-95 transition-transform flex items-center gap-1">${Icons.Plus} æ–°å¢</button></div><div class="flex-1 overflow-y-auto px-4 pb-32 hide-scrollbar">${articleList}</div></div>`;
        }

        // --- Main Render ---
        function render() {
            const app = document.getElementById('app');
            if (!app) return;
            cleanOldPlans();
            
            // æ¯æ¬¡ Render ä¸»é¡µé¢æ—¶ï¼Œç¡®ä¿æ—¥å†ç»„ä»¶ä¹Ÿå¤„äºæ­£ç¡®çŠ¶æ€ (ä¸»è¦æ˜¯éšè—)
            // ä½†å¦‚æœä»…ä»…æ˜¯åˆ‡æ¢Tabï¼Œæˆ‘ä»¬ä¸éœ€è¦é‡ç½®æ—¥å†ã€‚æ—¥å†çŠ¶æ€ç”± actions.openCalendar/closeCalendar ç®¡ç†ã€‚
            // åªæœ‰å½“ View å½»åº•æ”¹å˜ (å¦‚ login) æ—¶æ‰éœ€è¦ç‰¹åˆ«æ³¨æ„ã€‚
            // ä¸ºäº†å®‰å…¨èµ·è§ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä¹Ÿè°ƒç”¨ä¸€æ¬¡ renderCalendarComponent ä»¥ä¿æŒåŒæ­¥ï¼ˆä¸»è¦æ˜¯é˜²æ­¢ DOM è¢« wipe åçš„çŠ¶æ€ä¸ä¸€è‡´ï¼‰
            renderCalendarComponent();

            let htmlContent = '';
            
            if (state.view === 'login') {
                htmlContent = renderLogin();
            } else if (state.view === 'app') {
                if (state.currentSession && state.currentSession.isActive) {
                    htmlContent = renderWorking();
                } else {
                    let content = '';
                    if (state.activeTab === 'dashboard') content = renderDashboard();
                    else if (state.activeTab === 'rank') content = renderRank(); // æ¦œå•å†…å®¹æ¸²æŸ“ä¿æŒä¸å˜
                    else if (state.activeTab === 'add') content = renderAddEntry();
                    else if (state.activeTab === 'articles') content = renderArticles();
                    else content = renderHistory(); 
                    
                    const sidebar = state.showSidebar ? `<div class="fixed inset-0 bg-black/50 z-40 animate-fade-in" onclick="actions.toggleSidebar()"></div><div class="fixed top-0 left-0 h-full w-64 bg-white z-50 shadow-2xl p-0 flex flex-col animate-slide-up" style="animation-direction: normal; animation-name: slide-right;"><div class="p-6 border-b border-slate-100 bg-slate-50"><div class="flex items-center gap-3 mb-4"><img src="${state.user.avatar}" class="w-14 h-14 rounded-full border-2 border-white shadow-sm"><div><h3 class="font-bold text-slate-800">${state.user.username}</h3><button onclick="actions.editProfile()" class="text-xs text-indigo-500">ç¼–è¾‘èµ„æ–™</button></div></div><div class="bg-white p-3 rounded-lg border border-slate-200"><div class="text-xs text-slate-400 mb-1">ç´¯è®¡äº§å‡º</div><div class="text-sm font-bold text-slate-800">${state.entries.reduce((a,b)=>a+b.dailyCount,0).toLocaleString()} å­—</div></div></div><div class="p-2 space-y-1"><button onclick="actions.askLogout()" class="w-full flex items-center gap-3 p-3 text-slate-600 hover:bg-slate-50 rounded-xl"><span class="text-indigo-500">${Icons.Switch}</span> åˆ‡æ¢è´¦å·</button><button onclick="actions.askLogout()" class="w-full flex items-center gap-3 p-3 text-red-500 hover:bg-red-50 rounded-xl"><span class="text-red-500">${Icons.LogOut}</span> é€€å‡ºç™»å½•</button></div></div>` : '';

                    let modals = '';
                    // ... Plan & Goal Modals ...
                    if (state.showPlanModal) {
                        const isEdit = !!state.editingPlanId;
                        const options = state.customGoals.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
                        modals += `<div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="actions.closePlanModal()"><div class="bg-white rounded-2xl p-6 w-full max-w-sm" onclick="event.stopPropagation()"><h3 class="font-bold text-lg mb-4 text-slate-800">${isEdit ? 'ç¼–è¾‘ç›®æ ‡' : 'æ·»åŠ ä»Šæ—¥ä¸“æ³¨'}</h3><form onsubmit="actions.savePlan(event)" class="space-y-3"><div><label class="text-xs text-slate-500 font-bold ml-1">å…³è”æ¯•ä¸šç›®æ ‡</label><select onchange="actions.setPlanForm('linkedGoalId',this.value)" class="w-full bg-gray-50 border p-2 rounded-lg text-sm">${options}</select></div><div><label class="text-xs text-slate-500 font-bold ml-1">å…·ä½“å†…å®¹</label><input value="${state.planFormData.content}" oninput="actions.setPlanForm('content',this.value)" class="w-full border p-2 rounded-lg" required></div><div><label class="text-xs text-slate-500 font-bold ml-1">é¢„è®¡å­—æ•°</label><input type="number" value="${state.planFormData.target}" oninput="actions.setPlanForm('target',this.value)" class="w-full border p-2 rounded-lg" required></div><button class="w-full primary-gradient text-white py-3 rounded-xl font-bold mt-2">ä¿å­˜</button></form></div></div>`;
                    }
                    if (state.showGoalModal) {
                        const isEdit = !!state.editingGoalId;
                        modals += `<div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="actions.toggleGoalModal()"><div class="bg-white rounded-2xl p-6 w-full max-w-sm" onclick="event.stopPropagation()"><h3 class="font-bold text-lg mb-4">${isEdit?'ç¼–è¾‘':'æ·»åŠ '}æ¯•ä¸šç›®æ ‡</h3><div class="space-y-3"><input placeholder="åç§° (å¦‚: SCIè®ºæ–‡)" value="${state.newGoalData.name}" oninput="actions.setNewGoal('name',this.value)" class="w-full border p-2 rounded"><div class="flex gap-2"><input type="number" placeholder="æ•°é‡ (3)" value="${state.newGoalData.targetQty}" oninput="actions.setNewGoal('targetQty',this.value)" class="w-full border p-2 rounded"><input placeholder="å•ä½ (ç¯‡)" value="${state.newGoalData.unit}" oninput="actions.setNewGoal('unit',this.value)" class="w-20 border p-2 rounded"></div><input type="number" placeholder="é¢„è®¡æ€»å­—æ•° (å¦‚: 50000)" value="${state.newGoalData.targetWords}" oninput="actions.setNewGoal('targetWords',this.value)" class="w-full border p-2 rounded"></div><div class="flex gap-2 mt-4"><button onclick="actions.toggleGoalModal()" class="flex-1 py-2 text-slate-500">å–æ¶ˆ</button><button onclick="actions.saveGoal()" class="flex-1 primary-gradient text-white rounded">ä¿å­˜</button></div></div></div>`;
                    }
                    if (state.showLogoutModal) {
                        modals += `<div class="fixed inset-0 bg-black/60 z-[80] flex items-center justify-center p-6 animate-fade-in" onclick="actions.cancelLogout()"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-xl animate-scale-in" onclick="event.stopPropagation()"><h3 class="text-lg font-bold text-center mb-2">ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ</h3><div class="flex gap-3 mt-6"><button onclick="actions.cancelLogout()" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold">å–æ¶ˆ</button><button onclick="actions.confirmLogout()" class="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold">ç¡®è®¤é€€å‡º</button></div></div></div>`;
                    }
                    if (state.showFeedback) {
                        modals += `<div class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-6"><div class="bg-white rounded-2xl p-6 w-full max-w-sm text-center"><div class="text-4xl mb-2">ğŸ‰</div><h3 class="font-bold text-xl mb-1">æ‰“å¡æˆåŠŸ!</h3><p class="text-slate-500 mb-4">æœ¬æ¬¡äº§å‡º <span class="font-bold text-indigo-600">${state.feedbackData.diff}</span> å­—</p><div class="bg-indigo-50 p-4 rounded-xl text-indigo-800 text-sm mb-4 italic">"${state.feedbackData.encourageMsg}"</div><button onclick="actions.closeFeedback()" class="w-full primary-gradient text-white py-3 rounded-xl font-bold">å¥½çš„</button></div></div>`;
                    }
                    if (state.showProfileModal) {
                        modals += `<div class="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-6" onclick="actions.closeProfile()"><div class="bg-white rounded-2xl p-6 w-full max-w-sm" onclick="event.stopPropagation()"><h3 class="font-bold text-lg mb-4">ç¼–è¾‘èµ„æ–™</h3><div class="text-center mb-4"><img src="${state.tempProfile.avatar}" class="w-20 h-20 rounded-full mx-auto mb-2"><button onclick="actions.randAvatar()" class="text-xs text-indigo-500">æ¢ä¸ªå¤´åƒ</button></div><input value="${state.tempProfile.name}" oninput="actions.setTempProfile('name',this.value)" class="w-full border p-2 rounded mb-4 text-center font-bold"><button onclick="actions.saveProfile(event)" class="w-full primary-gradient text-white py-3 rounded-xl">ä¿å­˜</button></div></div>`;
                    }
                    
                    // --- å¢å¼ºç‰ˆæ–‡ç« çŠ¶æ€æ·»åŠ æ¨¡æ€æ¡† ---
                    if (state.showArticleModal) {
                        const d = state.articleFormData;
                        modals += `
                        <div class="fixed inset-0 bg-black/60 z-[60] flex items-end sm:items-center justify-center" onclick="actions.toggleArticleModal()">
                            <div class="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-[30px] p-6 max-h-[90vh] overflow-y-auto animate-slide-up" onclick="event.stopPropagation()">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="font-bold text-xl text-slate-800">${d.id ? 'ç¼–è¾‘æ–‡ç« çŠ¶æ€' : 'ğŸ“ è®°å½•æ–‡ç« çŠ¶æ€'}</h3>
                                    <button onclick="actions.toggleArticleModal()" class="text-slate-400 bg-slate-50 p-2 rounded-full hover:bg-slate-100">${Icons.X}</button>
                                </div>
                                <form onsubmit="actions.saveArticle(event)" class="space-y-5">
                                    <div class="space-y-4">
                                        <!-- åŸºæœ¬ä¿¡æ¯åŒº -->
                                        <div>
                                            <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">åŸºæœ¬ä¿¡æ¯ *</label>
                                            <div class="flex gap-2 mb-2">
                                                <input type="text" id="article-title-input" placeholder="æ–‡ç« æ ‡é¢˜" value="${d.title}" oninput="actions.setArticleForm('title',this.value)" class="flex-[2] border border-slate-200 rounded-xl p-3 bg-slate-50 outline-none focus:border-indigo-500 font-bold text-sm" required>
                                                <select onchange="actions.setArticleForm('type',this.value)" class="flex-1 border border-slate-200 rounded-xl p-3 bg-slate-50 outline-none focus:border-indigo-500 text-sm appearance-none">
                                                    ${ARTICLE_TYPES.map(t => `<option value="${t}" ${d.type === t ? 'selected' : ''}>${t}</option>`).join('')}
                                                </select>
                                            </div>
                                            <div class="flex gap-2">
                                                <div class="flex-[2] relative">
                                                    <label id="article-journal-label" class="absolute -top-5 left-0 text-[10px] text-slate-400 hidden">æœŸåˆŠ/ä¼šè®®åç§°</label>
                                                    <input type="text" id="article-journal-input" placeholder="æœŸåˆŠ/ä¼šè®®åç§°" value="${d.journal}" oninput="actions.setArticleForm('journal',this.value)" class="w-full border border-slate-200 rounded-xl p-3 bg-slate-50 outline-none focus:border-indigo-500 text-sm" required>
                                                </div>
                                                <div class="flex-1 relative">
                                                    <input id="article-status-input" list="stage-options" placeholder="å½“å‰çŠ¶æ€" value="${d.status}" oninput="actions.setArticleForm('status',this.value)" class="w-full border border-slate-200 rounded-xl p-3 bg-slate-50 outline-none focus:border-indigo-500 text-sm">
                                                    <datalist id="stage-options"></datalist>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- å…³é”®èŠ‚ç‚¹åŒº -->
                                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                                            <div class="flex justify-between items-center mb-3">
                                                <p class="text-xs font-bold text-indigo-400 uppercase flex items-center gap-1">${Icons.Cal} å…³é”®æ—¶é—´èŠ‚ç‚¹</p>
                                                <div class="flex gap-2">
                                                    ${!d.id ? `<button type="button" onclick="actions.appendRecommendedNodes()" class="text-[10px] bg-white text-indigo-600 px-2 py-1 rounded shadow-sm flex items-center gap-1 border border-indigo-100 hover:bg-indigo-50">${Icons.Refresh} è¡¥å…¨æ¨è</button>` : ''}
                                                    <button type="button" onclick="actions.addMilestone()" class="text-[10px] bg-indigo-600 text-white px-2 py-1 rounded shadow-sm flex items-center gap-1 hover:bg-indigo-700">${Icons.Plus} è‡ªå®šä¹‰</button>
                                                </div>
                                            </div>
                                            
                                            <!-- èŠ‚ç‚¹åˆ—è¡¨å®¹å™¨ -->
                                            <div id="milestone-list-container" class="space-y-2 max-h-60 overflow-y-auto milestones-scroll pr-1">
                                                <!-- Content populated by renderMilestonesList() -->
                                            </div>
                                            
                                            <p class="text-[10px] text-indigo-300 mt-2 text-center">æç¤ºï¼šå¡«å†™æ—¥æœŸåï¼Œä¸Šæ–¹çŠ¶æ€ä¼šè‡ªåŠ¨æ›´æ–°ï¼ˆé™¤éæ‰‹åŠ¨ä¿®æ”¹è¿‡ï¼‰</p>
                                        </div>

                                        <!-- å¤‡æ³¨åŒº -->
                                        <div>
                                            <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">å®¡ç¨¿äººæ„è§æ‘˜è¦</label>
                                            <textarea oninput="actions.setArticleForm('reviewNotes',this.value)" class="w-full border border-slate-200 rounded-xl p-3 bg-slate-50 outline-none focus:border-indigo-500 h-24 resize-none text-sm" placeholder="è®°å½•å®¡ç¨¿äººä¸»è¦æ„è§...">${d.reviewNotes}</textarea>
                                        </div>
                                        
                                        <div>
                                            <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">æ–‡ç« æ•´ä½“å¤‡æ³¨</label>
                                            <textarea oninput="actions.setArticleForm('notes',this.value)" class="w-full border border-slate-200 rounded-xl p-3 bg-slate-50 outline-none focus:border-indigo-500 h-20 resize-none text-sm" placeholder="åˆä½œè€…æƒ…å†µã€åŸºé‡‘å·ç­‰...">${d.notes}</textarea>
                                        </div>
                                    </div>

                                    <button class="w-full primary-gradient text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-200 active:scale-95 transition-transform">ä¿å­˜æ–‡ç« çŠ¶æ€</button>
                                </form>
                            </div>
                        </div>`;
                    }

                    // ä¿®æ”¹åº•éƒ¨å¯¼èˆªæ ï¼Œåªæœ‰ä¸‰ä¸ªæŒ‰é’®
                    const nav = `<nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-slate-100 flex justify-around items-center h-16 z-50 pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]"><button onclick="actions.setTab('dashboard')" class="flex flex-col items-center gap-1 ${state.activeTab==='dashboard'?'text-indigo-600':'text-slate-400'}">${Icons.Target}<span class="text-[10px]">ä¸»é¡µ</span></button><button onclick="actions.setTab('add')" class="flex flex-col items-center gap-1 ${state.activeTab==='add'?'text-indigo-600':'text-slate-400'}"><div class="bg-indigo-600 text-white p-3 rounded-full shadow-lg shadow-indigo-200 -mt-6 mb-1 transform active:scale-95 transition"><span class="block">${Icons.Plus}</span></div><span class="text-[10px]">æ‰“å¡</span></button><button onclick="actions.setTab('articles')" class="flex flex-col items-center gap-1 ${state.activeTab==='articles'?'text-indigo-600':'text-slate-400'}">${Icons.File}<span class="text-[10px]">æ–‡ç« </span></button></nav>`;

                    // ä¿®æ”¹å¤´éƒ¨ (éœ€æ±‚3: æ›¿æ¢ Logo ä¸ºå›¾ç‰‡)
                    htmlContent = `<header class="bg-white px-6 py-4 flex justify-between items-center border-b border-slate-50 shadow-sm z-30">
                        <div class="flex items-center gap-3">
                            <button onclick="actions.toggleSidebar()" class="active:scale-95 transition-transform flex items-center" title="èœå•">
                                <img src="./icon-192.png" alt="PhD Flow" class="w-10 h-10 rounded-2xl shadow-md border border-slate-100">
                            </button>
                            <span class="font-bold text-lg text-slate-800">PhD Flow</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="actions.setTab('rank')" class="text-slate-400 hover:text-indigo-500 hover:bg-indigo-50 p-1.5 rounded-full transition relative group" title="é¾™è™æ¦œ">${Icons.Trophy}</button>
                        </div>
                    </header><main class="flex-1 overflow-hidden relative">${content}</main>${nav}${sidebar}${modals}`;
                }
            }
            
            app.innerHTML = htmlContent;
            if (window.lucide) lucide.createIcons();

            // å…³é”®é€»è¾‘ä¼˜åŒ–ï¼šæ¸²æŸ“å®Œæˆåï¼Œå¦‚æœæœ‰åŠ è½½å±‚ï¼Œåˆ™æ·¡å‡ºç§»é™¤å®ƒ (éœ€æ±‚4)
            const loadingScreen = document.getElementById('app-loading');
            if (loadingScreen && state.view !== 'loading') {
                loadingScreen.classList.add('fade-out');
                // åŠ¨ç”» 600ms åä» DOM ç§»é™¤ï¼Œé¿å…é®æŒ¡ç‚¹å‡»
                setTimeout(() => {
                    if (loadingScreen.parentElement) loadingScreen.remove();
                }, 600);
            }
        }
        
        // --- åˆå§‹åŒ–å…¥å£ ---
        function initApp() {
            try {
                requestAnimationFrame(() => {
                    const savedUser = Storage.get('phd_current_user', null);
                    if (savedUser) { loadLocalUser(savedUser); } else { state.view = 'login'; render(); }
                });
            } catch (error) { console.error("Init failed:", error); state.view = 'login'; render(); }
        }

        if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', initApp); } else { initApp(); }
        
        // ä¿åº•é€»è¾‘ï¼šå¦‚æœ 2 ç§’è¿˜æ²¡ç§»é™¤ loadingï¼Œå¼ºåˆ¶è¿›å…¥
        setTimeout(() => { 
            const loadingScreen = document.getElementById('app-loading');
            if (loadingScreen && !loadingScreen.classList.contains('fade-out')) { 
                state.view = 'login'; 
                render(); 
            } 
        }, 2000);

    </script>
</body>
</html>
