<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- ÁßªÂä®Á´ØËßÜÂè£ËÆæÁΩÆÔºöÁ¶ÅÊ≠¢Áº©ÊîæÔºåÈÄÇÈÖçËÆæÂ§áÂÆΩÂ∫¶ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- iOS Web App ÂÖ®Â±èÊ®°ÂºèÊîØÊåÅ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="PhD Flow">

    <title>PhD Flow</title>
    
    <!-- ÂõæÊ†áÊîØÊåÅ -->
    <link rel="apple-touch-icon" sizes="180x180" href="./icon-180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./icon-192.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./icon-192.png">
    <link rel="shortcut icon" href="./icon-192.png">
    
    <!-- ÂÖ≥ÈîÆÊ†∑ÂºèÁõ¥Êé•ÂÜÖËÅî (Critical CSS) -->
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #f9fafb; }
        
        #app-init-screen {
            position: fixed;
            inset: 0;
            background-color: #ffffff;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease-out, visibility 0.5s;
        }

        #app-init-screen.fade-out {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .init-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            text-align: center;
        }

        .init-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(99, 102, 241, 0.1);
            border-top-color: #6366F1;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 24px;
        }

        .init-text {
            color: #4b5563;
            font-size: 15px;
            font-weight: 500;
            letter-spacing: 0.02em;
            animation: pulse 2s infinite ease-in-out;
        }

        #app-main {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }
        
        #app-main.visible {
            display: block;
            opacity: 1;
        }

        @keyframes slide-up { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scale-in { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes pulse-soft { 0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.2); } 70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); } 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); } }
        @keyframes bounce-slow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        .animate-slide-up { animation: slide-up 0.3s ease-out; }
        .animate-fade-in { animation: fade-in 0.2s ease-out; }
        .animate-scale-in { animation: scale-in 0.2s ease-out; }
        .animate-pulse-soft { animation: pulse-soft 2s infinite; }
        .animate-bounce-slow { animation: bounce-slow 2s infinite ease-in-out; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .primary-gradient { background: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%); }
        .bg-gradient-psych { background: linear-gradient(135deg, #F5F3FF 0%, #EEF2FF 100%); border: 1px solid #E0E7FF; }
        .card-gradient-1 { background: linear-gradient(135deg, #F5F3FF 0%, #EEF2FF 100%); }
        .card-gradient-2 { background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%); }
        .card-gradient-done { background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%); }
        .logo-gradient { background: linear-gradient(135deg, #818CF8 0%, #4F46E5 100%); }

        .goal-tag { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 999px; font-size: 11px; font-weight: 700; letter-spacing: 0.05em; color: white; box-shadow: 0 2px 6px rgba(0,0,0,0.08); transform: translateY(-1px); }
        .tag-purple { background: linear-gradient(135deg, #a78bfa 0%, #818cf8 100%); }
        .tag-blue { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); }
        .tag-cyan { background: linear-gradient(135deg, #22d3ee 0%, #06b6d4 100%); }
        .tag-green { background: linear-gradient(135deg, #34d399 0%, #10b981 100%); }
        .tag-orange { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
        .tag-gray { background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%); }

        .progress-track { background-color: rgba(255,255,255,0.6); border-radius: 9999px; height: 14px; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.8); }
        .progress-jelly { height: 100%; border-radius: 9999px; background: linear-gradient(90deg, #7c3aed 0%, #4f46e5 100%); position: relative; transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .progress-jelly::after { content: ''; position: absolute; right: 2px; top: 50%; transform: translateY(-50%); width: 6px; height: 6px; background: white; border-radius: 50%; opacity: 0.8; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .progress-jelly.done { background: linear-gradient(90deg, #10B981 0%, #059669 100%); }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #ffffff; border: 2px solid #6366F1; cursor: pointer; box-shadow: 0 2px 6px rgba(99, 102, 241, 0.3); margin-top: -10px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #E0E7FF; border-radius: 999px; }

        .mood-icon { transition: all 0.2s; filter: grayscale(100%); opacity: 0.5; transform: scale(0.9); }
        .mood-icon.selected { transform: scale(1.15); filter: grayscale(0%); opacity: 1; }

        .spinner { border: 2px solid rgba(0,0,0,0.1); border-top-color: #6366F1; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        .timeline-line { position: absolute; left: 6px; top: 12px; bottom: -20px; width: 2px; background-color: #e2e8f0; z-index: 0; }
        .group:last-child .timeline-line { display: none; }
        
        .badge-journal { background-color: #eff6ff; color: #3b82f6; border: 1px solid #dbeafe; }
        .badge-conf { background-color: #f5f3ff; color: #8b5cf6; border: 1px solid #ede9fe; }
        .badge-project { background-color: #ecfdf5; color: #10b981; border: 1px solid #d1fae5; }
        .badge-grant { background-color: #fff7ed; color: #f97316; border: 1px solid #ffedd5; }
        .badge-book { background-color: #fff1f2; color: #be123c; border: 1px solid #ffe4e6; }
        .badge-other { background-color: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; }
        
        .milestones-scroll::-webkit-scrollbar { width: 4px; }
        .milestones-scroll::-webkit-scrollbar-track { background: transparent; }
        .milestones-scroll::-webkit-scrollbar-thumb { background-color: #e2e8f0; border-radius: 20px; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { display: flex; align-items: center; justify-content: center; height: 36px; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.2s; }
        .calendar-day:hover { background-color: #f3f4f6; }
        
        .calendar-day.selected { background-color: #4f46e5; color: white; font-weight: bold; border-radius: 50%; }
        .calendar-day.temp-selected { background-color: #6366f1; color: white; font-weight: bold; border-radius: 50%; box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4); }
        .calendar-day.today { border: 1px solid #6366f1; color: #6366f1; border-radius: 50%; }
        .calendar-day.today.selected, .calendar-day.today.temp-selected { border: 2px solid white; }
        
        .calendar-day.empty { pointer-events: none; }
        .calendar-day.disabled { opacity: 0.3; pointer-events: none; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 selection:bg-indigo-100 min-h-screen">

    <!-- ÂÖ®Êñ∞ÂàùÂßãÂåñÂä†ËΩΩÂ±Ç -->
    <div id="app-init-screen">
        <div class="init-wrapper">
            <div class="init-spinner"></div>
            <p class="init-text">Á¨¨‰∏ÄÊ¨°ÊâìÂºÄ PhD FlowÔºåÊ≠£Âú®‰∏∫‰Ω†Êï¥ÁêÜÂÜô‰Ωú‰π¶Ê°å‚Ä¶</p>
        </div>
    </div>

    <!-- Â∫îÁî®‰∏ªÂÆπÂô® (ÂàùÂßãÂåñÂÆåÊàêÂêéÊòæÁ§∫) -->
    <div id="app-main">
        <!-- ÂéüÂ∫îÁî®ÊåÇËΩΩÁÇπ -->
        <div id="app" class="max-w-md mx-auto min-h-screen bg-gray-50 shadow-2xl overflow-hidden relative flex flex-col">
            <!-- ÂÜÖÂÆπÁî± JS ÁîüÊàê -->
        </div>
        
        <!-- ÊñáÁ´†ËäÇÁÇπÁöÑÊó•ÂéÜÊåÇËΩΩÁÇπ -->
        <div id="calendar-mount" class="relative z-[100]"></div>
        
        <!-- ‰∏ªÊó•ÂéÜÊåÇËΩΩÁÇπ -->
        <div id="main-calendar-mount" class="relative z-[100]"></div>
    </div>

    <!-- ÂÖ≥ÈîÆËÑöÊú¨ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Ê†∏ÂøÉÈÄªËæë -->
    <script>
        // --- Ê†∏ÂøÉÈÖçÁΩÆ ---
        const TODAY_OBJ = new Date();
        const YEAR_RANGE = 20;
        const MIN_DATE = new Date(TODAY_OBJ.getFullYear() - YEAR_RANGE, 0, 1);
        const MAX_DATE = new Date(TODAY_OBJ.getFullYear() + YEAR_RANGE, 11, 31);

        function formatDateToInput(d) {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }
        
        const MAX_FUTURE_DATE_STR = formatDateToInput(MAX_DATE);

        // --- ÂøÉÁêÜËÉΩÈáèÁ´ôÊñáÊ°àÂàóË°® ---
        const psychQuotes = [
            "‰ªäÂ§©ÂÜôÁöÑÊØè‰∏Ä‰∏™Â≠óÔºåÈÉΩ‰ºöÂú®Êú™Êù•‰∏∫‰Ω†ÂèëÂÖâ ‚ú®",
            "‰∏çÂøÖ‰∏Ä‰∏ãÂ≠êÂÜôÂÆå‰∏ÄÁ´†ÔºåÂè™Ë¶Å‰ªäÂ§©ÊØîÊò®Â§©Â§ö‰∏ÄÁÇπÁÇπÂ∞±Â•Ω„ÄÇ",
            "‰∏ÄÁØáËÆ∫ÊñáÁöÑËØûÁîüÔºåÂ∞±ÊòØÊó†Êï∞Ê¨°Â∞è‰øÆÊîπÂè†Âä†Âá∫Êù•ÁöÑÂ•áËøπ üå±",
            "ÊãíÁ®øÂè™ÊòØË∑ØÁ∫ø‰∏äÁöÑ‰∏Ä‰∏™ÂºØÈÅìÔºå‰∏çÊòØÁªàÁÇπ üèÉ‚Äç‚ôÄÔ∏è",
            "‰Ω†ÂÜô‰∏ãÁöÑÊØè‰∏Ä‰∏™Â≠óÔºåÈÉΩÊòØÂú®‰∏∫Êú™Êù•ÁöÑËá™Â∑±Èì∫Ë∑Ø„ÄÇ",
            "ËØÑËÅåÁß∞ÊòØ‰∏ÄÈòµÈ£éÔºå‰Ω†ÁöÑÊàêÈïøÊòØÈïø‰πÖÁöÑÂ∫ïÊ∞î üí®",
            "Â≠¶ÊúØÊòØ‰∏ÄÂú∫È©¨ÊãâÊùæÔºåÂÖÅËÆ∏Ëá™Â∑±ÂÅ∂Â∞îÂÅú‰∏ãÊù•Á≥ªÈûãÂ∏¶ üëü",
            "‰∏çË¶ÅÂÆ≥ÊÄïÂàùÁ®øÁöÑÁ≤óÁ≥ôÔºåÈÇ£ÊòØÁ≤æÈõïÁªÜÁê¢ÁöÑÂéüÊùêÊñô üíé",
            "ÊØè‰∏Ä‰∏™Ëß£ÂÜ≥ÁöÑÂ∞èbugÔºåÈÉΩÊòØÈÄöÂæÄÂ≠¶‰ΩçÁöÑÂùöÂÆûÂè∞Èò∂„ÄÇ",
            "Ê≤°Êúâ‰ªÄ‰πàÁôΩËµ∞ÁöÑË∑ØÔºåËøô‰∏ÄÂàªÁöÑËø∑Ëå´‰πüÊòØÊé¢Á¥¢ÁöÑ‰∏ÄÈÉ®ÂàÜ üó∫Ô∏è",
            "ÂÆ°Á®ø‰∫∫ÁöÑÊÑèËßÅËôΩÁÑ∂Â∞ñÈîêÔºå‰ΩÜËÉΩËÆ©‰Ω†ÁöÑÈÄªËæëÈì†Áî≤Êõ¥ÂùöÂõ∫ üõ°Ô∏è",
            "È°πÁõÆÁî≥ËØ∑‰π¶ÁöÑÊØè‰∏ÄÊ¨°ÊâìÁ£®ÔºåÈÉΩÂú®ËÆ©‰Ω†ÂØπÁ†îÁ©∂ÈóÆÈ¢òÁúãÂæóÊõ¥Ê∏Ö üí°",
            "‰ªäÂ§©‰∏çÊÉ≥ÂÜô‰πüÊ≤°ÂÖ≥Á≥ªÔºåÂ§ßËÑëÂú®ÂêéÂè∞ÊÇÑÊÇÑÊï¥ÁêÜÊÄùË∑ØÂë¢ üß†",
            "‰Ω†ÁöÑ‰ª∑ÂÄº‰∏çÂè™ÊòØ‰∏ÄÂº†ÂΩïÁî®ÈÄöÁü•ÔºåËÄåÂú®‰∫éÊé¢Á¥¢Êú™Áü•ÁöÑÂãáÊ∞î ü¶Å",
            "Âú®Ëøô‰∏™ÁªÜÂàÜÈ¢ÜÂüüÔºå‰Ω†Â∞±ÊòØÊúÄÊùÉÂ®ÅÁöÑÂ£∞Èü≥ÔºåÁõ∏‰ø°Ëá™Â∑± üé§",
            "Êó†ËÆ∫Â§öÊÖ¢ÔºåÂè™Ë¶ÅÂú®Ëµ∞ÔºåÂ∞±ÊòØÂú®Èù†ËøëÁªàÁÇπ üê¢",
            "Âì™ÊÄïÂè™ÊîπÂ•Ω‰∫Ü‰∏Ä‰∏™ÂõæË°®Ôºå‰ªäÂ§©‰πüÊòØÊúâ‰∫ßÂá∫ÁöÑ‰∏ÄÂ§© üìä",
            "‰∏çË¶ÅÂíåÂà´‰∫∫ÁöÑÈ´òÂÖâÊó∂ÂàªÂØπÊØîÔºå‰∏ìÊ≥®Ëá™Â∑±ÁöÑÊØè‰∏ÄÊ≠•ËÑöÂç∞ üë£",
            "‰ºëÊÅØ‰∏çÊòØÂÅ∑ÊáíÔºåÊòØ‰∏∫‰∫ÜËÆ©ÁÅµÊÑüÊúâÁ©∫ÈöôÈíªËøõÊù• ‚òï",
            "‰Ω†Ê≠£Âú®Êê≠Âª∫‰∫∫Á±ªÁü•ËØÜËæπÁïåÁöÑ‰∏ÄÂùóÂ∞èÁßØÊú®ÔºåËøôÂæà‰∫Ü‰∏çËµ∑ üß±",
            "Ëøî‰øÆËôΩÁÑ∂ÁóõËã¶Ôºå‰ΩÜÈÇ£ÊòØËÆ∫ÊñáËúïÂèòÊàêËù∂ÁöÑÂøÖÁªèÈòµÁóõ ü¶ã",
            "ÊääÂ§ßÁõÆÊ†áÊãÜÊàêÂ∞è‰ªªÂä°ÔºåÂêû‰∏ãËøôÂè™Âêç‰∏∫'ËÆ∫Êñá'ÁöÑÂ§ßË±° üêò",
            "ÊúâÊó∂ÂÄôÔºå'ÂÆåÊàê'ÊØî'ÂÆåÁæé'Êõ¥ÈáçË¶ÅÔºåÂÖàËÆ©ÂÆÉÂ≠òÂú® ‚úÖ",
            "ÂÖ≥‰∏äÁîµËÑëÂéªÊï£Ê≠•ÂêßÔºåÂ•ΩÁÇπÂ≠êÂæÄÂæÄÂú®Ë∑Ø‰∏äÁ≠â‰Ω† üå≥",
            "ÁßëÁ†îÂæàËã¶Ôºå‰ΩÜÊé¢Á¥¢ÁúüÁêÜÁöÑËøáÁ®ãÂæàÈÖ∑ üòé",
            "ÂÖÅËÆ∏Ëá™Â∑±Êúâ‰ΩéË∞∑ÊúüÔºåÈÇ£ÊòØËµ∑Ë∑≥ÂâçÁöÑÊ∑±Ëπ≤ üìâ",
            "‰Ω†‰∏çÊòØÂ≠§ÂÜõÂ•ãÊàòÔºåÊó†Êï∞Ââç‰∫∫‰πüÊõæÂú®Ëøô‰∏™Ë∑ØÂè£ÂæòÂæä ü§ù",
            "ÊâÄÊúâÁöÑÁÑ¶ËôëÈÉΩÊ∫ê‰∫éÊÉ≥ÂæóÂ§™Â§öËÄåÂÅöÂæóÂ§™Â∞ëÔºåËØïÁùÄÂÜô‰∏ãÁ¨¨‰∏ÄÂè• üìù",
            "‰π¶Á®øÁöÑÂéöÂ∫¶ÔºåÊòØ‰Ω†ÊÄùÊÉ≥Ê∑±Â∫¶ÁöÑÁâ©ÁêÜÂàªÂ∫¶ üìè",
            "Ë¢´ÊãíÁ®ø‰∏ç‰ª£Ë°®‰Ω†‰∏çË°åÔºåÂè™ÊòØÁºòÂàÜÊú™Âà∞ÔºåÊç¢‰∏™ÊúüÂàäËØïËØï üíå",
            "ËÅåÁß∞ËØÑÂÆöÂè™ÊòØÂ§ñÈÉ®ËØÑ‰ª∑ÔºåÂÜÖÂøÉÁöÑÂ≠¶ÊúØÁÅ´ÁÑ∞Áî±‰Ω†Ëá™Â∑±ÊéåÊéß üî•",
            "‰øùÊåÅÂ•ΩÂ•áÂøÉÔºåÂÆÉÊòØÂ∏¶‰Ω†Ëµ∞Âá∫Áì∂È¢àÊúüÊúÄÂ•ΩÁöÑÂêëÂØº üß≠",
            "‰ªäÂ§©‰πüÊòØÂä™ÂäõÁöÑ‰∏ÄÂ§©ÔºåÁªôËá™Â∑±‰∏Ä‰∏™Â∞èÂ∞èÁöÑÂ•ñÂä±Âêß üç¨",
            "ÊñáÁåÆÁúã‰∏çÂÆåÊ≤°ÂÖ≥Á≥ªÔºåÊäì‰ΩèÊ†∏ÂøÉËÑâÁªúÂ∞±ÊòØËÉúÂà© üìñ",
            "‰Ω†ÁöÑÁ†îÁ©∂ÊàñËÆ∏ÊöÇÊó∂Êó†‰∫∫ÂñùÂΩ©Ôºå‰ΩÜÊó∂Èó¥‰ºöËØÅÊòéÂÆÉÁöÑ‰ª∑ÂÄº ‚è≥",
            "‰∏çË¶ÅËÆ©'ÂÜíÂÖÖËÄÖÁªºÂêàÂæÅ'ÊâìË¥•‰Ω†Ôºå‰Ω†ÂÄºÂæóÁé∞Âú®ÁöÑ‰ΩçÁΩÆ üëë",
            "ÊØè‰∏Ä‰∏™Ê∑±Â§úÁöÑÂùöÊåÅÔºåÈÉΩÂú®ÊääÊ¢¶ÊÉ≥ÂèòÊàêÁé∞ÂÆû üåô",
            "ÂÆûÈ™åÂ§±Ë¥•‰∫ÜÔºüÈÇ£ÊòØÊéíÈô§‰∫Ü‰∏Ä‰∏™ÈîôËØØÁ≠îÊ°àÔºå‰πüÊòØËøõÂ±ï üß™",
            "ÂÜô‰∏çÂá∫Êù•ÁöÑÊó∂ÂÄôÔºåËØïÁùÄÂéªËØªËØªÁªèÂÖ∏ÔºåÊâæÊâæËØ≠ÊÑü üìö",
            "‰øùÊåÅÈòÖËØªÔºå‰øùÊåÅÊÄùËÄÉÔºå‰øùÊåÅËæìÂá∫Ôºå‰øùÊåÅÁÉ≠Áà± ‚ù§Ô∏è",
            "Â≠¶ÊúØÂúàÂæàÂ∞èÔºå‰ΩÜ‰∏ñÁïåÂæàÂ§ßÔºåÂà´ÊääÁúºÂâçÁöÑÂõ∞ÈöæÂΩìÊàêÂÖ®ÈÉ® üåç",
            "‰Ω†ÁöÑÂä™ÂäõÔºåËóèÂú®ÊØè‰∏ÄË°åÂèÇËÄÉÊñáÁåÆÂíåÊØè‰∏Ä‰∏™ËÑöÊ≥®Èáå üìë",
            "Âà´Âøò‰∫ÜÔºå‰Ω†ÂΩìÂàù‰∏∫‰ªÄ‰πàÂá∫ÂèëÔºåÂàùÂøÉÊòØÊúÄÂ•ΩÁöÑÁáÉÊñô ‚õΩ",
            "Âì™ÊÄïÊòØÁà¨ÔºåÂè™Ë¶ÅÊñπÂêëÂØπÔºå‰πüËÉΩÂà∞ËææÂ±±È°∂ üèîÔ∏è",
            "ÁªôËá™Â∑±‰∏ÄÁÇπËÄêÂøÉÔºåÂ•Ω‰∏úË•øÈÉΩÈúÄË¶ÅÊó∂Èó¥ÂéªÈÖùÈÖø üç∑",
            "‰ªäÂ§©ÁöÑ‰Ω†ÔºåÊØîÂàöÂÖ•Â≠¶ÁöÑ‰Ω†ÔºåÂ∑≤ÁªèÂº∫Â§ß‰∫ÜÂ§™Â§ö üí™",
            "‰∏çË¶Å‰∏∫‰∫ÜÂèëË°®ËÄåÂèëË°®Ôºå‰∏∫‰∫ÜÁúüÁêÜËÄåÂÜô‰Ωú ‚úíÔ∏è",
            "ÊääÂøÉÊÉÖÁÖßÈ°æÂ•ΩÔºå‰πüÊòØÁßëÁ†îÂ∑•‰ΩúÁöÑ‰∏ÄÈÉ®ÂàÜ üíÜ",
            "ÊØè‰∏Ä‰∏™ÂºïÁî®ÔºåÈÉΩÊòØ‰Ω†‰∏éÂ≠¶ÊúØÂÖ±Âêå‰ΩìÁöÑ‰∏ÄÊ¨°Êè°Êâã ü§ù",
            "Áõ∏‰ø°Â§çÂà©ÁöÑÂäõÈáèÔºåÊØèÂ§©Âá†ÁôæÂ≠óÔºå‰∏ÄÂπ¥Â∞±ÊòØ‰∏ÄÊú¨‰π¶ üìà",
            "‰∏çÁî®Êó∂ÂàªÁ¥ßÁª∑ÔºåÊùæÂºõÊÑüËÉΩÂ∏Æ‰Ω†Ë∑ëÂæóÊõ¥Ëøú üçÉ",
            "‰Ω†ÁöÑÁ†îÁ©∂ÊúâÁã¨ÁâπÁöÑÊÑè‰πâÔºåÊ≤°‰∫∫ËÉΩÊõø‰ª£‰Ω†ÁöÑËßÜËßí üî≠",
            "Ëøô‰πüÊòØ‰∏ÄÁßçÁîüÊ¥ªÔºåÂú®Âπ≥Ê∑°‰∏≠ÂØªÊâæÂèëÁé∞ÁöÑ‰πêË∂£ üîç",
            "ÈÅáÂà∞Áì∂È¢àÊó∂Ôºå‰∏çÂ¶®ÂõûÂ§¥ÁúãÁúãÂ∑≤ÁªèËµ∞ËøáÁöÑË∑Ø üîô",
            "ÂÜôËÆ∫ÊñáÂÉèÂª∫ÊàøÂ≠êÔºå‰ªäÂ§©Êàë‰ª¨Âè™Ë¥üË¥£Êê¨‰∏ÄÂùóÁ†ñ üèóÔ∏è",
            "‰∏çË¶ÅÂõ†‰∏∫Âà´‰∫∫ÁöÑ‰ºòÁßÄËÄåÂê¶ÂÆöËá™Â∑±ÔºåËä±Êúü‰∏çÂêåËÄåÂ∑≤ üå∫",
            "Â≠¶ÊúØËá™Áî±ÊòØÊúÄÂ§ßÁöÑÂ•¢‰æàÂìÅÔºå‰∫´ÂèóËøôÊÆµÁ∫ØÁ≤πÁöÑÊó∂ÂÖâ üï∞Ô∏è",
            "Âç≥‰ΩøÊòØÊúÄ‰ºüÂ§ßÁöÑÂ≠¶ËÄÖÔºå‰πüÊõæÈù¢ÂØπËøáÁ©∫ÁôΩÊñáÊ°£ÂèëÂëÜ üìÑ",
            "Êé•Âèó‰∏çÂÆåÁæéÁöÑÂàùÁ®øÔºåÂÆÉÊòØÈÄöÂêëÂÆåÁæéÁöÑÂîØ‰∏ÄÊ°•Ê¢Å üåâ",
            "‰Ω†Ê≠£Âú®ÂÅöÁöÑ‰∫ãÊÉÖÂæàÈöæÔºåÊâÄ‰ª•ÊÑüÂà∞Âõ∞ÈöæÊòØÊ≠£Â∏∏ÁöÑ üßó",
            "Áé∞Âú®ÁöÑÁÑ¶ËôëÔºåÂçÅÂπ¥ÂêéÂÜçÁúãÔºåÂèØËÉΩÂè™ÊòØËå∂‰ΩôÈ•≠ÂêéÁöÑË∞àËµÑ üçµ",
            "‰∏ìÊ≥®ÂΩì‰∏ãÔºåÊú™Êù•Ëá™ÁÑ∂‰ºöÊù• üéÅ",
            "Âà´ËÆ© deadline Êàê‰∏∫ÊÅêÊÖåÁöÑÊ∫êÂ§¥ÔºåÊääÂÆÉÂΩìÊàêË°åÂä®ÁöÑÂè∑Ëßí üé∫",
            "‰Ω†ÁöÑÊØè‰∏ÄÊ¨°ÊÄùËÄÉÔºåÈÉΩÂú®ÊãìÂ±ï‰∫∫Á±ªËÆ§Áü•ÁöÑËæπÁïå üåå",
            "Á¥Ø‰∫ÜÂ∞±Áù°ËßâÔºåÈÜí‰∫ÜÂÜçÊàòÊñóÔºåË∫´‰ΩìÊòØÁßëÁ†îÁöÑÊú¨Èí± üõå",
            "‰∏çË¶ÅÊääËá™Êàë‰ª∑ÂÄºÂÆåÂÖ®ÁªëÂÆöÂú®‰∫ßÂá∫‰∏äÔºå‰Ω†Êú¨Ë∫´Â∞±ÂæàÁèçË¥µ ‚ú®",
            "ÊÖ¢ÊÖ¢Êù•ÔºåÊØîËæÉÂø´ üö≤",
            "ÊµÅÊ∞¥‰∏ç‰∫âÂÖàÔºå‰∫âÁöÑÊòØÊªîÊªî‰∏çÁªù üåä",
            "Âú®Ëøô‰∏™ÊµÆË∫ÅÁöÑ‰∏ñÁïåÈáåÔºåÂÆâÈùôÂú∞ÂÅöÂ≠¶ÈóÆÊòØ‰∏ÄÁßç‰øÆË°å üßò",
            "ÊØè‰∏ÄÊ¨°‰øÆÊîπÔºåÈÉΩÂú®ËÆ©‰Ω†ÁöÑËßÇÁÇπÊõ¥ÁäÄÂà©ÔºåÈÄªËæëÊõ¥‰∏•ÂØÜ üî™",
            "‰∏çË¶ÅÈ¢ÑÊîØÊòéÂ§©ÁöÑÁÉ¶ÊÅºÔºåËøáÂ•Ω‰ªäÂ§©ÁöÑÁßëÁ†îÁîüÊ¥ª üìÖ",
            "‰Ω†ÊòØÂú®‰∏∫‰∫∫Á±ªÁöÑÁü•ËØÜÂ∫ìÊ∑ªÁ†ñÂä†Áì¶ÔºåËøôÂæàÁ•ûÂú£ üèõÔ∏è",
            "Âì™ÊÄïÂè™ÊòØÂéòÊ∏Ö‰∫Ü‰∏Ä‰∏™Â∞èÊ¶ÇÂøµÔºå‰πüÊòØÂÄºÂæóÂ∫ÜÁ•ùÁöÑËøõÊ≠• üéâ",
            "‰øùÊåÅËäÇÂ•èÔºå‰∏çË¶ÅÂÜ≤Âà∫ÔºåËøôÊòØ‰∏ÄÂú∫ÊåÅ‰πÖÊàò ‚öîÔ∏è",
            "‰Ω†ÁöÑÊØè‰∏Ä‰ªΩÂä™ÂäõÔºåÈÉΩ‰∏ç‰ºöË¢´ËæúË¥üÔºåÂì™ÊÄï‰ª•ÊÑèÊÉ≥‰∏çÂà∞ÁöÑÊñπÂºè üéÅ",
            "ÂÅö‰∏Ä‰∏™Âø´‰πêÁöÑÁßëÁ†î‰∫∫ÔºåÊØîÂÅö‰∏Ä‰∏™È´ò‰∫ßÁöÑÊú∫Âô®Êõ¥ÈáçË¶Å üòä",
            "‰ªäÂ§©Èò≥ÂÖâÂæàÂ•ΩÔºåÈÄÇÂêàÂÜôÂá∫Ê∏©ÊöñÁöÑÊñáÂ≠ó ‚òÄÔ∏è",
            "ÊääÂ§ß‰ªªÂä°ÂàáÁ¢éÔºåÂàáÂà∞Ëá™Â∑±ÊÑøÊÑèÂä®ÊâãÁöÑÁ®ãÂ∫¶ üç∞",
            "‰∏çË¶ÅÁ≠âÂà∞‰∏á‰∫ã‰ø±Â§áÊâçÂºÄÂßãÔºåÂºÄÂßãÊú¨Ë∫´Â∞±ÊòØ‰∏ÄÁßçÂáÜÂ§á üöÄ",
            "‰Ω†ÁöÑËÆ∫ÊñáÊ≠£Âú®ÊàêÈïøÁöÑË∑Ø‰∏äÔºåÁªôÂÆÉ‰∏ÄÁÇπÊó∂Èó¥ üå±",
            "Áõ∏‰ø°ËøáÁ®ãÔºåÁªìÊûú‰ºöËá™ÁÑ∂ÂèëÁîü üåà",
            "Âè™Ë¶ÅÂú®ÂÜôÔºåÂ∞±ÊúâÂ∏åÊúõ üåü"
        ];

        const encouragementRules = [
            { keywords: ['Èöæ', 'Âç°', '‰∏çÂä®', 'ÁÉ¶', '‰π±'], msg: "Êä±Êä±‰Ω† („Å•ÔΩ°‚óï‚Äø‚Äø‚óïÔΩ°)„Å• ÂÖÅËÆ∏Ëá™Â∑±Âç°È°øÔºåÊòéÂ§©ÂèàÊòØÊñ∞ÁöÑ‰∏ÄÂ§©„ÄÇ" },
            { keywords: ['Á¥Ø', 'Âõ∞', '‰πè', 'ÂÄ¶'], msg: "ËæõËã¶Âï¶ÔºÅÂ§ßËÑëÈ´òË¥üËç∑ËøêËΩ¨Ëøô‰πà‰πÖÔºåÂø´ÂéªÂêÉÁÇπÂ•ΩÂêÉÁöÑÁäíÂä≥‰∏Ä‰∏ãËá™Â∑±ÔºÅüçµ" },
            { keywords: ['ÂºÄÂøÉ', 'È°∫', 'Ê£í', 'ÁàΩ', 'Âø´'], msg: "Â§™Ê£í‰∫ÜÔºÅËøôÁßçÂøÉÊµÅÁä∂ÊÄÅÁÆÄÁõ¥ÊòØÂ≠¶ÊúØÁïåÁöÑÈ°∂Á∫ß‰∫´ÂèóÔºÅüéâ" },
            { keywords: ['Âπ≥', 'Á®≥', 'Ë°å'], msg: "Âπ≥Á®≥Â∞±ÊòØËÉúÂà©Ôºå‰øùÊåÅËøô‰∏™ËäÇÂ•èÔºåÁªàÂ∞ÜÊ±áËÅöÊàêÊ≤≥„ÄÇüíß" }
        ];

        const comfortMessages = {
            tired: ["ËæõËã¶Âï¶ÔºÅ‰ºëÊÅØÊòØ‰∏∫‰∫ÜÊõ¥Â•ΩÁöÑÈáçÂêØ„ÄÇÊë∏Êë∏Â§¥ÔºåÂø´ÂéªÂÖÖÁîµÂêßÔºÅüîã"],
            sad: ["Êä±Êä±‰Ω†ÔºåÂÜô‰∏çÂá∫Êù•‰πüÊ≤°ÂÖ≥Á≥ªÔºåÁÅµÊÑüÊ≠£Âú®Ëµ∂Êù•ÁöÑË∑Ø‰∏ä„ÄÇ"],
            neutral: ["Âπ≥Á®≥Â∞±ÊòØËÉúÂà©ÔºåÊØè‰∏ÄÂ§©ÂæÆÂ∞èÁöÑÁßØÁ¥ØÔºåÁªàÂ∞ÜÊ±áËÅöÊàêÊ≤≥„ÄÇ"],
            happy: ["Â§™Ê£í‰∫ÜÔºÅËÆ∞‰ΩèËøôÁßçÊàêÂ∞±ÊÑüÔºåÂÆÉÊòØ‰Ω†ÂâçË°åÁöÑÁáÉÊñô„ÄÇüéâ"]
        };

        const autoReflections = {
            happy: ["‰ªäÂ§©Áä∂ÊÄÅÁ•ûÂãáÔºåÈîÆÁõòÈÉΩË¶ÅÂÜíÁÅ´Êòü‰∫ÜÔºÅüî•", "ÊÄùË∑ØÊ∏ÖÊô∞ÔºåÂÜôËµ∑Êù•È°∫È£éÈ°∫Ê∞¥ÔºåÂºÄÂøÉÔºÅüëç"],
            neutral: ["Âπ≥Âπ≥Ê∑°Ê∑°ÊâçÊòØÁúüÔºåÊåâÈÉ®Â∞±Áè≠ÂÆåÊàê‰ªªÂä°„ÄÇ", "ËøõÂ∫¶Êù°ÁºìÊÖ¢‰ΩÜÂùöÂÆöÂú∞ÁßªÂä®‰∏≠„ÄÇ"],
            sad: ["‰ªäÂ§©ÊúâÁÇπËâ∞ÈöæÔºå‰ΩÜËá≥Â∞ëÊàëÂùöÊåÅ‰∏ãÊù•‰∫Ü„ÄÇ", "ÂøÉÊÉÖÊúâÁÇπ‰ΩéËêΩÔºåÊàñËÆ∏ÊòØËØ•Êç¢‰∏™ÊÄùË∑Ø‰∫Ü„ÄÇ"],
            tired: ["ËÑëÁªÜËÉûÂ∑≤ËÄóÂ∞ΩÔºåÊÄ•ÈúÄÂÖÖÁîµÔºÅüîã", "ÂÆûÂú®ÊòØÂ§™Âõ∞‰∫ÜÔºåÂÖàËãü‰ΩèÔºåÊòéÂ§©ÂÜçÊàòÔºÅüí§"]
        };
        
        // --- Ê†∏ÂøÉÈÖçÁΩÆÔºöÊñáÁ´†Á±ªÂûã„ÄÅÊé®ËçêËäÇÁÇπ„ÄÅÊèêÁ§∫ËØ≠ ---
        const ARTICLE_CONFIG = {
            'ÊúüÂàäËÆ∫Êñá': {
                titlePlaceholder: '‰æãÂ¶ÇÔºöÂÖ≥‰∫é XX ÁöÑÂÆûËØÅÁ†îÁ©∂',
                journalLabel: 'ÊúüÂàä/‰ºöËÆÆÂêçÁß∞',
                journalPlaceholder: '‰æãÂ¶ÇÔºöJournal of Finance',
                stages: ['ÂàùÁ®øÂáÜÂ§á', 'Â∑≤ÊäïÁ®ø', 'ÂÆ°Á®ø‰∏≠', '‰∏ÄÂÆ°ËøîÂõû', 'Ëøî‰øÆ‰∏≠', '‰∫åÂÆ°‰∏≠', 'Â∑≤Êé•Êî∂', 'Âú®Á∫øÂèëË°®', 'Á∫∏ÂàäËßÅÂàä'],
                milestones: ['ÂÆåÊàêÂàùÁ®ø', 'ÊäïÁ®ø', 'ÂÆ°Á®ø‰∏≠', '‰∏ÄÂÆ°ËøîÂõû', 'Ëøî‰øÆÊèê‰∫§', '‰∫åÂÆ°ËøîÂõû', 'ÂÜçÊ¨°Ëøî‰øÆÊèê‰∫§', 'Êé•ÂèóÈÄöÁü•', 'Âú®Á∫øÂèëË°®', 'Á∫∏ÂàäËßÅÂàä']
            },
            '‰ºöËÆÆËÆ∫Êñá': {
                titlePlaceholder: '‰æãÂ¶ÇÔºöÊ∑±Â∫¶Â≠¶‰π†‰ºòÂåñÁÆóÊ≥ïÁ†îÁ©∂',
                journalLabel: '‰ºöËÆÆÂêçÁß∞',
                journalPlaceholder: '‰æãÂ¶ÇÔºöICML 2025',
                stages: ['ÂàùÁ®øÂáÜÂ§á', 'Â∑≤ÊäïÁ®ø', 'ÂÆ°Á®ø‰∏≠', 'ÂΩïÁî®ÈÄöÁü•', 'ÁªàÁ®øÊèê‰∫§', 'Ê≥®ÂÜåÂèÇ‰ºö', 'Ê±áÊä•ÂÆåÊàê'],
                milestones: ['ÂÆåÊàêÂàùÁ®ø', 'ÊäïÁ®ø', 'ÂÆ°Á®ø‰∏≠', 'ÂΩïÁî®ÈÄöÁü•', 'ÁªàÁ®øÊèê‰∫§', 'Ê≥®ÂÜåÂèÇ‰ºö', '‰ºöËÆÆÊä•ÂëäÂÆåÊàê']
            },
            'È°πÁõÆ': {
                titlePlaceholder: '‰æãÂ¶ÇÔºöXX Âü∫ÈáëÈùíÂπ¥È°πÁõÆ',
                journalLabel: 'Áî≥Êä•Âçï‰Ωç/Êù•Ê∫ê',
                journalPlaceholder: '‰æãÂ¶ÇÔºöÂõΩÂÆ∂Ëá™ÁÑ∂ÁßëÂ≠¶Âü∫ÈáëÂßî',
                stages: ['Á´ãÈ°πÁî≥Êä•‰∏≠', 'ËØÑÂÆ°‰∏≠', 'Â∑≤Á´ãÈ°π', '‰∏≠ÊúüÊ£ÄÊü•', 'È™åÊî∂/ÁªìÈ¢ò‰∏≠', 'Â∑≤ÁªìÈ¢ò'],
                milestones: ['Á´ãÈ°πÁî≥Êä•ÊùêÊñôÂÆåÊàê', 'Êèê‰∫§Á´ãÈ°πÁî≥ËØ∑', 'Á´ãÈ°πËØÑÂÆ°', 'Á´ãÈ°πËé∑Êâπ', 'ÁªèË¥πÂà∞Ë¥¶', '‰∏≠ÊúüÊ£ÄÊü•ËµÑÊñôÊèê‰∫§', '‰∏≠ÊúüÊ£ÄÊü•ÈÄöËøá', 'ÁªìÈ¢òÊùêÊñôÊèê‰∫§', 'ÁªìÈ¢òÈÄöËøá']
            },
            'ËØæÈ¢ò': {
                titlePlaceholder: '‰æãÂ¶ÇÔºöÂçöÂ£´Â≠¶‰ΩçËÆ∫ÊñáËØæÈ¢ò',
                journalLabel: 'ËØæÈ¢òÊù•Ê∫ê',
                journalPlaceholder: '‰æãÂ¶ÇÔºöÂØºÂ∏àÊ®™ÂêëËØæÈ¢ò',
                stages: ['ÂºÄÈ¢òÁî≥ËØ∑', 'ÂºÄÈ¢òËÆ∫ËØÅ', '‰∏≠ÊúüÊ£ÄÊü•', 'Èò∂ÊÆµÊàêÊûúÊï¥ÁêÜ', 'ÁªìÈ¢òÁî≥ËØ∑', 'ÁªìÈ¢òÈÄöËøá'],
                milestones: ['ÂºÄÈ¢òÊä•ÂëäÂÆåÊàê', 'ÂºÄÈ¢òËÆ∫ËØÅ', '‰∏≠ÊúüÊ£ÄÊü•', 'Èò∂ÊÆµÊàêÊûúÂΩ¢Êàê', 'ÁªìÈ¢òÊùêÊñôÊèê‰∫§', 'ÁªìÈ¢òÈÄöËøá']
            },
            'Ëëó‰Ωú': {
                titlePlaceholder: '‰æãÂ¶ÇÔºö‰∏≠ÂõΩ‰º†ÁªüÂª∫Á≠ëÁ†îÁ©∂',
                journalLabel: 'Âá∫ÁâàÁ§æ',
                journalPlaceholder: '‰æãÂ¶ÇÔºöÁßëÂ≠¶Âá∫ÁâàÁ§æ',
                stages: ['ÈÄâÈ¢òÁ°ÆÂÆö', 'ÂÜô‰ΩúÊ†∑Á´†', 'Âá∫ÁâàÁ§æÁ´ãÈ°π', 'ÂêàÂêåÁ≠æËÆ¢', 'ÂÖ®Á®øÂÆåÊàê', '‰∏âÂÆ°ÈÄöËøá', 'ÊéíÁâàÊ†°ÂØπ', 'Âá∫ÁâàÂèëË°å'],
                milestones: ['ÈÄâÈ¢òÁ°ÆÂÆö', 'Ê†∑Á´†ÂÆåÊàê', 'Âá∫ÁâàÁ§æÁ´ãÈ°π', 'ÂêàÂêåÁ≠æËÆ¢', 'ÂÖ®Á®ø‰∫§‰ªò', '‰∏âÂÆ°ÈÄöËøá', 'ÊéíÁâàÊ†°ÂØπ', 'Âá∫ÁâàÂèëË°å']
            },
            'ÂÖ∂‰ªñ': {
                titlePlaceholder: '‰æãÂ¶ÇÔºöÂ≠¶ÊúØËÆ≤Â∫ß/Áü≠ÊúüËÆøÂ≠¶',
                journalLabel: 'Áõ∏ÂÖ≥Êú∫ÊûÑ',
                journalPlaceholder: 'Â§áÊ≥®ËØ¥Êòé',
                stages: ['ËÆ°Âàí‰∏≠', 'ËøõË°å‰∏≠', 'ÊöÇÁºì', 'Â∑≤ÂÆåÊàê'],
                milestones: ['Âà∂ÂÆöËÆ°Âàí', 'ÊâßË°å‰∏≠', 'Èò∂ÊÆµÂèçÈ¶à', 'Ë∞ÉÊï¥ÊñπÊ°à', 'ÂÆåÊàê']
            }
        };

        const ARTICLE_TYPES = Object.keys(ARTICLE_CONFIG);

        // --- Áä∂ÊÄÅÁÆ°ÁêÜ ---
        const state = {
            view: 'loading',
            activeTab: 'dashboard', 
            user: null, 
            entries: [],
            dailyPlans: [], 
            customGoals: [],
            articles: [], 
            totalWordGoal: 100000,
            graduationDate: '',
            globalGoalType: 'ÊØï‰∏ö',
            globalGoalName: 'ÊØï‰∏öËÆ∫Êñá',
            currentUserId: null, // Êñ∞Â¢ûÔºöËÆ∞ÂΩïÂΩìÂâçÁî®Êà∑ÁöÑÂîØ‰∏Ä ID
            
            currentSession: null, 
            leaderboard: [],
            loadingLeaderboard: false,
            loginMode: 'login',
            showSidebar: false,
            showFeedback: false,
            feedbackData: {},
            showGoalModal: false,
            editingGoalId: null,
            showPlanModal: false, 
            editingPlanId: null,
            showLogoutModal: false,
            showProfileModal: false,
            showGradSettings: false,
            showArticleModal: false, 
            articleStatusTouched: false, 
            viewDate: new Date().toISOString().split('T')[0],
            dailyQuote: "",
            formData: { 
                date: '', 
                startCount: 0, 
                endCount: 0, 
                mood: 'neutral', 
                reflection: '', 
                linkedGoalId: '', 
                chapter: '', 
                duration: '', 
                durationNum: 0 
            },
            entryDrafts: {}, 
            newGoalData: { name: '', targetQty: 1, unit: 'ÁØá', targetWords: 10000 },
            planFormData: { target: 1000, content: '', linkedGoalId: 'thesis' },
            tempProfile: { name: '', avatar: '' },
            articleFormData: {
                id: null,
                title: '',
                journal: '',
                type: 'ÊúüÂàäËÆ∫Êñá',
                status: '',
                milestones: [], 
                reviewNotes: '',
                notes: ''
            },
            // ÊñáÁ´†ËäÇÁÇπÊó•ÂéÜÁä∂ÊÄÅ
            calendar: {
                visible: false,
                targetIndex: null,
                currentYear: new Date().getFullYear(),
                currentMonth: new Date().getMonth()
            },
            // ‰∏ªÊó•ÂéÜÁä∂ÊÄÅ
            mainCalendar: {
                visible: false,
                viewYear: new Date().getFullYear(),
                viewMonth: new Date().getMonth(),
                selectedDateStr: null 
            }
        };

        // --- ÂÆâÂÖ®ÁöÑÊú¨Âú∞Â≠òÂÇ®Â∞ÅË£Ö ---
        const Storage = {
            get: (key, defaultVal = null) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultVal;
                } catch (e) {
                    return defaultVal;
                }
            },
            set: (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (e) {}
            },
            remove: (key) => {
                try {
                    localStorage.removeItem(key);
                } catch(e) {}
            }
        };

        function parseSafeDate(dateStr) {
            if (!dateStr || typeof dateStr !== 'string') return null;
            const match = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (!match) return null;
            const year = parseInt(match[1], 10);
            const month = parseInt(match[2], 10) - 1;
            const day = parseInt(match[3], 10);
            const date = new Date(year, month, day);
            if (date.getFullYear() !== year || date.getMonth() !== month || date.getDate() !== day) return null;
            return date;
        }

        // --- Ê†∏ÂøÉÔºöÁî®Êà∑Ë¥¶Âè∑ÁÆ°ÁêÜ (ÊîπÂä®ÈÉ®ÂàÜ) ---

        // 1. ÁîüÊàêÁ®≥ÂÆö Hash
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash).toString(16);
        }

        // 2. Ëé∑ÂèñÊâÄÊúâÁî®Êà∑ÁöÑÂ§ßÂØπË±°
        function getUnifiedUsers() {
            return Storage.get('phdflow_users', {});
        }

        function saveUnifiedUsers(users) {
            Storage.set('phdflow_users', users);
        }

        // 3. ÁôªÂΩï‰∏éÊï∞ÊçÆËøÅÁßªÊ†∏ÂøÉÈÄªËæë
        function loginUser(nickname, password) {
            // ÁîüÊàêÂîØ‰∏Ä ID
            const rawId = nickname.trim() + '::' + password.trim();
            const userId = 'phdflow_user_' + simpleHash(rawId);
            
            // ËÆ∞ÂΩïÂΩìÂâçÊ¥ªË∑ÉÁî®Êà∑
            Storage.set('phdflow_active_user_id', userId);
            state.currentUserId = userId;
            
            // ËØªÂèñÊï∞ÊçÆ
            const users = getUnifiedUsers();
            let userData = users[userId];
            
            // ËøÅÁßªÈÄªËæëÔºöÂ¶ÇÊûúËØ•Ë¥¶Âè∑ÊòØÊñ∞ÁöÑ (userData ‰∏çÂ≠òÂú®)ÔºåÂ∞ùËØïÊü•ÊâæÊóßÁâà localStorage Êï∞ÊçÆ
            if (!userData) {
                // Â∞ùËØïÊü•ÊâæÊóßÁâà key (phd_data_nickname)
                const legacyKey = `phd_data_${nickname}`;
                const legacyData = Storage.get(legacyKey);
                
                if (legacyData) {
                    console.log("Ê£ÄÊµãÂà∞ÊóßÁâàÊï∞ÊçÆÔºåÊ≠£Âú®ËøÅÁßª...", nickname);
                    // ËøÅÁßªÊóßÊï∞ÊçÆ
                    userData = legacyData;
                    
                    // Â∞ùËØïËøÅÁßªÊóßÁöÑ Session
                    const legacySession = Storage.get(`phd_session_${nickname}`);
                    if (legacySession) userData.currentSession = legacySession;

                    // Â∞ùËØïËøÅÁßªÊóßÁöÑÂ§¥ÂÉèËÆæÁΩÆ
                    const userDir = Storage.get('phd_users_directory', {});
                    if (userDir[nickname]) {
                        if (!userData.settings) userData.settings = {};
                        userData.settings.avatar = userDir[nickname].avatar;
                    }

                    // Á°Æ‰øùÂü∫Êú¨ÁªìÊûÑÂÆåÊï¥
                    if (!userData.settings) userData.settings = { avatar: `https://api.dicebear.com/7.x/notionists/svg?seed=${Date.now()}` };

                } else {
                    // ÂΩªÂ∫ïÁöÑÊñ∞Áî®Êà∑ÔºåÂàùÂßãÂåñÈªòËÆ§Êï∞ÊçÆ
                    userData = createDefaultUserData();
                }
                
                // ‰øùÂ≠òËøÅÁßªÂêéÊàñÊñ∞Âª∫ÁöÑÊï∞ÊçÆÂà∞Áªü‰∏ÄÁªìÊûÑ‰∏≠
                users[userId] = userData;
                saveUnifiedUsers(users);
            }
            
            // Â∞ÜÊï∞ÊçÆÂä†ËΩΩÂà∞Â∫îÁî® State
            restoreAppStateFromUserData(userData, nickname);
        }

        function createDefaultUserData() {
            return {
                entries: [],
                customGoals: [{ id: 'g1', name: 'ÊØï‰∏öËÆ∫Êñá', currentQty: 0, targetQty: 1, unit: 'ÁØá', accumulatedWords: 0, targetWords: 100000 }],
                dailyPlans: [],
                articles: [],
                totalWordGoal: 100000,
                graduationDate: '',
                globalGoalType: 'ÊØï‰∏ö',
                globalGoalName: 'ÊØï‰∏öËÆ∫Êñá',
                currentSession: null,
                settings: { 
                    avatar: `https://api.dicebear.com/7.x/notionists/svg?seed=${Date.now()}` 
                }
            };
        }

        function restoreAppStateFromUserData(data, nickname) {
            state.user = { 
                username: nickname, 
                avatar: data.settings?.avatar || `https://api.dicebear.com/7.x/notionists/svg?seed=${Date.now()}` 
            };
            
            state.entries = Array.isArray(data.entries) ? data.entries : [];
            state.customGoals = Array.isArray(data.customGoals) ? data.customGoals : [];
            if(state.customGoals.length === 0) state.customGoals = createDefaultUserData().customGoals;

            state.dailyPlans = Array.isArray(data.dailyPlans) ? data.dailyPlans : [];
            state.globalGoalType = data.globalGoalType || 'ÊØï‰∏ö';
            state.globalGoalName = data.globalGoalName || 'ÊØï‰∏öËÆ∫Êñá';
            state.totalWordGoal = data.totalWordGoal || 100000;
            
            let safeGradDate = '';
            if (data.graduationDate) {
                const parsed = parseSafeDate(data.graduationDate);
                if (parsed) safeGradDate = data.graduationDate;
            }
            state.graduationDate = safeGradDate;

            // ÊñáÁ´†Êï∞ÊçÆÂ§ÑÁêÜÔºàÂÖºÂÆπÊóßÁâà MilestoneÔºâ
            let loadedArticles = Array.isArray(data.articles) ? data.articles : [];
            state.articles = loadedArticles.map(a => {
                if (!a.milestones && a.submissionDate) {
                    const ms = [{ label: 'ÊäïÁ®ø', date: a.submissionDate, note: '' }];
                    if (a.reviewDate) ms.push({ label: '‰∏ÄÂÆ°ËøîÂõû', date: a.reviewDate, note: '' });
                    if (a.revisionDate) ms.push({ label: 'Ëøî‰øÆÊèê‰∫§', date: a.revisionDate, note: '' });
                    if (a.acceptDate) ms.push({ label: 'Ê≠£ÂºèÂΩïÁî®', date: a.acceptDate, note: '' });
                    if (a.customMilestones) {
                        a.customMilestones.forEach(c => ms.push({ label: c.label, date: c.date, note: c.note }));
                    }
                    a.milestones = ms;
                }
                return a;
            });

            state.currentSession = data.currentSession || null;
            
            state.view = 'app';
            render();
        }

        // 4. ‰øùÂ≠òÊï∞ÊçÆÈÄªËæë (Áªü‰∏ÄÂÜôÂÖ• phdflow_users)
        function saveUserData() {
            if (!state.currentUserId) return;
            
            // ÊîæÂà∞ÂÆè‰ªªÂä°ÈòüÂàóÔºåÈÅøÂÖçÈòªÂ°û UI
            setTimeout(() => {
                const dataToSave = { 
                    entries: state.entries, 
                    customGoals: state.customGoals, 
                    dailyPlans: state.dailyPlans, 
                    totalWordGoal: state.totalWordGoal, 
                    graduationDate: state.graduationDate, 
                    articles: state.articles,
                    globalGoalType: state.globalGoalType,
                    globalGoalName: state.globalGoalName,
                    currentSession: state.currentSession,
                    settings: {
                        avatar: state.user.avatar
                    }
                };

                const users = getUnifiedUsers();
                users[state.currentUserId] = dataToSave;
                saveUnifiedUsers(users);
            }, 0);
        }

        // --- ‰∏öÂä°ËæÖÂä©ÂáΩÊï∞ ---
        const getTodayStr = () => new Date().toISOString().split('T')[0];
        
        const calcStats = (targetDate) => {
            const total = state.entries.reduce((acc, e) => acc + e.dailyCount, 0); 
            const today = state.entries.reduce((acc, e) => e.date === targetDate ? acc + e.dailyCount : acc, 0);
            const uniqueDays = new Set(state.entries.map(e => e.date)).size;
            const avg = uniqueDays > 0 ? Math.round(total / uniqueDays) : 0;
            return { total, today, avg };
        };

        const getDailyAverage = () => {
            if (!state.entries || state.entries.length === 0) return 0;
            const total = state.entries.reduce((acc, e) => acc + e.dailyCount, 0);
            const entryDates = state.entries.map(e => parseSafeDate(e.date)).filter(d => d);
            if (entryDates.length === 0) return 0;
            entryDates.sort((a, b) => a - b);
            const firstDate = entryDates[0];
            const now = new Date();
            firstDate.setHours(0,0,0,0);
            now.setHours(0,0,0,0);
            let diffDays = Math.floor((now - firstDate) / (1000 * 60 * 60 * 24)) + 1;
            diffDays = Math.max(1, diffDays);
            return Math.round(total / diffDays);
        };
        
        const getDaysLeft = () => {
            const gradDate = parseSafeDate(state.graduationDate);
            if (!gradDate) return null;
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            const diffTime = gradDate - now;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        };
        
        const getPlanProgress = (planId, targetDate) => {
            return state.entries
                .filter(e => e.date === targetDate && e.linkedPlanId === planId)
                .reduce((acc, e) => acc + e.dailyCount, 0);
        };

        const getLastCountForGoal = (goalId) => {
            if (!goalId) return 0;
            const relevantEntries = state.entries.filter(e => e.linkedGoalId === goalId);
            if (relevantEntries.length === 0) return 0;
            return Math.max(...relevantEntries.map(e => e.endCount));
        };
        
        const getSmartResponse = (reflection, mood) => {
            const text = (reflection || "").toLowerCase();
            for (const rule of encouragementRules) {
                if (rule.keywords.some(k => text.includes(k))) return rule.msg;
            }
            const fallbackMsgs = comfortMessages[mood] || comfortMessages.neutral;
            return fallbackMsgs[Math.floor(Math.random() * fallbackMsgs.length)];
        };

        const cleanOldPlans = () => {};

        const getGoalTagStyle = (name) => {
            if (!name) return { emoji: 'üå±', cls: 'tag-green' };
            const n = name.toLowerCase();
            if (n.includes('ËÆ∫Êñá') || n.includes('ÂÜô') || n.includes('Á®ø')) return { emoji: 'üìù', cls: 'tag-purple' };
            if (n.includes('ÈòÖËØª') || n.includes('ÊñáÁåÆ') || n.includes('‰π¶')) return { emoji: 'üìñ', cls: 'tag-blue' };
            if (n.includes('Êï∞ÊçÆ') || n.includes('ÂÆûÈ™å') || n.includes('ÂàÜÊûê')) return { emoji: 'üí°', cls: 'tag-cyan' };
            if (n.includes('ÊÄùËÄÉ') || n.includes('ÊÉ≥') || n.includes('ËÆ°Âàí')) return { emoji: 'üå±', cls: 'tag-green' };
            return { emoji: 'üìå', cls: 'tag-orange' }; 
        };

        const getArticleTypeClass = (type) => {
            switch(type) {
                case 'ÊúüÂàäËÆ∫Êñá': return 'badge-journal';
                case '‰ºöËÆÆËÆ∫Êñá': return 'badge-conf';
                case 'È°πÁõÆ': return 'badge-project';
                case 'ËØæÈ¢ò': return 'badge-project';
                case 'Ëëó‰Ωú': return 'badge-book';
                case 'ÂÖ∂‰ªñ': return 'badge-other';
                default: return 'badge-journal';
            }
        };

        // --- ÂøÉÁêÜËÉΩÈáèÁ´ôÈÄªËæë ---
        function pickEnergyQuote() {
            let nextIndex = 0;
            const lastIndex = Storage.get('energy_last_index', -1);
            if (psychQuotes.length > 1) {
                let attempts = 0;
                do {
                    nextIndex = Math.floor(Math.random() * psychQuotes.length);
                    attempts++;
                } while (nextIndex === lastIndex && attempts < 5);
            }
            const quote = psychQuotes[nextIndex];
            state.dailyQuote = quote;
            const quoteEl = document.getElementById('daily-quote-display');
            if (quoteEl) {
                quoteEl.innerText = `"${quote}"`;
            }
            Storage.set('energy_last_index', nextIndex);
            Storage.set('energy_last_ts', Date.now());
        }

        function startEnergyQuoteAutoRefresh() {
            setInterval(() => {
                const lastTs = Storage.get('energy_last_ts', 0);
                const now = Date.now();
                if (now - lastTs >= 1800000) {
                    pickEnergyQuote();
                }
            }, 60000); 
        }

        // --- ÊéíÂ∫èËäÇÁÇπÁöÑÈÄªËæë ---
        function sortMilestones(milestones) {
            return milestones.sort((a,b) => {
                if(!a.date && !b.date) return 0;
                if(!a.date) return 1;
                if(!b.date) return -1;
                return new Date(a.date) - new Date(b.date);
            });
        }

        function updateStatusFromMilestones() {
            if (state.articleStatusTouched) return; 
            const milestones = state.articleFormData.milestones || [];
            const withDate = milestones.filter(m => m.date);
            if (withDate.length === 0) return;
            withDate.sort((a, b) => new Date(a.date) - new Date(b.date));
            const latest = withDate[withDate.length - 1];
            const suggested = (latest.label || '').trim();
            if (!suggested) return;
            state.articleFormData.status = suggested;
            const inputEl = document.getElementById('article-status-input');
            if (inputEl) inputEl.value = suggested;
        }

        function renderMilestonesList() {
            const container = document.getElementById('milestone-list-container');
            if(!container) return; 
            const ms = state.articleFormData.milestones;
            const html = ms.map((m, idx) => `
                <div class="border border-slate-200 rounded-xl p-3 bg-white mb-2 transition-all hover:shadow-sm group">
                    <div class="flex items-center gap-2">
                        <button type="button" onclick="actions.toggleMilestoneNote(${idx})" class="text-slate-400 hover:text-indigo-500 w-6 h-6 flex items-center justify-center transition-transform ${m.expanded ? 'rotate-180 text-indigo-500' : ''}">
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </button>
                        <input type="text" placeholder="ËäÇÁÇπÂêçÁß∞" value="${m.label}" oninput="actions.updateMilestoneText(${idx}, 'label', this.value)" class="flex-1 text-sm font-bold text-slate-700 outline-none bg-transparent placeholder-slate-300">
                        <div onclick="actions.openCalendar(${idx})" class="cursor-pointer text-xs font-mono bg-slate-50 border border-slate-200 rounded px-2 py-1.5 w-28 text-center hover:border-indigo-500 hover:text-indigo-600 transition-colors ${m.date ? 'text-slate-700 font-bold' : 'text-slate-400'}">
                            ${m.date || 'ÈÄâÊã©Êó•Êúü'}
                        </div>
                        <button type="button" onclick="actions.removeMilestone(${idx})" class="text-slate-200 hover:text-red-400 p-1 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    <div id="ms-note-${idx}" class="${m.expanded ? '' : 'hidden'} mt-3 pt-2 border-t border-slate-100 animate-fade-in">
                        <textarea placeholder="Ê∑ªÂä†Â§áÊ≥® (Â¶ÇÔºöÂÆ°Á®ø‰∫∫ÊÑèËßÅË¶ÅÁÇπ„ÄÅÊ≤üÈÄöËÆ∞ÂΩï...)" oninput="actions.updateMilestoneText(${idx}, 'note', this.value)" class="w-full text-xs text-slate-600 bg-slate-50 rounded-lg p-2 outline-none border border-transparent focus:border-indigo-100 resize-none h-16 block">${m.note}</textarea>
                    </div>
                </div>
            `).join('');
            container.innerHTML = html;
            if (window.lucide) lucide.createIcons();
        }

        // --- Article Milestone Calendar Component ---
        function renderCalendarComponent() {
            const mount = document.getElementById('calendar-mount');
            if (!mount) return;

            if (!state.calendar.visible) {
                mount.innerHTML = '';
                return;
            }

            const { currentYear, currentMonth } = state.calendar;
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const monthNames = ["1Êúà", "2Êúà", "3Êúà", "4Êúà", "5Êúà", "6Êúà", "7Êúà", "8Êúà", "9Êúà", "10Êúà", "11Êúà", "12Êúà"];

            let daysHtml = '';
            for (let i = 0; i < firstDay; i++) { daysHtml += `<div class="calendar-day empty"></div>`; }
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = (today.getFullYear() === currentYear && today.getMonth() === currentMonth && today.getDate() === day);
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const targetIdx = state.calendar.targetIndex;
                const currentSelected = (targetIdx !== null && state.articleFormData.milestones[targetIdx]) ? state.articleFormData.milestones[targetIdx].date : '';
                const isSelected = currentSelected === dateStr;
                daysHtml += `<div onclick="actions.selectCalendarDate(${day})" class="calendar-day ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''}">${day}</div>`;
            }

            mount.innerHTML = `
                <div class="fixed inset-0 bg-black/20 z-[100] flex items-center justify-center p-4 animate-fade-in" onclick="actions.closeCalendar()">
                    <div class="bg-white rounded-2xl p-5 w-full max-w-[300px] shadow-2xl animate-scale-in" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <button onclick="actions.calendarPrevMonth()" class="p-1 hover:bg-slate-100 rounded text-slate-400 hover:text-indigo-600"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                            <span class="font-bold text-slate-800">${currentYear}Âπ¥ ${monthNames[currentMonth]}</span>
                            <button onclick="actions.calendarNextMonth()" class="p-1 hover:bg-slate-100 rounded text-slate-400 hover:text-indigo-600"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                        </div>
                        <div class="calendar-grid mb-2">
                            <span class="text-xs text-center text-slate-300 font-bold">Êó•</span>
                            <span class="text-xs text-center text-slate-300 font-bold">‰∏Ä</span>
                            <span class="text-xs text-center text-slate-300 font-bold">‰∫å</span>
                            <span class="text-xs text-center text-slate-300 font-bold">‰∏â</span>
                            <span class="text-xs text-center text-slate-300 font-bold">Âõõ</span>
                            <span class="text-xs text-center text-slate-300 font-bold">‰∫î</span>
                            <span class="text-xs text-center text-slate-300 font-bold">ÂÖ≠</span>
                        </div>
                        <div class="calendar-grid">${daysHtml}</div>
                        <div class="mt-4 flex justify-center">
                            <button onclick="actions.closeCalendar()" class="text-xs text-slate-400 hover:text-slate-600">ÂèñÊ∂à</button>
                        </div>
                    </div>
                </div>
            `;
            if (window.lucide) lucide.createIcons();
        }

        // --- Main Calendar Component ---
        function renderMainCalendarComponent() {
            const mount = document.getElementById('main-calendar-mount');
            if (!mount) return;

            if (!state.mainCalendar.visible) {
                mount.innerHTML = '';
                return;
            }

            const { viewYear, viewMonth, selectedDateStr } = state.mainCalendar;
            const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
            const firstDay = new Date(viewYear, viewMonth, 1).getDay();
            const monthNames = ["1Êúà", "2Êúà", "3Êúà", "4Êúà", "5Êúà", "6Êúà", "7Êúà", "8Êúà", "9Êúà", "10Êúà", "11Êúà", "12Êúà"];

            let daysHtml = '';
            for (let i = 0; i < firstDay; i++) { daysHtml += `<div class="calendar-day empty"></div>`; }
            
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateObj = new Date(viewYear, viewMonth, day);
                const dateStr = `${viewYear}-${String(viewMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const isToday = (today.getFullYear() === viewYear && today.getMonth() === viewMonth && today.getDate() === day);
                const isSelected = selectedDateStr === dateStr;
                
                const isDisabled = dateObj < MIN_DATE || dateObj > MAX_DATE;

                daysHtml += `<div onclick="${isDisabled ? '' : `actions.selectMainCalDay(${day})`}" class="calendar-day ${isToday ? 'today' : ''} ${isSelected ? 'temp-selected' : ''} ${isDisabled ? 'disabled' : ''}">${day}</div>`;
            }

            const canPrev = new Date(viewYear, viewMonth, 0) >= MIN_DATE;
            const canNext = new Date(viewYear, viewMonth + 1, 1) <= MAX_DATE;

            mount.innerHTML = `
                <div class="fixed inset-0 bg-black/30 z-[100] flex items-center justify-center p-4 animate-fade-in" onclick="actions.closeMainCalendar()">
                    <div class="bg-white rounded-2xl p-5 w-full max-w-[320px] shadow-2xl animate-scale-in" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <button onclick="actions.mainCalPrevMonth()" class="p-1 hover:bg-slate-100 rounded text-slate-400 hover:text-indigo-600 ${!canPrev ? 'opacity-30 pointer-events-none' : ''}"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                            <span class="font-bold text-slate-800 text-lg">${viewYear}Âπ¥ ${monthNames[viewMonth]}</span>
                            <button onclick="actions.mainCalNextMonth()" class="p-1 hover:bg-slate-100 rounded text-slate-400 hover:text-indigo-600 ${!canNext ? 'opacity-30 pointer-events-none' : ''}"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                        </div>
                        <div class="calendar-grid mb-2">
                            <span class="text-xs text-center text-slate-300 font-bold">Êó•</span>
                            <span class="text-xs text-center text-slate-300 font-bold">‰∏Ä</span>
                            <span class="text-xs text-center text-slate-300 font-bold">‰∫å</span>
                            <span class="text-xs text-center text-slate-300 font-bold">‰∏â</span>
                            <span class="text-xs text-center text-slate-300 font-bold">Âõõ</span>
                            <span class="text-xs text-center text-slate-300 font-bold">‰∫î</span>
                            <span class="text-xs text-center text-slate-300 font-bold">ÂÖ≠</span>
                        </div>
                        <div class="calendar-grid mb-6">
                            ${daysHtml}
                        </div>
                        <div class="flex gap-3">
                            <button onclick="actions.resetMainCalDate()" class="flex-1 py-2.5 rounded-xl border border-slate-200 text-slate-500 font-bold text-sm hover:bg-slate-50 transition">ËøòÂéü‰ªäÂ§©</button>
                            <button onclick="actions.confirmMainCalDate()" class="flex-1 py-2.5 rounded-xl primary-gradient text-white font-bold text-sm shadow-lg shadow-indigo-100 active:scale-95 transition">ÂÆåÊàê</button>
                        </div>
                    </div>
                </div>
            `;
            if (window.lucide) lucide.createIcons();
        }

        function updateArticleTypeUI(type) {
            const config = ARTICLE_CONFIG[type] || ARTICLE_CONFIG['ÊúüÂàäËÆ∫Êñá'];
            const titleInput = document.getElementById('article-title-input');
            const journalInput = document.getElementById('article-journal-input');
            const journalLabel = document.getElementById('article-journal-label');
            const datalist = document.getElementById('stage-options');
            if(titleInput) titleInput.placeholder = config.titlePlaceholder;
            if(journalInput) journalInput.placeholder = config.journalPlaceholder;
            if(journalLabel) journalLabel.innerText = config.journalLabel + " *";
            if(datalist) {
                datalist.innerHTML = config.stages.map(s => `<option value="${s}">${s}</option>`).join('');
            }
        }

        // --- ‰∫§‰∫í Action ---
        window.actions = {
            // ÊîπÂä® 1ÔºöÁôªÂΩïÈÄªËæëÊõ¥Êñ∞
            auth: (e) => { 
                e.preventDefault(); 
                const nickname = e.target.username.value.trim() || "ÂåøÂêçÂçöÂ£´";
                const password = e.target.password.value.trim() || ""; // ÂÖÅËÆ∏Á©∫ÂØÜÁ†ÅÔºå‰ΩÜ‰ºöÂΩ±ÂìçHash
                loginUser(nickname, password); 
            },
            
            askLogout: () => { state.showSidebar = false; state.showLogoutModal = true; render(); },
            
            // ÊîπÂä® 2ÔºöÁôªÂá∫ÈÄªËæëÊõ¥Êñ∞
            confirmLogout: () => { 
                Storage.remove('phdflow_active_user_id'); 
                state.user = null; 
                state.currentUserId = null;
                state.showLogoutModal = false; 
                state.view = 'login'; 
                render(); 
            },
            
            cancelLogout: () => { state.showLogoutModal = false; render(); },
            
            setTab: (t) => { 
                state.activeTab = t; 
                if(t==='add' && !state.currentSession) { 
                    const defaultGoalId = state.customGoals.length > 0 ? state.customGoals[0].id : 'thesis';
                    const lastCount = getLastCountForGoal(defaultGoalId);
                    state.formData = { date: getTodayStr(), linkedGoalId: defaultGoalId, startCount: lastCount, endCount: lastCount, chapter: '', mood: 'neutral', reflection: '', duration: '', durationNum: 0 };
                } 
                if(t==='rank') { state.loadingLeaderboard = true; render(); setTimeout(() => { state.loadingLeaderboard = false; render(); }, 500); } 
                else { render(); }
            },
            toggleSidebar: () => { state.showSidebar = !state.showSidebar; render(); },
            
            setViewDate: (d) => { state.viewDate = d; render(); },
            
            changeDate: (days) => { 
                if (days > 0) {
                    actions.openMainCalendar();
                    return;
                }
                const current = parseSafeDate(state.viewDate) || new Date(); 
                current.setDate(current.getDate() + days); 
                if (current < MIN_DATE || current > MAX_DATE) return;

                const newDateStr = current.toISOString().split('T')[0];
                state.viewDate = newDateStr; 
                render(); 
            },
            
            goToToday: () => { 
                state.viewDate = getTodayStr(); 
                render(); 
            },

            openMainCalendar: () => {
                const d = parseSafeDate(state.viewDate) || new Date();
                state.mainCalendar.viewYear = d.getFullYear();
                state.mainCalendar.viewMonth = d.getMonth();
                state.mainCalendar.selectedDateStr = state.viewDate;
                state.mainCalendar.visible = true;
                renderMainCalendarComponent();
            },
            closeMainCalendar: () => {
                state.mainCalendar.visible = false;
                renderMainCalendarComponent();
            },
            mainCalPrevMonth: () => {
                let { viewMonth, viewYear } = state.mainCalendar;
                if (viewMonth === 0) { viewMonth = 11; viewYear--; } else { viewMonth--; }
                state.mainCalendar.viewMonth = viewMonth;
                state.mainCalendar.viewYear = viewYear;
                renderMainCalendarComponent();
            },
            mainCalNextMonth: () => {
                let { viewMonth, viewYear } = state.mainCalendar;
                if (viewMonth === 11) { viewMonth = 0; viewYear++; } else { viewMonth++; }
                state.mainCalendar.viewMonth = viewMonth;
                state.mainCalendar.viewYear = viewYear;
                renderMainCalendarComponent();
            },
            selectMainCalDay: (day) => {
                const { viewYear, viewMonth } = state.mainCalendar;
                const dateStr = `${viewYear}-${String(viewMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                state.mainCalendar.selectedDateStr = dateStr;
                renderMainCalendarComponent();
            },
            confirmMainCalDate: () => {
                if (state.mainCalendar.selectedDateStr) {
                    state.viewDate = state.mainCalendar.selectedDateStr;
                    state.mainCalendar.visible = false;
                    renderMainCalendarComponent();
                    render(); 
                }
            },
            resetMainCalDate: () => {
                state.viewDate = getTodayStr();
                state.mainCalendar.visible = false;
                renderMainCalendarComponent();
                render(); 
            },
            
            openAddPlan: () => { state.editingPlanId = null; const defaultGoal = state.customGoals.length > 0 ? state.customGoals[0].id : ''; state.planFormData = { target: 1000, content: '', linkedGoalId: defaultGoal }; state.showPlanModal = true; render(); },
            openEditPlan: (id) => { const plan = state.dailyPlans.find(p => p.id === id); if(plan) { state.editingPlanId = id; state.planFormData = { ...plan }; state.showPlanModal = true; render(); } },
            closePlanModal: () => { state.showPlanModal = false; render(); },
            setPlanForm: (f, v) => state.planFormData[f] = v,
            savePlan: (e) => {
                e.preventDefault();
                const newPlan = { ...state.planFormData, id: state.editingPlanId || Date.now().toString(), date: state.viewDate };
                if (state.editingPlanId) state.dailyPlans = state.dailyPlans.map(p => p.id === state.editingPlanId ? newPlan : p);
                else state.dailyPlans.push(newPlan);
                state.showPlanModal = false; saveUserData(); render();
            },
            deletePlan: (id) => { if(confirm("Á°ÆÂÆöÂà†Èô§Ëøô‰∏™ÁõÆÊ†áÂêóÔºü")) { state.dailyPlans = state.dailyPlans.filter(p => p.id !== id); saveUserData(); render(); } },

            start: (planId) => { 
                const plan = state.dailyPlans.find(p => p.id === planId);
                const linkedGoalId = plan ? plan.linkedGoalId : '';
                const lastMax = getLastCountForGoal(linkedGoalId);
                state.currentSession = { start: Date.now(), startCount: lastMax, isActive: true, planId: planId, linkedGoalId: linkedGoalId }; 
                saveUserData(); 
                render(); 
            },
            adjustStart: () => { const newStart = prompt("‰øÆÊ≠£ÂºÄÂßãÂ≠óÊï∞:", state.currentSession.startCount); if (newStart !== null && !isNaN(newStart)) { state.currentSession.startCount = parseInt(newStart); saveUserData(); render(); } },
            adjustManualStart: (d) => {
                const oldStart = parseInt(state.formData.startCount) || 0;
                const newStart = Math.max(0, oldStart + d);
                actions.setFormData('startCount', newStart);
                const el = document.querySelector('input[name="startCount"]');
                if(el) el.value = newStart;
                actions.setFormData('endCount', state.formData.endCount);
            },
            autoGenReflection: () => {
                const mood = state.formData.mood;
                const opts = autoReflections[mood] || autoReflections.neutral;
                const text = opts[Math.floor(Math.random() * opts.length)];
                state.formData.reflection = text;
                const el = document.querySelector('textarea[name="reflection"]');
                if(el) el.value = text;
            },
            setFormData: (f, v) => { 
                state.formData[f] = v;
                if (f === 'endCount') {
                    const isFocus = !!state.currentSession;
                    const start = isFocus ? state.currentSession.startCount : parseInt(state.formData.startCount);
                    const diff = (parseInt(v)||0) - (parseInt(start)||0);
                    const el = document.getElementById('net-word-display');
                    if(el) { el.innerText = diff > 0 ? `+${diff}` : diff; el.style.color = diff > 0 ? '#10B981' : (diff < 0 ? '#EF4444' : '#94A3B8'); }
                }
                if (f === 'linkedGoalId') {
                    const lastCount = getLastCountForGoal(v);
                    state.formData.startCount = lastCount;
                    state.formData.endCount = lastCount;
                }
            },
            updateDuration: (val) => {
                state.formData.durationNum = val;
                const display = val > 0 ? `${val} Â∞èÊó∂` : '';
                state.formData.duration = display;
                const el = document.getElementById('duration-display');
                if(el) el.innerText = val > 0 ? display : '0 Â∞èÊó∂';
            },

            end: (e) => {
                e.preventDefault();
                const isFocus = !!state.currentSession;
                const start = isFocus ? state.currentSession.startCount : parseInt(state.formData.startCount);
                const end = parseInt(e.target.endCount.value);
                if (end < start && !confirm("ÁªìÊùüÂ≠óÊï∞Â∞ë‰∫éÂºÄÂßãÂ≠óÊï∞Ôºü(ËÆ∞ÂΩï‰∏∫Ë¥ü‰∫ßÂá∫)")) return;
                const diff = end - start;
                let planId = null, linkedGoalId = isFocus ? state.currentSession.linkedGoalId : state.formData.linkedGoalId;
                if (!linkedGoalId && state.customGoals.length > 0) { linkedGoalId = state.customGoals[0].id; }
                let goalName = "Êú™ÂàÜÁ±ªÁõÆÊ†á", planContent = state.formData.chapter || "ÊâìÂç°ËÆ∞ÂΩï";
                let mood = state.formData.mood, reflection = state.formData.reflection;
                if(!reflection) {
                    const opts = autoReflections[mood] || autoReflections.neutral;
                    reflection = opts[Math.floor(Math.random() * opts.length)];
                }
                let encourageMsg = getSmartResponse(reflection, mood);
                if(diff > 2000) encourageMsg = "Â§©Âì™ÔºÅ2000+Â≠óÔºÅ‰Ω†Â∞±ÊòØ‰º†ËØ¥‰∏≠ÁöÑÂ≠¶ÊúØË∂Ö‰∫∫ÔºÅËØ∑Êî∂‰∏ãÊàëÁöÑËÜùÁõñÔºÅüôá‚Äç‚ôÇÔ∏è";

                if (isFocus) {
                    planId = state.currentSession.planId;
                    const plan = state.dailyPlans.find(p => p.id === planId);
                    if (plan) planContent = plan.content;
                } 

                if(linkedGoalId) {
                    const g = state.customGoals.find(x=>x.id===linkedGoalId);
                    if(g) { 
                        g.accumulatedWords = (g.accumulatedWords || 0) + diff; 
                        goalName = g.name;
                        if(g.unit === 'Â≠ó') g.current = (g.current || 0) + diff;
                    }
                }
                
                const recordDate = state.formData.date || getTodayStr();
                let finalDuration = state.formData.duration;
                if(isFocus) finalDuration = Math.round((Date.now() - state.currentSession.start)/60000) + "m";

                state.entries.push({ 
                    id: Date.now(), date: recordDate, startCount: start, endCount: end, dailyCount: diff, 
                    duration: finalDuration, 
                    mood, reflection, linkedPlanContent: planContent, linkedGoalName: goalName, linkedPlanId: planId, linkedGoalId: linkedGoalId
                });
                state.entries.sort((a,b)=> new Date(b.date)-new Date(a.date));
                state.currentSession = null;
                state.formData = { date: getTodayStr(), startCount: 0, endCount: 0, mood: 'neutral', reflection: '', chapter: '', linkedGoalId: '', duration: '', durationNum: 0 }; 
                state.feedbackData = { diff, linkedGoalName: goalName, encourageMsg }; 
                state.showFeedback = true;
                render(); 
                saveUserData(); 
            },
            cancelSession: () => { if(confirm("ÊîæÂºÉÊú¨Ê¨°‰∏ìÊ≥®Ôºü")) { state.currentSession = null; saveUserData(); render(); } },
            setMood: (m) => { state.formData.mood = m; render(); },
            closeFeedback: () => { state.showFeedback = false; state.activeTab = 'history'; render(); },
            
            openAddGoal: () => { state.editingGoalId = null; state.newGoalData = { name: '', targetQty: 1, unit: 'ÁØá', targetWords: 50000 }; state.showGoalModal = true; render(); },
            openEditGoal: (id) => { const g = state.customGoals.find(x => x.id === id); if (g) { state.editingGoalId = id; state.newGoalData = { ...g }; state.showGoalModal = true; render(); } },
            setNewGoal: (f, v) => state.newGoalData[f] = v,
            saveGoal: () => {
                if(!state.newGoalData.name) return;
                const goalData = { name: state.newGoalData.name, targetQty: parseInt(state.newGoalData.targetQty) || 1, unit: state.newGoalData.unit || '‰∏™', targetWords: parseInt(state.newGoalData.targetWords) || 0 };
                if (state.editingGoalId) state.customGoals = state.customGoals.map(g => g.id === state.editingGoalId ? { ...g, ...goalData } : g);
                else state.customGoals.push({ ...goalData, id: Date.now().toString(), currentQty: 0, accumulatedWords: 0 });
                state.showGoalModal = false; saveUserData(); render();
            },
            delGoal: (id) => { if(confirm("Âà†Èô§Ê≠§ÁõÆÊ†áÔºü")) { state.customGoals = state.customGoals.filter(x=>x.id!==id); saveUserData(); render(); } },
            addQty: (id) => { const g = state.customGoals.find(x=>x.id===id); if(g) { g.currentQty++; saveUserData(); render(); } },
            
            toggleGrad: () => { state.showGradSettings = !state.showGradSettings; render(); },
            saveGradSettings: () => {
                const dateInput = document.getElementById('grad-date-input');
                const typeInput = document.getElementById('global-type-input');
                const nameInput = document.getElementById('global-name-input');
                if(dateInput) {
                    const val = dateInput.value;
                    if (parseSafeDate(val)) state.graduationDate = val;
                    else if (val === '') state.graduationDate = '';
                }
                if (typeInput) state.globalGoalType = typeInput.value || 'ÊØï‰∏ö';
                if (nameInput) {
                    state.globalGoalName = nameInput.value || 'ÊØï‰∏öËÆ∫Êñá';
                    if (state.customGoals.length > 0) {
                        state.customGoals[0].name = state.globalGoalName;
                    }
                }
                state.showGradSettings = false;
                saveUserData();
                render();
            },
            toggleGoalModal: () => { state.showGoalModal = !state.showGoalModal; render(); },
            setTotalGoal: () => { const v = prompt("ÁõÆÊ†áÂ≠óÊï∞:", state.totalWordGoal); if(v) { state.totalWordGoal = Number(v); saveUserData(); render(); } },
            editProfile: () => { state.tempProfile = {...state.user}; state.showProfileModal = true; state.showSidebar = false; render(); },
            closeProfile: () => { state.showProfileModal = false; render(); },
            setTempProfile: (f,v) => state.tempProfile[f]=v,
            randAvatar: () => { state.tempProfile.avatar = `https://api.dicebear.com/7.x/notionists/svg?seed=${Date.now()}`; render(); },
            saveProfile: (e) => { e.preventDefault(); state.user = {...state.user, ...state.tempProfile}; state.showProfileModal = false; saveUserData(); render(); },

            openCalendar: (index) => {
                state.calendar.visible = true;
                state.calendar.targetIndex = index;
                const currentVal = state.articleFormData.milestones[index].date;
                if (currentVal) {
                    const d = parseSafeDate(currentVal);
                    if (d) {
                        state.calendar.currentYear = d.getFullYear();
                        state.calendar.currentMonth = d.getMonth();
                    }
                } else {
                    const now = new Date();
                    state.calendar.currentYear = now.getFullYear();
                    state.calendar.currentMonth = now.getMonth();
                }
                renderCalendarComponent();
            },
            closeCalendar: () => {
                state.calendar.visible = false;
                state.calendar.targetIndex = null;
                renderCalendarComponent();
            },
            calendarPrevMonth: () => {
                let { currentMonth, currentYear } = state.calendar;
                if (currentMonth === 0) { currentMonth = 11; currentYear--; } 
                else { currentMonth--; }
                state.calendar.currentMonth = currentMonth;
                state.calendar.currentYear = currentYear;
                renderCalendarComponent();
            },
            calendarNextMonth: () => {
                let { currentMonth, currentYear } = state.calendar;
                if (currentMonth === 11) { currentMonth = 0; currentYear++; } 
                else { currentMonth++; }
                state.calendar.currentMonth = currentMonth;
                state.calendar.currentYear = currentYear;
                renderCalendarComponent();
            },
            selectCalendarDate: (day) => {
                const { currentYear, currentMonth, targetIndex } = state.calendar;
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                if (targetIndex !== null) {
                    state.articleFormData.milestones[targetIndex].date = dateStr;
                    state.articleFormData.milestones = sortMilestones(state.articleFormData.milestones);
                    renderMilestonesList();
                    updateStatusFromMilestones();
                }
                actions.closeCalendar();
            },

            openAddArticle: () => {
                state.articleStatusTouched = false; 
                const defaultType = 'ÊúüÂàäËÆ∫Êñá';
                const defaultMilestones = ARTICLE_CONFIG[defaultType].milestones.map(label => ({ label, date: '', note: '' }));
                state.articleFormData = {
                    id: null,
                    title: '',
                    journal: '',
                    type: defaultType,
                    status: '',
                    milestones: defaultMilestones, 
                    reviewNotes: '',
                    notes: ''
                };
                state.showArticleModal = true;
                render();
                setTimeout(() => {
                    updateArticleTypeUI(defaultType);
                    renderMilestonesList();
                    updateStatusFromMilestones();
                }, 0);
            },
            openEditArticle: (id) => {
                const article = state.articles.find(a => a.id === id);
                if (article) {
                    state.articleFormData = JSON.parse(JSON.stringify(article));
                    if (article.status && article.status.trim() !== '') {
                        state.articleStatusTouched = true;
                    } else {
                        state.articleStatusTouched = false;
                        setTimeout(() => updateStatusFromMilestones(), 0);
                    }
                    state.showArticleModal = true;
                    render();
                    setTimeout(() => {
                        updateArticleTypeUI(state.articleFormData.type);
                        renderMilestonesList();
                    }, 0);
                }
            },
            toggleArticleModal: () => { state.showArticleModal = !state.showArticleModal; render(); },
            toggleArticleDetails: (id) => {
                const el = document.getElementById(`article-details-${id}`);
                const btn = document.getElementById(`article-toggle-btn-${id}`);
                if(el) el.classList.toggle('hidden');
                if(btn) btn.classList.toggle('rotate-180');
            },
            setArticleForm: (f, v) => { 
                state.articleFormData[f] = v; 
                if (f === 'type') actions.changeArticleType(v);
                if (f === 'status') state.articleStatusTouched = true;
            },
            changeArticleType: (newType) => {
                state.articleFormData.type = newType;
                if (!state.articleFormData.id) {
                    const hasDates = state.articleFormData.milestones.some(m => m.date);
                    if (!hasDates) {
                        const templates = ARTICLE_CONFIG[newType].milestones || [];
                        state.articleFormData.milestones = templates.map(label => ({ label, date: '', note: '' }));
                        renderMilestonesList(); 
                    }
                }
                updateArticleTypeUI(newType); 
                updateStatusFromMilestones();
            },
            addMilestone: () => {
                const ms = state.articleFormData.milestones;
                let insertIndex = ms.length; 
                for (let i = ms.length - 1; i >= 0; i--) {
                    if (ms[i].date) {
                        insertIndex = i + 1;
                        break;
                    }
                }
                if (insertIndex === ms.length && ms.every(m => !m.date)) {
                     insertIndex = ms.length > 0 ? 1 : 0;
                }
                const newNode = { label: '', date: '', note: '', expanded: true };
                ms.splice(insertIndex, 0, newNode);
                renderMilestonesList();
                updateStatusFromMilestones(); 
                setTimeout(() => {
                     const inputs = document.querySelectorAll('#milestone-list-container input[type="text"]');
                     if(inputs[insertIndex]) inputs[insertIndex].focus();
                }, 0);
            },
            appendRecommendedNodes: () => {
                const type = state.articleFormData.type || 'ÊúüÂàäËÆ∫Êñá';
                const templates = ARTICLE_CONFIG[type].milestones || [];
                const currentLabels = state.articleFormData.milestones.map(m => m.label);
                const newNodes = templates.filter(t => !currentLabels.includes(t))
                                          .map(label => ({ label, date: '', note: '' }));
                if (newNodes.length > 0) {
                    state.articleFormData.milestones = [...state.articleFormData.milestones, ...newNodes];
                    state.articleFormData.milestones = sortMilestones(state.articleFormData.milestones);
                    renderMilestonesList();
                    updateStatusFromMilestones(); 
                } else {
                    alert("Êé®ËçêËäÇÁÇπÂ∑≤ÂÖ®ÈÉ®Â≠òÂú®");
                }
            },
            removeMilestone: (index) => {
                if (state.articleFormData.milestones.length <= 1) {
                    alert("ËØ∑Ëá≥Â∞ë‰øùÁïô‰∏Ä‰∏™ËäÇÁÇπ");
                    return;
                }
                state.articleFormData.milestones.splice(index, 1);
                renderMilestonesList();
                updateStatusFromMilestones();
            },
            updateMilestoneText: (index, field, value) => {
                state.articleFormData.milestones[index][field] = value;
                if (field === 'label') updateStatusFromMilestones();
            },
            toggleMilestoneNote: (index) => {
                const m = state.articleFormData.milestones[index];
                m.expanded = !m.expanded;
                const noteEl = document.getElementById(`ms-note-${index}`);
                const iconBtn = noteEl.parentElement.querySelector('button i');
                if (noteEl) {
                    if (m.expanded) {
                        noteEl.classList.remove('hidden');
                        if(iconBtn) iconBtn.closest('button').classList.add('rotate-180', 'text-indigo-500');
                    } else {
                        noteEl.classList.add('hidden');
                        if(iconBtn) iconBtn.closest('button').classList.remove('rotate-180', 'text-indigo-500');
                    }
                }
            },
            saveArticle: (e) => {
                e.preventDefault();
                const d = state.articleFormData;
                if(!d.title) { alert("Ê†áÈ¢ò‰∏çËÉΩ‰∏∫Á©∫"); return; }
                const newArticle = {
                    ...d,
                    id: d.id || Date.now(),
                    submissionDate: d.milestones.find(m => m.date)?.date || getTodayStr() 
                };
                if (d.id) {
                    state.articles = state.articles.map(a => a.id === d.id ? newArticle : a);
                } else {
                    state.articles.push(newArticle);
                }
                state.articles.sort((a, b) => new Date(b.submissionDate) - new Date(a.submissionDate));
                state.showArticleModal = false;
                saveUserData();
                render();
            },
            deleteArticle: (id) => {
                if(confirm("Á°ÆÂÆöÂà†Èô§ËøôÊù°ÊñáÁ´†ËÆ∞ÂΩïÂêóÔºü")) {
                    state.articles = state.articles.filter(a => a.id !== id);
                    saveUserData();
                    render();
                }
            }
        };

        // --- Render Components ---
        const Icons = {
            Menu: `<i data-lucide="menu" class="w-6 h-6"></i>`, Target: `<i data-lucide="target" class="w-6 h-6"></i>`, History: `<i data-lucide="history" class="w-6 h-6"></i>`,
            Medal: `<i data-lucide="medal" class="w-6 h-6"></i>`, Edit: `<i data-lucide="pencil" class="w-4 h-4"></i>`, Plus: `<i data-lucide="plus" class="w-5 h-5"></i>`,
            Trash: `<i data-lucide="trash-2" class="w-4 h-4"></i>`, Check: `<i data-lucide="check-circle-2" class="w-5 h-5"></i>`, User: `<i data-lucide="user" class="w-5 h-5"></i>`,
            LogOut: `<i data-lucide="log-out" class="w-5 h-5"></i>`, Switch: `<i data-lucide="users" class="w-5 h-5"></i>`, Settings: `<i data-lucide="settings" class="w-5 h-5"></i>`,
            Play: `<i data-lucide="play" class="w-5 h-5"></i>`, X: `<i data-lucide="x" class="w-5 h-5"></i>`, Star: `<i data-lucide="star" class="w-4 h-4"></i>`,
            Wand: `<i data-lucide="wand-2" class="w-3 h-3"></i>`, Cal: `<i data-lucide="calendar" class="w-4 h-4"></i>`,
            Left: `<i data-lucide="chevron-left" class="w-5 h-5"></i>`, Right: `<i data-lucide="chevron-right" class="w-5 h-5"></i>`,
            File: `<i data-lucide="file-text" class="w-6 h-6"></i>`, Book: `<i data-lucide="book" class="w-4 h-4"></i>`,
            Refresh: `<i data-lucide="refresh-cw" class="w-3 h-3"></i>`, Down: `<i data-lucide="chevron-down" class="w-4 h-4"></i>`,
            Trophy: `<i data-lucide="trophy" class="w-5 h-5"></i>`
        };

        function AppLogo(size = "w-12 h-12") {
            return `<div class="${size} logo-gradient rounded-xl flex items-center justify-center shadow-lg transform rotate-3"><i data-lucide="graduation-cap" class="text-white w-1/2 h-1/2"></i><div class="absolute -bottom-1 -right-1 bg-white rounded-full p-0.5 border-2 border-indigo-500"><i data-lucide="pen-tool" class="w-3 h-3 text-indigo-600"></i></div></div>`;
        }

        function MoodIcon(mood, selected) {
            const cls = `mood-icon w-6 h-6 ${selected ? 'selected' : 'opacity-60'}`;
            const emoji = {happy:'üòä', neutral:'üòê', sad:'üòî', tired:'üò¥'};
            return `<div class="${cls} text-xl flex items-center justify-center cursor-pointer transition-transform hover:scale-110">${emoji[mood]}</div>`;
        }

        function renderProgressBar(current, target, label) {
            const pct = Math.max(0, Math.min(100, target > 0 ? (current / target) * 100 : 0));
            const isDone = pct >= 100;
            return `<div class="relative pt-6 pb-2"><div class="progress-track"><div class="progress-jelly ${isDone?'done':''}" style="width: ${pct}%"></div></div>${isDone ? '<div class="absolute -top-1 right-0 animate-bounce-slow text-xl">üéâ</div>' : ''}<div class="flex justify-between text-xs text-slate-400 mt-2 font-medium px-1"><span>0</span><span class="${isDone?'text-green-600 font-bold':''}">${label} ${isDone?'ÂÆåÊàê!':''}</span><span>${target>1000?(target/10000).toFixed(1)+'w':target}</span></div></div>`;
        }

        function renderLogin() {
            return `<div class="flex flex-col items-center justify-center h-screen px-8 bg-white"><div class="mb-6 animate-float">${AppLogo("w-24 h-24")}</div><h1 class="text-2xl font-bold text-slate-800 mb-2">PhD Flow</h1><p class="text-slate-400 text-sm mb-10">ÊöñÂøÉÈô™‰º¥ ¬∑ Âø´‰πêÂÜô‰Ωú</p><form onsubmit="actions.auth(event)" class="w-full space-y-4"><input name="username" placeholder="‰æãÂ¶ÇÔºöÊú™Êù•ÁöÑÊùéÂçöÂ£´" class="w-full bg-gray-50 border border-gray-200 p-4 rounded-2xl outline-none focus:border-indigo-500 text-center font-bold text-slate-700" required><input name="password" type="password" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å" class="w-full bg-gray-50 border border-gray-200 p-4 rounded-2xl outline-none focus:border-indigo-500 text-center"><button class="w-full primary-gradient text-white font-bold py-4 rounded-2xl shadow-lg shadow-indigo-200 active:scale-95 transition-transform">ËøõÂÖ•‰π¶Êàø</button></form><p class="mt-8 text-xs text-slate-300">Tip: ËØ∑ËÆ∞‰ΩèÊÇ®ÁöÑÊòµÁß∞ÂíåÂØÜÁ†ÅÔºåÊï∞ÊçÆÂ∞ÜÊ∞∏‰πÖ‰øùÂ≠òÂú®Êú¨ËÆæÂ§á</p></div>`;
        }

        function renderDashboard() {
            const { total, today } = calcStats(state.viewDate);
            const dailyAvg = getDailyAverage();
            const days = getDaysLeft();
            const isToday = state.viewDate === getTodayStr();
            
            let dateStr = state.viewDate;
            let weekStr = '';
            const d = parseSafeDate(state.viewDate);
            if (d) {
                dateStr = `${d.getFullYear()}Âπ¥${d.getMonth()+1}Êúà${d.getDate()}Êó•`;
                weekStr = d.toLocaleDateString('zh-CN', { weekday: 'long' });
            }
            
            const dayPlans = state.dailyPlans.filter(p => p.date === state.viewDate);
            
            let plansHtml = dayPlans.length > 0 ? dayPlans.map(plan => {
                const currentProgress = getPlanProgress(plan.id, state.viewDate);
                const isDone = currentProgress >= plan.target;
                const pct = Math.min(100, Math.round(((currentProgress || 0) / plan.target) * 100));
                const goal = state.customGoals.find(g => g.id === plan.linkedGoalId);
                const goalName = goal ? goal.name : 'Ëá™Áî±ÂÜô‰Ωú';
                const tagStyle = getGoalTagStyle(goalName);
                return `<div class="${isDone ? 'card-gradient-done border-green-200' : 'card-gradient-1 border-white'} rounded-[24px] p-6 shadow-[0_10px_30px_rgba(0,0,0,0.06)] mb-6 relative transition-all hover:scale-[1.01] border"><div class="absolute top-5 right-5 flex gap-2"><button onclick="actions.openEditPlan('${plan.id}')" class="text-slate-300 hover:text-indigo-500">${Icons.Edit}</button><button onclick="actions.deletePlan('${plan.id}')" class="text-slate-300 hover:text-red-500">${Icons.Trash}</button></div><div class="flex flex-col items-start mb-4 pr-16 mt-2"><div class="mb-3"><span class="goal-tag ${tagStyle.cls}"><span class="text-sm">${tagStyle.emoji}</span> ${goalName}</span></div><h2 class="text-lg font-bold text-slate-800">${plan.content}</h2></div><div class="flex items-baseline gap-2 mb-3"><span class="text-4xl font-black ${isDone ? 'text-green-600' : 'text-indigo-600'}">${currentProgress}</span><span class="text-xs text-slate-400 font-bold">/ ${plan.target} Â≠ó</span></div><div class="progress-track mb-5"><div class="progress-jelly ${isDone?'done':''}" style="width: ${pct}%"></div></div>${isDone ? `<div class="w-full py-3 text-center text-green-700 font-bold text-sm bg-white/60 rounded-xl flex items-center justify-center gap-2">üéâ ÊÅ≠ÂñúËææÊàêÔºÅ</div>` : `<button onclick="actions.start('${plan.id}')" class="w-full bg-white text-indigo-600 py-3 rounded-xl font-bold shadow-sm border border-indigo-100 flex items-center justify-center gap-2 active:scale-95 transition-transform hover:bg-indigo-50">${Icons.Play} ÂºÄÂßã‰∏ìÊ≥®</button>`}</div>`;
            }).join('') : `<div class="text-center py-12 text-slate-300"><div class="mb-2 text-4xl opacity-50">üçÉ</div><p class="text-xs font-medium">${isToday ? '‰ªäÂ§©' : 'Ëøô‰∏ÄÂ§©'}ËøôÈáåÂæàÂÆâÈùôÔºåÊ∑ªÂä†‰∏Ä‰∏™ÁõÆÊ†áÂêß</p></div>`;

            const goals = state.customGoals.map(g => {
                const qtyPct = Math.min(100, Math.round((g.currentQty / g.targetQty) * 100));
                const isQtyDone = g.currentQty >= g.targetQty;
                return `<div class="bg-white rounded-[20px] p-5 border border-slate-100 mb-4 relative group transition-all hover:shadow-lg shadow-sm"><div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="actions.openEditGoal('${g.id}')" class="text-slate-300 hover:text-indigo-500"><i data-lucide="pencil" class="w-3 h-3"></i></button><button onclick="actions.delGoal('${g.id}')" class="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div><div class="flex justify-between items-center mb-4"><div class="flex items-center gap-2"><span class="font-bold text-lg text-slate-800">${g.name}</span>${isQtyDone ? '<span class="text-[10px] bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full border border-yellow-200 font-bold">Â∑≤ËææÊàê</span>' : ''}</div><div class="text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded font-medium">ÁõÆÊ†á: ${g.targetQty} ${g.unit}</div></div>${renderProgressBar(g.accumulatedWords, g.targetWords, "Â≠óÊï∞ËøõÂ∫¶")}<div class="flex items-center gap-3 mt-4 pt-3 border-t border-slate-50"><span class="text-xs font-bold text-slate-400">Êï∞ÈáèËøõÂ∫¶</span><div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden"><div class="h-full bg-yellow-400 rounded-full" style="width: ${qtyPct}%"></div></div><div class="text-xs font-mono text-slate-500 w-12 text-right">${g.currentQty}/${g.targetQty}</div><button onclick="actions.addQty('${g.id}')" class="w-8 h-8 bg-green-50 text-green-600 rounded-full flex items-center justify-center font-bold text-xs hover:bg-green-100 transition-colors shadow-sm border border-green-100">+1</button></div></div>`;
            }).join('');

            const maxDateStr = MAX_FUTURE_DATE_STR;

            return `<div class="flex flex-col h-full bg-gray-50 overflow-hidden"><div class="bg-slate-800 text-white p-5 pb-8 rounded-b-[30px] shadow-lg shrink-0 -mb-6 z-10 relative"><div class="flex justify-between items-center"><div><div class="text-xs text-indigo-300 font-bold uppercase tracking-wider mb-1 flex items-center gap-1">üéì ${state.globalGoalType}ÂÄíËÆ°Êó∂</div><div class="text-2xl font-bold tracking-tight">${days !== null ? `ËøòÊúâ <span class="text-yellow-400 font-black text-3xl mx-1">${days}</span> Â§©` : 'ÁÇπÂáªËÆæÁΩÆ'}</div></div><button onclick="actions.toggleGrad()" class="bg-white/10 p-2 rounded-full text-white hover:bg-white/20 transition">${Icons.Settings}</button></div>
            
            ${state.showGradSettings ? `<div class="absolute inset-x-4 top-20 bg-white shadow-xl p-5 rounded-2xl z-30 animate-scale-in border border-slate-100 flex flex-col gap-4">
                <h3 class="text-lg font-bold text-slate-800 border-b border-slate-50 pb-2">ËÆæÁΩÆÂÄíËÆ°Êó∂ÁõÆÊ†á</h3>
                <div>
                    <label class="text-[13px] font-bold text-slate-700 mb-1 block">ÂÄíËÆ°Êó∂Êó•Êúü</label>
                    <input type="date" id="grad-date-input" value="${state.graduationDate}" max="${maxDateStr}" class="w-full bg-slate-50 text-slate-800 border border-slate-200 rounded-lg p-2.5 outline-none font-medium">
                </div>
                <div class="pt-2">
                    <label class="text-[13px] font-bold text-indigo-600 mb-3 block">ÁõÆÊ†á‰ø°ÊÅØ</label>
                    <div class="grid grid-cols-1 gap-3">
                        <div>
                            <label class="text-[13px] font-bold text-slate-700 block mb-1.5">ÁõÆÊ†áÁ±ªÂûãÔºàÂ¶ÇÔºöÊØï‰∏ö„ÄÅÁªìÈ¢ò„ÄÅËØÑËÅåÁß∞Ôºâ</label>
                            <input type="text" id="global-type-input" value="${state.globalGoalType}" placeholder="‰æãÂ¶ÇÔºöËØæÁ®ãÊØï‰∏ö / ÂçöÂ£´Á≠îËæ© / È°πÁõÆÁªìÈ¢ò / ËÅåÁß∞ËØÑÂÆ°" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 text-[15px] outline-none text-slate-900 placeholder:text-gray-400 font-medium">
                        </div>
                        <div>
                            <label class="text-[13px] font-bold text-slate-700 block mb-1.5">ÁõÆÊ†áÂêçÁß∞ÔºàÂ¶ÇÔºöËÆ∫ÊñáÈ¢òÁõÆ„ÄÅÈ°πÁõÆÂêçÁß∞Ôºâ</label>
                            <input type="text" id="global-name-input" value="${state.globalGoalName}" placeholder="‰æãÂ¶ÇÔºöÂçöÂ£´ËÆ∫Êñá / Âü∫ÈáëÈ°πÁõÆ / ‰∏ìËëó / ÊïôÂ≠¶ÊàêÊûú" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 text-[15px] outline-none text-slate-900 placeholder:text-gray-400 font-medium">
                        </div>
                    </div>
                </div>
                <button onclick="actions.saveGradSettings()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-200 active:scale-95 transition-transform mt-2">‰øùÂ≠òËÆæÁΩÆ</button>
            </div>` : ''}
            
            </div><div class="flex-1 overflow-y-auto px-4 pt-10 pb-32 space-y-6">
            
            <div class="flex justify-between items-center bg-white p-2 rounded-2xl shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-slate-50">
                <button onclick="actions.changeDate(-1)" class="p-3 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition">${Icons.Left}</button>
                <div class="flex flex-col items-center cursor-pointer group" onclick="actions.openMainCalendar()">
                    <span class="text-lg font-bold text-slate-800">${dateStr}</span>
                    ${isToday ? `<span class="text-xs text-indigo-600 font-bold bg-indigo-50 px-3 py-0.5 rounded-full mt-1 border border-indigo-100 flex items-center gap-1">‰ªäÂ§© ¬∑ ${weekStr}</span>` : `<span class="text-xs text-slate-400 font-bold bg-slate-50 px-3 py-0.5 rounded-full mt-1 border border-slate-100 group-hover:bg-indigo-50 group-hover:text-indigo-500 transition flex items-center gap-1"><i data-lucide="calendar" class="w-3 h-3"></i> ÂàáÊç¢Êó•Êúü</span>`}
                </div>
                <button onclick="actions.changeDate(1)" class="p-3 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition">${Icons.Right}</button>
            </div>

            <div class="bg-gradient-psych p-4 rounded-[20px] flex gap-3 items-start shadow-sm relative overflow-hidden"><div class="absolute -right-2 -top-2 text-6xl opacity-10">‚ú®</div><div class="mt-1 bg-white p-1.5 rounded-full shadow-sm text-indigo-500"><i data-lucide="sparkles" class="w-4 h-4"></i></div><div><h4 class="text-xs font-bold text-indigo-400 mb-1 uppercase tracking-wider">ÂøÉÁêÜËÉΩÈáèÁ´ô</h4>
            
            <p id="daily-quote-display" class="text-sm text-slate-700 italic font-medium leading-relaxed">"${state.dailyQuote}"</p>
            
            </div></div><div><h3 class="text-sm font-bold text-slate-400 mb-4 uppercase tracking-wider px-1 flex items-center gap-2"><div class="w-1 h-4 bg-indigo-400 rounded-full"></div> ${isToday?'‰ªäÊó•':weekStr}‰∏ìÊ≥®</h3>${plansHtml}<button onclick="actions.openAddPlan()" class="w-full bg-white border-2 border-dashed border-indigo-100 rounded-[24px] p-4 text-indigo-400 font-bold flex items-center justify-center gap-2 hover:bg-indigo-50 transition-colors mt-6">${Icons.Plus} Ê∑ªÂä†${isToday?'‰ªäÊó•':'ËØ•Êó•'}‰∏ìÊ≥®</button></div>
            
            <div class="grid grid-cols-3 gap-2">
                <div class="bg-white p-3 rounded-[20px] border border-indigo-50 shadow-sm flex flex-col justify-center items-center text-center">
                    <div class="text-[10px] text-slate-400 mb-1 font-bold">Â∑≤ÂÜôÊÄªÂ≠óÊï∞</div>
                    <div class="text-xl font-black text-slate-800">${total.toLocaleString()}</div>
                </div>
                <div class="bg-white p-3 rounded-[20px] border border-purple-50 shadow-sm flex flex-col justify-center items-center text-center">
                    <div class="text-[10px] text-slate-400 mb-1 font-bold">Êó•Âùá‰∫ßÂá∫</div>
                    <div class="text-xl font-black text-slate-800">${dailyAvg.toLocaleString()}</div>
                </div>
                <div class="bg-white p-3 rounded-[20px] border border-orange-50 shadow-sm flex flex-col justify-center items-center text-center">
                    <div class="text-[10px] text-slate-400 mb-1 font-bold">‰ªäÂ§©Êñ∞Â¢û</div>
                    <div class="text-xl font-black text-slate-800">${today.toLocaleString()}</div>
                </div>
            </div>
            
            <div><div class="flex justify-between items-center mb-4 px-1 mt-6"><h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2"><div class="w-1 h-4 bg-yellow-400 rounded-full"></div> ${state.globalGoalType}ÊÄªÁõÆÊ†á</h3><button onclick="actions.openAddGoal()" class="text-xs text-indigo-600 font-bold bg-indigo-50 hover:bg-indigo-100 px-3 py-1.5 rounded-lg transition">+ Êñ∞Âª∫ÁõÆÊ†á</button></div>${goals}</div></div></div>`;
        }

        function renderWorking() {
            const plan = state.dailyPlans.find(p => p.id === state.currentSession.planId);
            const goalTitle = plan ? plan.content : 'Ëá™Áî±ÂÜô‰Ωú';
            const net = (parseInt(state.formData.endCount)||state.currentSession.startCount) - state.currentSession.startCount;
            return `<div class="flex flex-col h-full bg-gray-50 pb-safe overflow-y-auto"><div class="bg-white p-6 pb-8 border-b border-slate-100 shadow-sm mb-4 relative overflow-hidden"><div class="absolute top-0 right-0 w-40 h-40 bg-indigo-50 rounded-full -mr-12 -mt-12 blur-3xl opacity-60"></div><div class="flex justify-between items-start mb-6 relative z-10"><div class="inline-flex items-center gap-1 bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold animate-pulse-soft border border-indigo-100"><span class="w-2 h-2 bg-indigo-500 rounded-full"></span> ‰∏ìÊ≥®Ê®°Âºè</div><button onclick="actions.cancelSession()" class="text-slate-400 hover:text-red-500 bg-slate-50 p-2 rounded-full">${Icons.X}</button></div><h2 class="text-3xl font-bold text-slate-800 mb-2 relative z-10">${goalTitle}</h2><div class="text-slate-500 text-sm mb-6 relative z-10">ÂºÄÂßã‰∫é <span class="font-mono font-bold text-indigo-500">${new Date(state.currentSession.start).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div><div class="flex items-center gap-2 text-sm text-slate-400 mb-6 relative z-10 bg-slate-50 p-3 rounded-xl border border-slate-100 inline-flex"><span>ÂàùÂßãÂ≠óÊï∞: ${state.currentSession.startCount}</span><button onclick="actions.adjustStart()" class="text-indigo-500 text-xs font-bold hover:underline bg-white px-2 py-1 rounded shadow-sm">‰øÆÊ≠£</button></div><div class="bg-gradient-to-br from-indigo-50 to-white rounded-2xl p-5 border border-indigo-100 relative z-10 text-center shadow-sm"><div class="text-xs text-indigo-400 font-bold mb-1 uppercase tracking-wider">Êú¨Ê¨°‰∫ßÂá∫</div><div class="text-5xl font-black text-indigo-600" id="net-word-display">${net > 0 ? '+' + net : net}</div></div></div><form onsubmit="actions.end(event)" class="px-4 space-y-4 flex-1 flex flex-col"><div class="bg-white p-5 rounded-[24px] shadow-sm border border-slate-100"><label class="text-sm font-bold text-slate-500 mb-3 block text-center">ÁªìÊùüÂ≠óÊï∞</label><input type="number" name="endCount" required value="${state.formData.endCount||''}" oninput="actions.setFormData('endCount',this.value)" class="text-5xl font-black text-slate-800 w-full text-center outline-none border-b-2 border-transparent focus:border-indigo-100 bg-transparent py-2 placeholder-slate-200" placeholder="${state.currentSession.startCount}"></div><div class="bg-white p-5 rounded-[24px] shadow-sm border border-slate-100 space-y-4 flex-1"><div><label class="text-sm font-bold text-slate-500 mb-3 block">Áä∂ÊÄÅ & ÊÑüÊÉ≥</label><div class="flex justify-around mb-6">${['happy','neutral','sad','tired'].map(m => `<button type="button" onclick="actions.setMood('${m}')"><i data-lucide="${{happy:'smile',neutral:'meh',sad:'frown',tired:'coffee'}[m]}" class="w-10 h-10 mood-icon ${state.formData.mood===m?'selected text-indigo-500':'text-slate-300'}"></i></button>`).join('')}</div><textarea name="reflection" placeholder="ÂÜôÂæóÊÄé‰πàÊ†∑ÔºüËÆ∞ÂΩï‰∏Ä‰∏ãÊ≠§ÂàªÁöÑÂøÉÊÉÖ..." oninput="actions.setFormData('reflection',this.value)" class="w-full bg-slate-50 border border-slate-100 rounded-2xl p-4 text-sm h-32 resize-none outline-none focus:ring-2 focus:ring-indigo-100 transition">${state.formData.reflection}</textarea></div></div><button class="w-full primary-gradient text-white font-bold py-4 rounded-[20px] shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 mt-4 active:scale-95 transition-transform">${Icons.Check} ÂÆåÊàêÊâìÂç°</button></form></div>`;
        }

        function renderAddEntry() {
            const goalOptions = state.customGoals.map(g => `<option value="${g.id}" ${g.id === state.formData.linkedGoalId ? 'selected' : ''}>${g.name} (‰∏äÊ¨°ÁªìÊùü: ${getLastCountForGoal(g.id)})</option>`).join('');
            const net = (parseInt(state.formData.endCount)||state.formData.startCount) - state.formData.startCount;
            const maxDateStr = MAX_FUTURE_DATE_STR;

            return `<div class="pb-safe h-full overflow-y-auto bg-gray-50"><div class="px-5 pt-8 pb-32"><h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2">üìù Ë°•ÂΩïÊâìÂç°</h2><form onsubmit="actions.end(event)" class="space-y-5"><div class="bg-white p-6 rounded-[24px] shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-slate-50"><div class="mb-5"><label class="text-xs font-bold text-slate-400 mb-2 block uppercase tracking-wider">Êó•Êúü</label><input type="date" name="date" value="${state.formData.date || getTodayStr()}" max="${maxDateStr}" onchange="actions.setFormData('date',this.value)" class="w-full bg-slate-50 border border-slate-100 rounded-xl p-3 text-sm outline-none focus:border-indigo-500 font-medium"></div><div class="mb-5"><label class="text-xs font-bold text-slate-400 mb-2 block uppercase tracking-wider">ÂÖ≥ËÅîÁõÆÊ†á</label><select onchange="actions.setFormData('linkedGoalId',this.value)" class="w-full bg-slate-50 border border-slate-100 rounded-xl p-3 text-sm outline-none focus:border-indigo-500 font-medium appearance-none">${goalOptions}</select></div><div class="grid grid-cols-2 gap-4 mb-5"><div><label class="text-xs font-bold text-slate-400 mb-2 block uppercase tracking-wider">ÂºÄÂßãÂ≠óÊï∞</label><div class="flex items-center"><button type="button" onclick="actions.adjustManualStart(-100)" class="p-3 bg-slate-100 rounded-l-xl text-slate-500 hover:bg-slate-200 font-bold">-</button><input type="number" name="startCount" value="${state.formData.startCount}" oninput="actions.setFormData('startCount',this.value)" class="w-full text-center bg-slate-50 border-y border-slate-100 py-3 text-sm font-bold outline-none"><button type="button" onclick="actions.adjustManualStart(100)" class="p-3 bg-slate-100 rounded-r-xl text-slate-500 hover:bg-slate-200 font-bold">+</button></div></div><div><label class="text-xs font-bold text-slate-400 mb-2 block uppercase tracking-wider">ÁªìÊùüÂ≠óÊï∞</label><input type="number" name="endCount" required value="${state.formData.endCount}" oninput="actions.setFormData('endCount',this.value)" class="w-full bg-white border-2 border-indigo-100 rounded-xl p-2.5 text-lg font-bold text-center outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-50 transition"></div></div><div class="flex justify-between items-center bg-indigo-50 p-4 rounded-xl"><span class="text-sm text-indigo-400 font-bold">Êú¨Ê¨°ÂáÄÂ¢û</span><span id="net-word-display" class="font-black text-2xl text-indigo-600">${net} Â≠ó</span></div></div><div class="bg-white p-6 rounded-[24px] shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-slate-50 space-y-6"><div><div class="flex justify-between items-center mb-4"><label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Áä∂ÊÄÅ & ÊÑüÊÉ≥</label><button type="button" onclick="actions.autoGenReflection()" class="text-xs bg-purple-50 text-purple-600 px-3 py-1.5 rounded-lg flex items-center gap-1 font-bold hover:bg-purple-100 transition">${Icons.Wand} Â∏ÆÊàëÂÜô</button></div><div class="flex justify-around mb-6">${['happy','neutral','sad','tired'].map(m => `<button type="button" onclick="actions.setMood('${m}')">${MoodIcon(m, state.formData.mood === m)}</button>`).join('')}</div><textarea name="reflection" placeholder="Â¶ÇÊûú‰∏çÂÜôÔºåÊàëÂ∞±Â∏Æ‰Ω†Ëá™Âä®ÁîüÊàêÂï¶~" oninput="actions.setFormData('reflection',this.value)" class="w-full bg-slate-50 border border-slate-100 rounded-xl p-4 text-sm h-28 resize-none outline-none focus:ring-2 focus:ring-indigo-100 transition">${state.formData.reflection}</textarea></div><div><div class="flex justify-between items-center mb-3"><label class="text-xs font-bold text-slate-400 uppercase tracking-wider">ÊäïÂÖ•Êó∂Èïø</label><span id="duration-display" class="text-sm font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded-lg min-w-[4rem] text-center">${state.formData.duration || '0 Â∞èÊó∂'}</span></div><div class="px-2 py-2"><input type="range" min="0" max="12" step="0.5" value="${state.formData.durationNum || 0}" oninput="actions.updateDuration(this.value)"><div class="flex justify-between text-[10px] text-slate-300 mt-2 font-mono"><span>0h</span><span>6h</span><span>12h</span></div></div></div><div><label class="text-xs font-bold text-slate-400 mb-2 block uppercase tracking-wider">ÂÆåÊàêÂÜÖÂÆπ (ÈÄâÂ°´)</label><input type="text" name="chapter" value="${state.formData.chapter}" oninput="actions.setFormData('chapter',this.value)" placeholder="‰æãÂ¶ÇÔºöÁ¨¨‰∏âÁ´†ÊñáÁåÆÁªºËø∞" class="w-full bg-slate-50 border border-slate-100 rounded-xl p-3 text-sm outline-none focus:border-indigo-300"></div></div><button class="w-full primary-gradient text-white font-bold py-4 rounded-[20px] shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 active:scale-95 transition-transform">${Icons.Check} Êèê‰∫§ÊâìÂç°</button></form></div></div>`;
        }

        function renderRank() {
            if(state.loadingLeaderboard) return `<div class="p-10 text-center text-slate-400 flex flex-col items-center gap-2"><div class="spinner"></div><p class="text-xs">Ê¶úÂçïÂà∑Êñ∞‰∏≠...</p></div>`;
            const list = state.leaderboard.map((u,i)=> {
                let rankBadge = `<span class="font-bold w-6 text-center text-slate-400">${i+1}</span>`;
                if(i===0) rankBadge = `<span class="text-xl">ü•á</span>`;
                if(i===1) rankBadge = `<span class="text-xl">ü•à</span>`;
                if(i===2) rankBadge = `<span class="text-xl">ü•â</span>`;
                return `<div class="flex items-center gap-3 p-4 bg-white border border-slate-100 rounded-[20px] mb-3 shadow-[0_2px_10px_rgba(0,0,0,0.02)]"><div class="w-8 flex justify-center">${rankBadge}</div><img src="${u.avatar}" class="w-10 h-10 rounded-full border-2 border-white shadow-sm"><span class="flex-1 font-bold text-sm text-slate-700">${u.username}</span><div class="bg-indigo-50 px-3 py-1 rounded-full"><span class="font-black text-indigo-600 text-sm">${u.wordCount}</span> <span class="text-xs text-indigo-400">Â≠ó</span></div></div>`;
            }).join('');
            return `<div class="p-4 bg-gray-50 h-full overflow-y-auto pb-32"><div class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white p-6 rounded-[24px] shadow-lg mb-6 relative overflow-hidden"><div class="absolute right-0 top-0 text-6xl opacity-20">üèÜ</div><h2 class="font-bold text-xl mb-1">‰ªäÊó•ÈæôËôéÊ¶ú</h2><p class="text-xs opacity-90">ÁúãËßÅÂùöÊåÅÁöÑÂäõÈáè ¬∑ ÂÖ®ÁΩëÂêåÊ≠•</p></div>${list||'<div class="flex flex-col items-center justify-center py-20 opacity-50"><div class="text-4xl mb-2">üçÉ</div><p class="text-sm">‰ªäÊó•ËøòÊ≤°Êúâ‰∫∫ÊâìÂç°Âì¶</p></div>'}</div>`;
        }

        function renderHistory() {
            const list = state.entries.slice().reverse().map(e=>`<div class="bg-white p-5 rounded-[24px] border border-slate-100 shadow-sm mb-4 relative overflow-hidden"><div class="absolute left-0 top-0 bottom-0 w-2 bg-indigo-500"></div><div class="pl-3"><div class="flex justify-between mb-2"><span class="text-xs font-bold text-slate-400 bg-slate-50 px-2 py-0.5 rounded">${e.date}</span><span class="text-green-600 font-bold bg-green-50 px-2 py-0.5 rounded">+${e.dailyCount}Â≠ó</span></div><div class="text-base font-bold text-slate-800 mb-2">${e.linkedPlanContent || e.linkedGoalName || 'Ëá™Áî±ÂÜô‰Ωú'}</div><div class="text-sm text-slate-500 bg-slate-50 p-3 rounded-xl italic">"${e.reflection||'Êó†ÊÑüÊÉ≥'}"</div>${e.duration ? `<div class="mt-2 text-xs text-slate-400 flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ÊäïÂÖ•Êó∂Èïø: ${e.duration}</div>` : ''}</div></div>`).join('');
            return `<div class="p-4 bg-gray-50 h-full overflow-y-auto pb-32"><div class="flex justify-between items-center mb-6 px-1"><h2 class="font-bold text-xl text-slate-800">ÂéÜÂè≤Ë∂≥Ëøπ</h2><span class="text-xs text-slate-400 bg-white px-2 py-1 rounded-full border border-slate-100 shadow-sm">ÂΩìÂâçË¥¶Âè∑: ${state.user.username}</span></div>${list||'<p class="text-center text-slate-400 mt-20">Á©∫Á©∫Â¶Ç‰πüÔºåÂéªÂÜô‰∏ãÁ¨¨‰∏ÄÁ¨îÂêßÔºÅ</p>'}</div>`;
        }

        function renderArticles() {
            let articleList = '';
            if (state.articles.length > 0) {
                articleList = state.articles.map(article => {
                    const milestones = article.milestones || [];
                    const totalSteps = milestones.length > 0 ? milestones.length : 1;
                    const completedSteps = milestones.filter(m => m.date).length;
                    const progressPct = Math.min(100, Math.round((completedSteps / totalSteps) * 100));

                    const sortedMilestones = [...milestones].sort((a,b) => {
                        if(!a.date) return 1; 
                        if(!b.date) return -1;
                        return new Date(a.date) - new Date(b.date);
                    });

                    const timelineHtml = sortedMilestones.map((node, index) => {
                        const isDone = !!node.date;
                        return `
                        <div class="flex gap-3 relative group">
                            <div class="timeline-line"></div>
                            <div class="flex flex-col items-center relative z-10">
                                <div class="w-3 h-3 rounded-full ${isDone ? 'bg-indigo-500' : 'bg-slate-300'} border-2 border-white shadow-sm"></div>
                            </div>
                            <div class="pb-6 flex-1">
                                <div class="flex items-center justify-between mb-0.5">
                                    <span class="text-sm font-bold ${isDone ? 'text-slate-800' : 'text-slate-400'}">${node.label}</span>
                                    ${node.date ? `<span class="text-xs text-slate-500 font-mono bg-slate-50 px-1.5 rounded">${node.date}</span>` : ''}
                                </div>
                                ${node.note ? `<div class="text-xs text-slate-400 mt-1">${node.note}</div>` : ''}
                            </div>
                        </div>`;
                    }).join('');

                    return `
                    <div class="bg-white rounded-[24px] p-5 shadow-[0_4px_20px_rgba(0,0,0,0.03)] mb-5 border border-slate-50 relative group transition-all duration-300">
                        <div class="mb-4">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center flex-wrap gap-2">
                                    <span class="${getArticleTypeClass(article.type)} text-[10px] font-bold px-2 py-0.5 rounded-full">${article.type || 'ÊúüÂàäËÆ∫Êñá'}</span>
                                    <span class="bg-indigo-50 text-indigo-600 text-[10px] font-bold px-2 py-0.5 rounded-full border border-indigo-100">${article.status || 'Êú™ËÆæÁΩÆÁä∂ÊÄÅ'}</span>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="actions.openEditArticle(${article.id})" class="text-slate-300 hover:text-indigo-500 p-1.5 rounded-full hover:bg-indigo-50 transition"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></button>
                                    <button onclick="actions.deleteArticle(${article.id})" class="text-slate-300 hover:text-red-500 p-1.5 rounded-full hover:bg-red-50 transition"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                                </div>
                            </div>
                            <h3 class="text-lg font-bold text-slate-800 leading-tight mb-1 pr-4">${article.title}</h3>
                            <div class="text-xs text-slate-400 font-medium">${article.journal || 'Êú™Â°´ÂÜôÊúüÂàä/Êù•Ê∫ê'}</div>
                        </div>
                        <div class="flex items-end gap-3 mb-2">
                            <div class="flex-1">
                                <div class="flex justify-between text-[10px] text-slate-400 mb-1">
                                    <span class="font-bold text-indigo-400 uppercase tracking-wider">ËøõÂ∫¶Ê¶ÇËßà</span>
                                    <span>Â∑≤ÂÆåÊàê ${completedSteps} / ${totalSteps} ËäÇÁÇπ</span>
                                </div>
                                <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-indigo-500 rounded-full transition-all duration-500" style="width: ${progressPct}%"></div>
                                </div>
                            </div>
                            <button id="article-toggle-btn-${article.id}" onclick="actions.toggleArticleDetails(${article.id})" class="text-slate-400 hover:text-indigo-600 transition-transform duration-300 p-1">
                                <i data-lucide="chevron-down" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div id="article-details-${article.id}" class="hidden pt-4 mt-4 border-t border-slate-50 animate-fade-in">
                            <div class="pl-1 mb-2">
                                ${timelineHtml}
                            </div>
                            ${(article.reviewNotes || article.notes) ? `
                            <div class="bg-gray-50 rounded-xl p-3 space-y-3 mt-4 border border-slate-100">
                                ${article.reviewNotes ? `
                                    <div>
                                        <div class="text-[10px] font-bold text-indigo-400 uppercase mb-1">ÂÆ°Á®øÊëòË¶Å</div>
                                        <div class="text-xs text-slate-600 leading-relaxed whitespace-pre-wrap">${article.reviewNotes}</div>
                                    </div>` : ''}
                                ${article.notes ? `
                                    <div>
                                        <div class="text-[10px] font-bold text-indigo-400 uppercase mb-1">Â§áÊ≥®</div>
                                        <div class="text-xs text-slate-600 leading-relaxed whitespace-pre-wrap">${article.notes}</div>
                                    </div>` : ''}
                            </div>` : ''}
                        </div>
                    </div>`;
                }).join('');
            } else {
                articleList = `<div class="text-center py-20 opacity-50"><div class="text-4xl mb-4">üìÑ</div><p class="text-sm font-medium text-slate-500">ËøòÊ≤°ÊúâÊñáÁ´†ËÆ∞ÂΩï<br>ÁÇπÂáªÂè≥‰∏äËßíÊ∑ªÂä†Á¨¨‰∏ÄÁØáÂêß</p></div>`;
            }

            return `<div class="flex flex-col h-full bg-gray-50 overflow-hidden"><div class="px-5 pt-6 pb-2 shrink-0 flex justify-between items-end mb-2"><div><h2 class="text-2xl font-bold text-slate-800">ÊñáÁ´†Áä∂ÊÄÅ</h2><p class="text-xs text-slate-400 mt-1">‰ªéÊäïÁ®øÂà∞ÂΩïÁî®Ôºå‰∏ÄÁõÆ‰∫ÜÁÑ∂</p></div><button onclick="actions.openAddArticle()" class="bg-indigo-600 text-white rounded-xl px-4 py-2 font-bold text-xs shadow-lg shadow-indigo-200 active:scale-95 transition-transform flex items-center gap-1">${Icons.Plus} Êñ∞Â¢û</button></div><div class="flex-1 overflow-y-auto px-4 pb-32 hide-scrollbar">${articleList}</div></div>`;
        }

        // --- Main Render ---
        function render() {
            const app = document.getElementById('app');
            if (!app) return;
            cleanOldPlans();
            
            renderCalendarComponent();
            renderMainCalendarComponent();

            let htmlContent = '';
            
            if (state.view === 'login') {
                htmlContent = renderLogin();
            } else if (state.view === 'app') {
                if (state.currentSession && state.currentSession.isActive) {
                    htmlContent = renderWorking();
                } else {
                    let content = '';
                    if (state.activeTab === 'dashboard') content = renderDashboard();
                    else if (state.activeTab === 'rank') content = renderRank();
                    else if (state.activeTab === 'add') content = renderAddEntry();
                    else if (state.activeTab === 'articles') content = renderArticles();
                    else content = renderHistory(); 
                    
                    const sidebar = state.showSidebar ? `<div class="fixed inset-0 bg-black/50 z-40 animate-fade-in" onclick="actions.toggleSidebar()"></div><div class="fixed top-0 left-0 h-full w-64 bg-white z-50 shadow-2xl p-0 flex flex-col animate-slide-up" style="animation-direction: normal; animation-name: slide-right;"><div class="p-6 border-b border-slate-100 bg-slate-50"><div class="flex items-center gap-3 mb-4"><img src="${state.user.avatar}" class="w-14 h-14 rounded-full border-2 border-white shadow-sm"><div><h3 class="font-bold text-slate-800">${state.user.username}</h3><button onclick="actions.editProfile()" class="text-xs text-indigo-500">ÁºñËæëËµÑÊñô</button></div></div><div class="bg-white p-3 rounded-lg border border-slate-200"><div class="text-xs text-slate-400 mb-1">Á¥ØËÆ°‰∫ßÂá∫</div><div class="text-sm font-bold text-slate-800">${state.entries.reduce((a,b)=>a+b.dailyCount,0).toLocaleString()} Â≠ó</div></div></div><div class="p-2 space-y-1"><button onclick="actions.askLogout()" class="w-full flex items-center gap-3 p-3 text-slate-600 hover:bg-slate-50 rounded-xl"><span class="text-indigo-500">${Icons.Switch}</span> ÂàáÊç¢Ë¥¶Âè∑</button><button onclick="actions.askLogout()" class="w-full flex items-center gap-3 p-3 text-red-500 hover:bg-red-50 rounded-xl"><span class="text-red-500">${Icons.LogOut}</span> ÈÄÄÂá∫ÁôªÂΩï</button></div></div>` : '';

                    let modals = '';
                    if (state.showPlanModal) {
                        const isEdit = !!state.editingPlanId;
                        const options = state.customGoals.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
                        modals += `<div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="actions.closePlanModal()"><div class="bg-white rounded-2xl p-6 w-full max-w-sm" onclick="event.stopPropagation()"><h3 class="font-bold text-lg mb-4 text-slate-800">${isEdit ? 'ÁºñËæëÁõÆÊ†á' : 'Ê∑ªÂä†‰ªäÊó•‰∏ìÊ≥®'}</h3><form onsubmit="actions.savePlan(event)" class="space-y-3"><div><label class="text-xs text-slate-500 font-bold ml-1">ÂÖ≥ËÅîÊØï‰∏öÁõÆÊ†á</label><select onchange="actions.setPlanForm('linkedGoalId',this.value)" class="w-full bg-gray-50 border p-2 rounded-lg text-sm">${options}</select></div><div><label class="text-xs text-slate-500 font-bold ml-1">ÂÖ∑‰ΩìÂÜÖÂÆπ</label><input value="${state.planFormData.content}" oninput="actions.setPlanForm('content',this.value)" class="w-full border p-2 rounded-lg" required></div><div><label class="text-xs text-slate-500 font-bold ml-1">È¢ÑËÆ°Â≠óÊï∞</label><input type="number" value="${state.planFormData.target}" oninput="actions.setPlanForm('target',this.value)" class="w-full border p-2 rounded-lg" required></div><button class="w-full primary-gradient text-white py-3 rounded-xl font-bold mt-2">‰øùÂ≠ò</button></form></div></div>`;
                    }
                    if (state.showGoalModal) {
                        const isEdit = !!state.editingGoalId;
                        modals += `<div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="actions.toggleGoalModal()"><div class="bg-white rounded-2xl p-6 w-full max-w-sm" onclick="event.stopPropagation()"><h3 class="font-bold text-lg mb-4">${isEdit?'ÁºñËæë':'Ê∑ªÂä†'}ÊØï‰∏öÁõÆÊ†á</h3><div class="space-y-3"><input placeholder="ÂêçÁß∞ (Â¶Ç: SCIËÆ∫Êñá)" value="${state.newGoalData.name}" oninput="actions.setNewGoal('name',this.value)" class="w-full border p-2 rounded"><div class="flex gap-2"><input type="number" placeholder="Êï∞Èáè (3)" value="${state.newGoalData.targetQty}" oninput="actions.setNewGoal('targetQty',this.value)" class="w-full border p-2 rounded"><input placeholder="Âçï‰Ωç (ÁØá)" value="${state.newGoalData.unit}" oninput="actions.setNewGoal('unit',this.value)" class="w-20 border p-2 rounded"></div><input type="number" placeholder="È¢ÑËÆ°ÊÄªÂ≠óÊï∞ (Â¶Ç: 50000)" value="${state.newGoalData.targetWords}" oninput="actions.setNewGoal('targetWords',this.value)" class="w-full border p-2 rounded"></div><div class="flex gap-2 mt-4"><button onclick="actions.toggleGoalModal()" class="flex-1 py-2 text-slate-500">ÂèñÊ∂à</button><button onclick="actions.saveGoal()" class="flex-1 primary-gradient text-white rounded">‰øùÂ≠ò</button></div></div></div>`;
                    }
                    if (state.showLogoutModal) {
                        modals += `<div class="fixed inset-0 bg-black/60 z-[80] flex items-center justify-center p-6 animate-fade-in" onclick="actions.cancelLogout()"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-xl animate-scale-in" onclick="event.stopPropagation()"><h3 class="text-lg font-bold text-center mb-2">Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÂêóÔºü</h3><div class="flex gap-3 mt-6"><button onclick="actions.cancelLogout()" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold">ÂèñÊ∂à</button><button onclick="actions.confirmLogout()" class="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold">Á°ÆËÆ§ÈÄÄÂá∫</button></div></div></div>`;
                    }
                    if (state.showFeedback) {
                        modals += `<div class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-6"><div class="bg-white rounded-2xl p-6 w-full max-w-sm text-center"><div class="text-4xl mb-2">üéâ</div><h3 class="font-bold text-xl mb-1">ÊâìÂç°ÊàêÂäü!</h3><p class="text-slate-500 mb-4">Êú¨Ê¨°‰∫ßÂá∫ <span class="font-bold text-indigo-600">${state.feedbackData.diff}</span> Â≠ó</p><div class="bg-indigo-50 p-4 rounded-xl text-indigo-800 text-sm mb-4 italic">"${state.feedbackData.encourageMsg}"</div><button onclick="actions.closeFeedback()" class="w-full primary-gradient text-white py-3 rounded-xl font-bold">Â•ΩÁöÑ</button></div></div>`;
                    }
                    if (state.showProfileModal) {
                        modals += `<div class="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-6" onclick="actions.closeProfile()"><div class="bg-white rounded-2xl p-6 w-full max-w-sm" onclick="event.stopPropagation()"><h3 class="font-bold text-lg mb-4">ÁºñËæëËµÑÊñô</h3><div class="text-center mb-4"><img src="${state.tempProfile.avatar}" class="w-20 h-20 rounded-full mx-auto mb-2"><button onclick="actions.randAvatar()" class="text-xs text-indigo-500">Êç¢‰∏™Â§¥ÂÉè</button></div><input value="${state.tempProfile.name}" oninput="actions.setTempProfile('name',this.value)" class="w-full border p-2 rounded mb-4 text-center font-bold"><button onclick="actions.saveProfile(event)" class="w-full primary-gradient text-white py-3 rounded-xl">‰øùÂ≠ò</button></div></div>`;
                    }
                    if (state.showArticleModal) {
                        const d = state.articleFormData;
                        modals += `
                        <div class="fixed inset-0 bg-black/60 z-[60] flex items-end sm:items-center justify-center" onclick="actions.toggleArticleModal()">
                            <div class="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-[30px] p-6 max-h-[90vh] overflow-y-auto animate-slide-up" onclick="event.stopPropagation()">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="font-bold text-xl text-slate-800">${d.id ? 'ÁºñËæëÊñáÁ´†Áä∂ÊÄÅ' : 'üìù ËÆ∞ÂΩïÊñáÁ´†Áä∂ÊÄÅ'}</h3>
                                    <button onclick="actions.toggleArticleModal()" class="text-slate-400 bg-slate-50 p-2 rounded-full hover:bg-slate-100">${Icons.X}</button>
                                </div>
                                <form onsubmit="actions.saveArticle(event)" class="space-y-5">
                                    <div class="space-y-4">
                                        <div>
                                            <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Âü∫Êú¨‰ø°ÊÅØ *</label>
                                            <div class="flex gap-2 mb-2">
                                                <input type="text" id="article-title-input" placeholder="ÊñáÁ´†Ê†áÈ¢ò" value="${d.title}" oninput="actions.setArticleForm('title',this.value)" class="flex-[2] border border-slate-200 rounded-xl p-3 bg-slate-50 outline-none focus:border-indigo-500 font-bold text-sm" required>
                                                <select onchange="actions.setArticleForm('type',this.value)" class="flex-1 border border-slate-200 rounded-xl p-3 bg-slate-50 outline-none focus:border-indigo-500 text-sm appearance-none">
                                                    ${ARTICLE_TYPES.map(t => `<option value="${t}" ${d.type === t ? 'selected' : ''}>${t}</option>`).join('')}
                                                </select>
                                            </div>
                                            <div class="flex gap-2">
                                                <div class="flex-[2] relative">
                                                    <label id="article-journal-label" class="absolute -top-5 left-0 text-[10px] text-slate-400 hidden">ÊúüÂàä/‰ºöËÆÆÂêçÁß∞</label>
                                                    <input type="text" id="article-journal-input" placeholder="ÊúüÂàä/‰ºöËÆÆÂêçÁß∞" value="${d.journal}" oninput="actions.setArticleForm('journal',this.value)" class="w-full border border-slate-200 rounded-xl p-3 bg-slate-50 outline-none focus:border-indigo-500 text-sm" required>
                                                </div>
                                                <div class="flex-1 relative">
                                                    <input id="article-status-input" list="stage-options" placeholder="ÂΩìÂâçÁä∂ÊÄÅ" value="${d.status}" oninput="actions.setArticleForm('status',this.value)" class="w-full border border-slate-200 rounded-xl p-3 bg-slate-50 outline-none focus:border-indigo-500 text-sm">
                                                    <datalist id="stage-options"></datalist>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                                            <div class="flex justify-between items-center mb-3">
                                                <p class="text-xs font-bold text-indigo-400 uppercase flex items-center gap-1">${Icons.Cal} ÂÖ≥ÈîÆÊó∂Èó¥ËäÇÁÇπ</p>
                                                <div class="flex gap-2">
                                                    ${!d.id ? `<button type="button" onclick="actions.appendRecommendedNodes()" class="text-[10px] bg-white text-indigo-600 px-2 py-1 rounded shadow-sm flex items-center gap-1 border border-indigo-100 hover:bg-indigo-50">${Icons.Refresh} Ë°•ÂÖ®Êé®Ëçê</button>` : ''}
                                                    <button type="button" onclick="actions.addMilestone()" class="text-[10px] bg-indigo-600 text-white px-2 py-1 rounded shadow-sm flex items-center gap-1 hover:bg-indigo-700">${Icons.Plus} Ëá™ÂÆö‰πâ</button>
                                                </div>
                                            </div>
                                            <div id="milestone-list-container" class="space-y-2 max-h-60 overflow-y-auto milestones-scroll pr-1"></div>
                                            <p class="text-[10px] text-indigo-300 mt-2 text-center">ÊèêÁ§∫ÔºöÂ°´ÂÜôÊó•ÊúüÂêéÔºå‰∏äÊñπÁä∂ÊÄÅ‰ºöËá™Âä®Êõ¥Êñ∞ÔºàÈô§ÈùûÊâãÂä®‰øÆÊîπËøáÔºâ</p>
                                        </div>
                                        <div>
                                            <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">ÂÆ°Á®ø‰∫∫ÊÑèËßÅÊëòË¶Å</label>
                                            <textarea oninput="actions.setArticleForm('reviewNotes',this.value)" class="w-full border border-slate-200 rounded-xl p-3 bg-slate-50 outline-none focus:border-indigo-500 h-24 resize-none text-sm" placeholder="ËÆ∞ÂΩïÂÆ°Á®ø‰∫∫‰∏ªË¶ÅÊÑèËßÅ...">${d.reviewNotes}</textarea>
                                        </div>
                                        <div>
                                            <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">ÊñáÁ´†Êï¥‰ΩìÂ§áÊ≥®</label>
                                            <textarea oninput="actions.setArticleForm('notes',this.value)" class="w-full border border-slate-200 rounded-xl p-3 bg-slate-50 outline-none focus:border-indigo-500 h-20 resize-none text-sm" placeholder="Âêà‰ΩúËÄÖÊÉÖÂÜµ„ÄÅÂü∫ÈáëÂè∑Á≠â...">${d.notes}</textarea>
                                        </div>
                                    </div>
                                    <button class="w-full primary-gradient text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-200 active:scale-95 transition-transform">‰øùÂ≠òÊñáÁ´†Áä∂ÊÄÅ</button>
                                </form>
                            </div>
                        </div>`;
                    }
                    const nav = `<nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-slate-100 flex justify-around items-center h-16 z-50 pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]"><button onclick="actions.setTab('dashboard')" class="flex flex-col items-center gap-1 ${state.activeTab==='dashboard'?'text-indigo-600':'text-slate-400'}">${Icons.Target}<span class="text-[10px]">‰∏ªÈ°µ</span></button><button onclick="actions.setTab('add')" class="flex flex-col items-center gap-1 ${state.activeTab==='add'?'text-indigo-600':'text-slate-400'}"><div class="bg-indigo-600 text-white p-3 rounded-full shadow-lg shadow-indigo-200 -mt-6 mb-1 transform active:scale-95 transition"><span class="block">${Icons.Plus}</span></div><span class="text-[10px]">ÊâìÂç°</span></button><button onclick="actions.setTab('articles')" class="flex flex-col items-center gap-1 ${state.activeTab==='articles'?'text-indigo-600':'text-slate-400'}">${Icons.File}<span class="text-[10px]">ÊñáÁ´†</span></button></nav>`;

                    htmlContent = `<header class="bg-white px-6 py-4 flex justify-between items-center border-b border-slate-50 shadow-sm z-30">
                        <div class="flex items-center gap-3">
                            <button onclick="actions.toggleSidebar()" class="active:scale-95 transition-transform flex items-center" title="ËèúÂçï">
                                <img src="${state.user.avatar}" alt="PhD Flow" class="w-10 h-10 rounded-2xl shadow-md border border-slate-100">
                            </button>
                            <span class="font-bold text-lg text-slate-800">PhD Flow</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="actions.setTab('rank')" class="text-slate-400 hover:text-indigo-500 hover:bg-indigo-50 p-1.5 rounded-full transition relative group" title="ÈæôËôéÊ¶ú">${Icons.Trophy}</button>
                        </div>
                    </header><main class="flex-1 overflow-hidden relative">${content}</main>${nav}${sidebar}${modals}`;
                }
            }
            
            app.innerHTML = htmlContent;
            if (window.lucide) lucide.createIcons();

            const initScreen = document.getElementById('app-init-screen');
            const appMain = document.getElementById('app-main');

            if (state.view !== 'loading') {
                if (initScreen) {
                    initScreen.classList.add('fade-out');
                    setTimeout(() => {
                        initScreen.style.display = 'none';
                    }, 500);
                }
                if (appMain) {
                    appMain.style.display = 'block';
                    setTimeout(() => appMain.classList.add('visible'), 50);
                }
            } else {
                if (initScreen) initScreen.style.display = 'flex';
                if (appMain) appMain.style.display = 'none';
            }
        }
        
        // --- ÂàùÂßãÂåñÂÖ•Âè£ (ÊîπÂä®ÈÉ®ÂàÜ) ---
        function initApp() {
            try {
                const initScreen = document.getElementById('app-init-screen');
                if (initScreen) initScreen.style.display = 'flex';
                
                requestAnimationFrame(() => {
                    // ËØªÂèñÊåÅ‰πÖÂåñÁöÑ activeUserId
                    const activeUserId = Storage.get('phdflow_active_user_id', null);
                    
                    pickEnergyQuote();
                    startEnergyQuoteAutoRefresh();
                    
                    if (activeUserId) { 
                        // Â¶ÇÊûúÊúâ‰∏äÊ¨°ÁôªÂΩïËÆ∞ÂΩïÔºåÁõ¥Êé•ËØªÂèñËØ•Ë¥¶Âè∑Êï∞ÊçÆ
                        const users = getUnifiedUsers();
                        const userData = users[activeUserId];
                        if (userData) {
                            state.currentUserId = activeUserId;
                            // ÊÅ¢Â§çÊï∞ÊçÆÔºåÊòµÁß∞‰Ωú‰∏∫ÂõûÊòæ
                            restoreAppStateFromUserData(userData, userData.settings?.name || "ËÄÅÊúãÂèã");
                        } else {
                            state.view = 'login'; 
                            render(); 
                        }
                    } else { 
                        state.view = 'login'; 
                        render(); 
                    }
                });
            } catch (error) { 
                console.error("Init failed:", error); 
                state.view = 'login'; 
                render(); 
            }
        }

        if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', initApp); } else { initApp(); }
        
        setTimeout(() => { 
            const initScreen = document.getElementById('app-init-screen');
            if (initScreen && !initScreen.classList.contains('fade-out')) { 
                if(state.view === 'loading') {
                     state.view = 'login'; 
                     render();
                }
            } 
        }, 3000);

    </script>
</body>
</html>
