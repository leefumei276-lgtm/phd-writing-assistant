<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åšå£«å†™ä½œåŠ©æ‰‹ - æš–å¿ƒæ—¥è®°ç‰ˆ</title>
    <!-- æ·»åŠ æ¡Œé¢å›¾æ ‡æ”¯æŒ -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjogI2VlZjJmZjsgYm9yZGVyLXJhZGl1czDogMjRweDsiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IiNlZWYyZmYiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1zaXplPSIyNjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuMzVlbSI+8J+OhTwvdGV4dD48L3N2Zz4=">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        /* åŠ¨ç”» */
        @keyframes slide-up { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scale-in { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes pulse-soft { 0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.2); } 70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); } 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); } }
        @keyframes bounce-slow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }

        .animate-slide-up { animation: slide-up 0.3s ease-out; }
        .animate-fade-in { animation: fade-in 0.2s ease-out; }
        .animate-scale-in { animation: scale-in 0.2s ease-out; }
        .animate-pulse-soft { animation: pulse-soft 2s infinite; }
        .animate-bounce-slow { animation: bounce-slow 2s infinite ease-in-out; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .primary-gradient { background: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%); }
        .bg-gradient-psych { background: linear-gradient(135deg, #F5F3FF 0%, #EEF2FF 100%); border: 1px solid #E0E7FF; }
        
        /* Card Gradients */
        .card-gradient-1 { background: linear-gradient(135deg, #F5F3FF 0%, #EEF2FF 100%); }
        .card-gradient-2 { background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%); }
        .card-gradient-done { background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%); }

        /* Logo Gradient */
        .logo-gradient { background: linear-gradient(135deg, #818CF8 0%, #4F46E5 100%); }

        /* Goal Tag Styles */
        .goal-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.05em;
            color: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            transform: translateY(-1px);
        }
        .tag-purple { background: linear-gradient(135deg, #a78bfa 0%, #818cf8 100%); }
        .tag-blue { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); }
        .tag-cyan { background: linear-gradient(135deg, #22d3ee 0%, #06b6d4 100%); }
        .tag-green { background: linear-gradient(135deg, #34d399 0%, #10b981 100%); }
        .tag-orange { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }

        /* Jelly Progress Bar */
        .progress-track { background-color: rgba(255,255,255,0.6); border-radius: 9999px; height: 14px; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.8); }
        .progress-jelly { 
            height: 100%; 
            border-radius: 9999px; 
            background: linear-gradient(90deg, #7c3aed 0%, #4f46e5 100%);
            position: relative;
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .progress-jelly::after {
            content: '';
            position: absolute;
            right: 2px;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .progress-jelly.done {
            background: linear-gradient(90deg, #10B981 0%, #059669 100%);
        }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #ffffff;
            border: 2px solid #6366F1;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(99, 102, 241, 0.3);
            margin-top: -10px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: #E0E7FF;
            border-radius: 999px;
        }

        .mood-icon { transition: all 0.2s; filter: grayscale(100%); opacity: 0.5; transform: scale(0.9); }
        .mood-icon.selected { transform: scale(1.15); filter: grayscale(0%); opacity: 1; }

        .spinner { border: 2px solid rgba(0,0,0,0.1); border-top-color: #6366F1; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 selection:bg-indigo-100 min-h-screen">

    <div id="app" class="max-w-md mx-auto min-h-screen bg-gray-50 shadow-2xl overflow-hidden relative flex flex-col">
        <!-- åˆå§‹åŠ è½½ç”»é¢ -->
        <div id="loading-screen" class="flex flex-col items-center justify-center h-screen text-slate-400 gap-3">
            <div class="spinner"></div>
            <p class="text-xs">æ­£åœ¨æ•´ç†ä¹¦æ¡Œ...</p>
        </div>
    </div>

    <!-- ç§»é™¤ module ç±»å‹ï¼Œä½¿ç”¨æ ‡å‡†è„šæœ¬ä»¥æé«˜å…¼å®¹æ€§ -->
    <script>
        // --- æ ¸å¿ƒæ•°æ® ---
        
        const psychQuotes = [
            "ä»Šå¤©å†™çš„æ¯ä¸€ä¸ªå­—ï¼Œéƒ½ä¼šåœ¨æœªæ¥ä¸ºä½ å‘å…‰ âœ¨",
            "ä¸å¿…ä¸€ä¸‹å­å†™å®Œä¸€ç« ï¼Œåªè¦ä»Šå¤©æ¯”æ˜¨å¤©å¤šä¸€ç‚¹ç‚¹å°±å¥½ã€‚",
            "ä½ å·²ç»æ¯”åœä¸‹æ¥çš„é‚£ä¸ªäººï¼Œé¢†å…ˆäº†æ•´æ•´ä¸€å¤© ğŸƒâ€â™€ï¸",
            "å…è®¸è‡ªå·±æ…¢ä¸‹æ¥ï¼Œå­¦æœ¯æ˜¯ä¸€åœºé©¬æ‹‰æ¾ï¼Œä¸æ˜¯ç™¾ç±³å†²åˆºã€‚",
            "åˆç¨¿å°±æ˜¯ç”¨æ¥ä¿®æ”¹çš„ï¼Œå…è®¸å®ƒä¸å®Œç¾ï¼Œå®ƒæ˜¯æ°ä½œçš„ç§å­ ğŸŒ±",
            "ç“¶é¢ˆæœŸå…¶å®æ˜¯æˆé•¿æœŸï¼Œä½ çš„å¤§è„‘æ­£åœ¨é‡ç»„è®¤çŸ¥ã€‚",
            "ä¼‘æ¯ä¸æ˜¯å·æ‡’ï¼Œæ˜¯å¤§è„‘åœ¨åå°æ•´ç†å·²æœ‰çš„çµæ„Ÿã€‚",
            "æ¯ä¸€ä¸ªè§£å†³çš„å°bugï¼Œéƒ½æ˜¯é€šå¾€åšå£«å­¦ä½çš„åšå®å°é˜¶ã€‚",
            "ä»Šå¤©çš„ä½æ•ˆä¸ä»£è¡¨æ— èƒ½ï¼Œæ¥çº³è‡ªå·±çš„èŠ‚å¥ï¼Œæ˜å¤©åˆæ˜¯æ–°çš„ä¸€å¤©ã€‚",
            "ä½ å¹¶ä¸å­¤å•ï¼Œæ‰€æœ‰çš„åšå£«éƒ½åœ¨è¿™ç‰‡æµ·é‡Œæ¸¸æ³³ï¼Œæˆ‘ä»¬ä¸€èµ·ä¸Šå²¸ ğŸŒŠ"
        ];

        const encouragementRules = [
            { keywords: ['éš¾', 'å¡', 'ä¸åŠ¨', 'çƒ¦', 'ä¹±'], msg: "æŠ±æŠ±ä½  (ã¥ï½¡â—•â€¿â€¿â—•ï½¡)ã¥ å…è®¸è‡ªå·±å¡é¡¿ï¼Œæ˜å¤©åˆæ˜¯æ–°çš„ä¸€å¤©ã€‚" },
            { keywords: ['ç´¯', 'å›°', 'ä¹', 'å€¦'], msg: "è¾›è‹¦å•¦ï¼å¤§è„‘é«˜è´Ÿè·è¿è½¬è¿™ä¹ˆä¹…ï¼Œå¿«å»åƒç‚¹å¥½åƒçš„çŠ’åŠ³ä¸€ä¸‹è‡ªå·±ï¼ğŸµ" },
            { keywords: ['å¼€å¿ƒ', 'é¡º', 'æ£’', 'çˆ½', 'å¿«'], msg: "å¤ªæ£’äº†ï¼è¿™ç§å¿ƒæµçŠ¶æ€ç®€ç›´æ˜¯å­¦æœ¯ç•Œçš„é¡¶çº§äº«å—ï¼ğŸ‰" },
            { keywords: ['å¹³', 'ç¨³', 'è¡Œ'], msg: "å¹³ç¨³å°±æ˜¯èƒœåˆ©ï¼Œä¿æŒè¿™ä¸ªèŠ‚å¥ï¼Œç»ˆå°†æ±‡èšæˆæ²³ã€‚ğŸ’§" }
        ];

        const comfortMessages = {
            tired: ["è¾›è‹¦å•¦ï¼ä¼‘æ¯æ˜¯ä¸ºäº†æ›´å¥½çš„é‡å¯ã€‚æ‘¸æ‘¸å¤´ï¼Œå¿«å»å……ç”µå§ï¼ğŸ”‹"],
            sad: ["æŠ±æŠ±ä½ ï¼Œå†™ä¸å‡ºæ¥ä¹Ÿæ²¡å…³ç³»ï¼Œçµæ„Ÿæ­£åœ¨èµ¶æ¥çš„è·¯ä¸Šã€‚"],
            neutral: ["å¹³ç¨³å°±æ˜¯èƒœåˆ©ï¼Œæ¯ä¸€å¤©å¾®å°çš„ç§¯ç´¯ï¼Œç»ˆå°†æ±‡èšæˆæ²³ã€‚"],
            happy: ["å¤ªæ£’äº†ï¼è®°ä½è¿™ç§æˆå°±æ„Ÿï¼Œå®ƒæ˜¯ä½ å‰è¡Œçš„ç‡ƒæ–™ã€‚ğŸ‰"]
        };

        const autoReflections = {
            happy: ["ä»Šå¤©çŠ¶æ€ç¥å‹‡ï¼Œé”®ç›˜éƒ½è¦å†’ç«æ˜Ÿäº†ï¼ğŸ”¥", "æ€è·¯æ¸…æ™°ï¼Œå†™èµ·æ¥é¡ºé£é¡ºæ°´ï¼Œå¼€å¿ƒï¼ğŸ‘"],
            neutral: ["å¹³å¹³æ·¡æ·¡æ‰æ˜¯çœŸï¼ŒæŒ‰éƒ¨å°±ç­å®Œæˆä»»åŠ¡ã€‚", "è¿›åº¦æ¡ç¼“æ…¢ä½†åšå®šåœ°ç§»åŠ¨ä¸­ã€‚"],
            sad: ["ä»Šå¤©æœ‰ç‚¹è‰°éš¾ï¼Œä½†è‡³å°‘æˆ‘åšæŒä¸‹æ¥äº†ã€‚", "å¿ƒæƒ…æœ‰ç‚¹ä½è½ï¼Œæˆ–è®¸æ˜¯è¯¥æ¢ä¸ªæ€è·¯äº†ã€‚"],
            tired: ["è„‘ç»†èƒå·²è€—å°½ï¼Œæ€¥éœ€å……ç”µï¼ğŸ”‹", "å®åœ¨æ˜¯å¤ªå›°äº†ï¼Œå…ˆè‹Ÿä½ï¼Œæ˜å¤©å†æˆ˜ï¼ğŸ’¤"]
        };

        const MOCK_LEADERBOARD = [
            { username: "å­¦æœ¯å·ç‹", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Felix", wordCount: 3200 },
            { username: "æ–‡çŒ®æ€æ‰‹", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Aneka", wordCount: 2100 },
            { username: "æ·±å¤œæˆ˜ç¥", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Milo", wordCount: 1800 },
            { username: "æ—©èµ·é¸Ÿ", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Bella", wordCount: 500 }
        ];

        // --- çŠ¶æ€ç®¡ç† ---
        const state = {
            view: 'loading',
            activeTab: 'dashboard', 
            user: null, 
            entries: [],
            dailyPlans: [], 
            customGoals: [],
            totalWordGoal: 100000,
            graduationDate: '',
            currentSession: null, 
            leaderboard: [],
            loadingLeaderboard: false,
            loginMode: 'login',
            showSidebar: false,
            showFeedback: false,
            feedbackData: {},
            showGoalModal: false,
            editingGoalId: null,
            showPlanModal: false, 
            editingPlanId: null,
            showLogoutModal: false,
            showProfileModal: false,
            showGradSettings: false,
            viewDate: new Date().toISOString().split('T')[0],
            dailyQuote: psychQuotes[0],
            formData: { 
                date: '', 
                startCount: 0, 
                endCount: 0, 
                mood: 'neutral', 
                reflection: '', 
                linkedGoalId: '', 
                chapter: '', 
                duration: '', 
                durationNum: 0 
            },
            entryDrafts: {}, 
            newGoalData: { name: '', targetQty: 1, unit: 'ç¯‡', targetWords: 10000 },
            planFormData: { target: 1000, content: '', linkedGoalId: 'thesis' },
            tempProfile: { name: '', avatar: '' }
        };

        // --- å®‰å…¨çš„æœ¬åœ°å­˜å‚¨å°è£… ---
        // ä¿®å¤é—®é¢˜ï¼šå¢åŠ  try/catch é˜²æ­¢éšç§æ¨¡å¼ä¸‹ localStorage æŠ¥é”™ä¸­æ–­è„šæœ¬
        const Storage = {
            get: (key, defaultVal = null) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultVal;
                } catch (e) {
                    console.warn(`Error reading ${key}:`, e);
                    return defaultVal;
                }
            },
            set: (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (e) {
                    console.warn(`Error writing ${key}:`, e);
                    // å¦‚æœæ— æ³•å†™å…¥ï¼Œå¯ä»¥è€ƒè™‘å¼¹çª—æç¤ºï¼Œä½†æš‚æ—¶å¿½ç•¥ä»¥ä¿æŒæµç¨‹
                }
            },
            remove: (key) => {
                try {
                    localStorage.removeItem(key);
                } catch(e) {}
            }
        };

        // --- å®‰å…¨çš„æ—¥æœŸè§£æ (ä¿®å¤å´©æºƒé—®é¢˜çš„æ ¸å¿ƒ) ---
        function parseSafeDate(dateStr) {
            if (!dateStr || typeof dateStr !== 'string') return null;
            // åŒ¹é… YYYY-MM-DD æ ¼å¼
            const match = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (!match) return null;
            
            const year = parseInt(match[1], 10);
            const month = parseInt(match[2], 10) - 1; // æœˆä»½ä» 0 å¼€å§‹
            const day = parseInt(match[3], 10);
            
            // ä½¿ç”¨æ„é€ å‡½æ•°åˆ›å»ºæ—¥æœŸï¼Œé¿å…å­—ç¬¦ä¸²è§£æçš„å…¼å®¹æ€§é—®é¢˜
            const date = new Date(year, month, day);
            
            // ç®€å•çš„æ ¡éªŒï¼šè½¬æ¢å›å»å¹´æœˆæ—¥æ˜¯å¦ä¸€è‡´ (å¤„ç† 2025-02-30 è¿™ç§æƒ…å†µ)
            if (date.getFullYear() !== year || date.getMonth() !== month || date.getDate() !== day) {
                return null;
            }
            return date;
        }

        // --- ç”¨æˆ·ç³»ç»Ÿ ---
        function getUsersDirectory() { return Storage.get('phd_users_directory', {}); }
        function saveUsersDirectory(dir) { Storage.set('phd_users_directory', dir); }

        function loadLocalUser(username) {
            try {
                const dir = getUsersDirectory();
                
                // è‡ªåŠ¨æ³¨å†Œï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                if (!dir[username]) {
                    dir[username] = { password: 'any', avatar: `https://api.dicebear.com/7.x/notionists/svg?seed=${Date.now()}` };
                    saveUsersDirectory(dir);
                    Storage.set(`phd_data_${username}`, { entries: [], customGoals: [{ id: 'g1', name: 'æ¯•ä¸šè®ºæ–‡', currentQty: 0, targetQty: 1, unit: 'ç¯‡', accumulatedWords: 0, targetWords: 100000 }] });
                }

                state.user = { username: username, avatar: dir[username].avatar };
                const data = Storage.get(`phd_data_${username}`, {});
                
                // æ•°æ®åˆå§‹åŒ–ï¼Œé˜²æ­¢ undefined
                state.entries = Array.isArray(data.entries) ? data.entries : [];
                state.customGoals = Array.isArray(data.customGoals) ? data.customGoals : [{ id: 'g1', name: 'æ¯•ä¸šè®ºæ–‡', currentQty: 0, targetQty: 1, unit: 'ç¯‡', accumulatedWords: 0, targetWords: 100000 }];
                state.dailyPlans = Array.isArray(data.dailyPlans) ? data.dailyPlans : [];
                state.totalWordGoal = data.totalWordGoal || 100000;
                
                // é˜²å¾¡æ€§å¤„ç† graduationDate
                let safeGradDate = '';
                if (data.graduationDate) {
                    const parsed = parseSafeDate(data.graduationDate);
                    if (parsed) {
                        safeGradDate = data.graduationDate;
                    }
                }
                state.graduationDate = safeGradDate;
                
                state.currentSession = Storage.get(`phd_session_${username}`, null);
                state.entryDrafts = {};
                
                Storage.set('phd_current_user', username); // åªæœ‰æˆåŠŸåŠ è½½æ‰ä¿å­˜
                state.view = 'app';
                state.dailyQuote = psychQuotes[Math.floor(Math.random() * psychQuotes.length)];
                
                render(); // ç¡®ä¿åŠ è½½å®Œæ•°æ®åç«‹å³æ¸²æŸ“
            } catch(e) {
                console.error("User load failed:", e);
                // å¦‚æœå‡ºé”™ï¼Œå¼ºåˆ¶å›é€€åˆ°ç™»å½•é¡µï¼Œé¿å…å¡æ­»
                state.view = 'login';
                render();
            }
        }

        function saveUserData() {
            if (!state.user) return;
            const data = { entries: state.entries, customGoals: state.customGoals, dailyPlans: state.dailyPlans, totalWordGoal: state.totalWordGoal, graduationDate: state.graduationDate };
            Storage.set(`phd_data_${state.user.username}`, data);
            if (state.currentSession) Storage.set(`phd_session_${state.user.username}`, state.currentSession);
            else Storage.remove(`phd_session_${state.user.username}`);
        }

        // --- æ’è¡Œæ¦œ (æ¨¡æ‹Ÿ) ---
        async function fetchLeaderboard() {
            state.loadingLeaderboard = true; 
            render();
            
            setTimeout(() => {
                let list = [...MOCK_LEADERBOARD];
                if (state.user) {
                    const today = getTodayStr();
                    const myWords = state.entries.reduce((acc, e) => e.date === today ? acc + e.dailyCount : acc, 0);
                    const existingIdx = list.findIndex(u => u.username === state.user.username);
                    if (existingIdx >= 0) {
                        list[existingIdx].wordCount = myWords;
                    } else {
                        list.push({ username: state.user.username, avatar: state.user.avatar, wordCount: myWords });
                    }
                }
                state.leaderboard = list.sort((a,b) => b.wordCount - a.wordCount);
                state.loadingLeaderboard = false; 
                render();
            }, 600);
        }

        // --- è¾…åŠ©å‡½æ•° ---
        const getTodayStr = () => new Date().toISOString().split('T')[0];
        
        const calcStats = (targetDate) => {
            const total = state.entries.reduce((acc, e) => acc + e.dailyCount, 0); 
            const today = state.entries.reduce((acc, e) => e.date === targetDate ? acc + e.dailyCount : acc, 0);
            const uniqueDays = new Set(state.entries.map(e => e.date)).size;
            const avg = uniqueDays > 0 ? Math.round(total / uniqueDays) : 0;
            return { total, today, avg };
        };
        
        // ä¿®å¤ï¼šä½¿ç”¨ parseSafeDate è¿›è¡Œå®‰å…¨è®¡ç®—
        const getDaysLeft = () => {
            const gradDate = parseSafeDate(state.graduationDate);
            if (!gradDate) return null;
            
            const now = new Date();
            // é‡ç½®æ—¶é—´éƒ¨åˆ†ï¼Œç¡®ä¿åªæ¯”è¾ƒæ—¥æœŸ
            now.setHours(0, 0, 0, 0);
            
            // è®¡ç®—æ¯«ç§’å·®
            const diffTime = gradDate - now;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        };
        
        const getPlanProgress = (planId, targetDate) => {
            return state.entries
                .filter(e => e.date === targetDate && e.linkedPlanId === planId)
                .reduce((acc, e) => acc + e.dailyCount, 0);
        };

        const getLastCountForGoal = (goalId) => {
            if (!goalId) return 0;
            const relevantEntries = state.entries.filter(e => e.linkedGoalId === goalId);
            if (relevantEntries.length === 0) return 0;
            return Math.max(...relevantEntries.map(e => e.endCount));
        };
        
        const getSmartResponse = (reflection, mood) => {
            const text = (reflection || "").toLowerCase();
            for (const rule of encouragementRules) {
                if (rule.keywords.some(k => text.includes(k))) return rule.msg;
            }
            const fallbackMsgs = comfortMessages[mood] || comfortMessages.neutral;
            return fallbackMsgs[Math.floor(Math.random() * fallbackMsgs.length)];
        };

        const cleanOldPlans = () => {
            const today = getTodayStr();
            // é˜²å¾¡æ€§ç¼–ç¨‹ï¼šç¡®ä¿ dailyPlans å­˜åœ¨
            if (state.dailyPlans && state.dailyPlans.length > 0 && state.dailyPlans[0].date !== today) {
                state.dailyPlans = [];
                saveUserData();
            }
        };

        const getGoalTagStyle = (name) => {
            if (!name) return { emoji: 'ğŸŒ±', cls: 'tag-green' };
            const n = name.toLowerCase();
            if (n.includes('è®ºæ–‡') || n.includes('å†™') || n.includes('ç¨¿')) return { emoji: 'ğŸ“', cls: 'tag-purple' };
            if (n.includes('é˜…è¯»') || n.includes('æ–‡çŒ®') || n.includes('ä¹¦')) return { emoji: 'ğŸ“–', cls: 'tag-blue' };
            if (n.includes('æ•°æ®') || n.includes('å®éªŒ') || n.includes('åˆ†æ')) return { emoji: 'ğŸ’¡', cls: 'tag-cyan' };
            if (n.includes('æ€è€ƒ') || n.includes('æƒ³') || n.includes('è®¡åˆ’')) return { emoji: 'ğŸŒ±', cls: 'tag-green' };
            return { emoji: 'ğŸ“Œ', cls: 'tag-orange' }; 
        };

        // --- äº¤äº’ Action ---
        window.actions = {
            auth: (e) => { 
                e.preventDefault(); 
                const u = e.target.username.value.trim() || "åŒ¿ååšå£«"; 
                loadLocalUser(u); 
            },
            toggleAuth: () => { },
            
            askLogout: () => { state.showSidebar = false; state.showLogoutModal = true; render(); },
            confirmLogout: () => { Storage.remove('phd_current_user'); state.user = null; state.showLogoutModal = false; state.view = 'login'; render(); },
            cancelLogout: () => { state.showLogoutModal = false; render(); },
            
            setTab: (t) => { 
                state.activeTab = t; 
                if(t==='add' && !state.currentSession) { 
                    const defaultGoalId = state.customGoals.length > 0 ? state.customGoals[0].id : 'thesis';
                    const lastCount = getLastCountForGoal(defaultGoalId);
                    state.formData = {
                        date: getTodayStr(), 
                        linkedGoalId: defaultGoalId,
                        startCount: lastCount,
                        endCount: lastCount, 
                        chapter: '', mood: 'neutral', reflection: '', 
                        duration: '', 
                        durationNum: 0 
                    };
                } 
                if(t==='rank') fetchLeaderboard(); 
                render(); 
            },
            toggleSidebar: () => { state.showSidebar = !state.showSidebar; render(); },
            
            setViewDate: (d) => { state.viewDate = d; render(); },
            changeDate: (days) => { 
                // å®‰å…¨å¤„ç†æ—¥æœŸè·³è½¬
                const current = parseSafeDate(state.viewDate) || new Date();
                current.setDate(current.getDate() + days);
                state.viewDate = current.toISOString().split('T')[0]; 
                render(); 
            },
            goToToday: () => { state.viewDate = getTodayStr(); render(); },
            
            openAddPlan: () => { 
                state.editingPlanId = null;
                const defaultGoal = state.customGoals.length > 0 ? state.customGoals[0].id : '';
                state.planFormData = { target: 1000, content: '', linkedGoalId: defaultGoal };
                state.showPlanModal = true; 
                render(); 
            },
            openEditPlan: (id) => {
                const plan = state.dailyPlans.find(p => p.id === id);
                if(plan) { state.editingPlanId = id; state.planFormData = { ...plan }; state.showPlanModal = true; render(); }
            },
            closePlanModal: () => { state.showPlanModal = false; render(); },
            setPlanForm: (f, v) => state.planFormData[f] = v,
            savePlan: (e) => {
                e.preventDefault();
                const newPlan = {
                    ...state.planFormData,
                    id: state.editingPlanId || Date.now().toString(),
                    date: state.viewDate
                };
                if (state.editingPlanId) state.dailyPlans = state.dailyPlans.map(p => p.id === state.editingPlanId ? newPlan : p);
                else state.dailyPlans.push(newPlan);
                state.showPlanModal = false; saveUserData(); render();
            },
            deletePlan: (id) => {
                if(confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªç›®æ ‡å—ï¼Ÿ")) { state.dailyPlans = state.dailyPlans.filter(p => p.id !== id); saveUserData(); render(); }
            },

            start: (planId) => { 
                const plan = state.dailyPlans.find(p => p.id === planId);
                const linkedGoalId = plan ? plan.linkedGoalId : '';
                const lastMax = getLastCountForGoal(linkedGoalId);
                state.currentSession = { start: Date.now(), startCount: lastMax, isActive: true, planId: planId, linkedGoalId: linkedGoalId }; 
                saveUserData(); 
                render(); 
            },
            adjustStart: () => {
                const newStart = prompt("ä¿®æ­£å¼€å§‹å­—æ•°:", state.currentSession.startCount);
                if (newStart !== null && !isNaN(newStart)) { state.currentSession.startCount = parseInt(newStart); saveUserData(); render(); }
            },
            adjustManualStart: (d) => {
                const oldStart = parseInt(state.formData.startCount) || 0;
                const newStart = Math.max(0, oldStart + d);
                actions.setFormData('startCount', newStart);
                const el = document.querySelector('input[name="startCount"]');
                if(el) el.value = newStart;
                actions.setFormData('endCount', state.formData.endCount);
            },
            autoGenReflection: () => {
                const mood = state.formData.mood;
                const opts = autoReflections[mood] || autoReflections.neutral;
                const text = opts[Math.floor(Math.random() * opts.length)];
                state.formData.reflection = text;
                const el = document.querySelector('textarea[name="reflection"]');
                if(el) el.value = text;
            },
            setFormData: (f, v) => { 
                state.formData[f] = v;
                if (f === 'endCount') {
                    const isFocus = !!state.currentSession;
                    const start = isFocus ? state.currentSession.startCount : parseInt(state.formData.startCount);
                    const diff = (parseInt(v)||0) - (parseInt(start)||0);
                    const el = document.getElementById('net-word-display');
                    if(el) { el.innerText = diff > 0 ? `+${diff}` : diff; el.style.color = diff > 0 ? '#10B981' : (diff < 0 ? '#EF4444' : '#94A3B8'); }
                }
                if (f === 'linkedGoalId') {
                    const lastCount = getLastCountForGoal(v);
                    state.formData.startCount = lastCount;
                    state.formData.endCount = lastCount;
                    const todayPlan = state.dailyPlans.find(p => p.linkedGoalId === v);
                    state.formData.chapter = todayPlan ? todayPlan.content : '';
                    const startInput = document.querySelector('input[name="startCount"]');
                    const endInput = document.querySelector('input[name="endCount"]');
                    const chapInput = document.querySelector('input[name="chapter"]');
                    if(startInput) startInput.value = lastCount;
                    if(endInput) endInput.value = lastCount;
                    if(chapInput) chapInput.value = state.formData.chapter;
                }
            },
            updateDuration: (val) => {
                state.formData.durationNum = val;
                const display = val > 0 ? `${val} å°æ—¶` : '';
                state.formData.duration = display;
                const el = document.getElementById('duration-display');
                if(el) el.innerText = val > 0 ? display : '0 å°æ—¶';
            },

            end: async (e) => {
                e.preventDefault();
                const isFocus = !!state.currentSession;
                const start = isFocus ? state.currentSession.startCount : parseInt(state.formData.startCount);
                const end = parseInt(e.target.endCount.value);
                if (end < start && !confirm("ç»“æŸå­—æ•°å°‘äºå¼€å§‹å­—æ•°ï¼Ÿ(è®°å½•ä¸ºè´Ÿäº§å‡º)")) return;
                const diff = end - start;
                
                let planId = null, linkedGoalId = isFocus ? state.currentSession.linkedGoalId : state.formData.linkedGoalId;
                if (!linkedGoalId && state.customGoals.length > 0) { linkedGoalId = state.customGoals[0].id; }
                
                let goalName = "æœªåˆ†ç±»ç›®æ ‡", planContent = state.formData.chapter || "æ‰“å¡è®°å½•";
                let mood = state.formData.mood, reflection = state.formData.reflection;
                
                if(!reflection) {
                    const opts = autoReflections[mood] || autoReflections.neutral;
                    reflection = opts[Math.floor(Math.random() * opts.length)];
                }
                let encourageMsg = getSmartResponse(reflection, mood);
                if(diff > 2000) encourageMsg = "å¤©å“ªï¼2000+å­—ï¼ä½ å°±æ˜¯ä¼ è¯´ä¸­çš„å­¦æœ¯è¶…äººï¼è¯·æ”¶ä¸‹æˆ‘çš„è†ç›–ï¼ğŸ™‡â€â™‚ï¸";

                if (isFocus) {
                    planId = state.currentSession.planId;
                    const plan = state.dailyPlans.find(p => p.id === planId);
                    if (plan) planContent = plan.content;
                } 

                if(linkedGoalId) {
                    const g = state.customGoals.find(x=>x.id===linkedGoalId);
                    if(g) { 
                        g.accumulatedWords = (g.accumulatedWords || 0) + diff; 
                        goalName = g.name;
                        if(g.unit === 'å­—') g.current = (g.current || 0) + diff;
                    }
                    delete state.entryDrafts[linkedGoalId];
                }
                
                const recordDate = state.formData.date || getTodayStr();
                
                let finalDuration = state.formData.duration;
                if(isFocus) {
                    finalDuration = Math.round((Date.now() - state.currentSession.start)/60000) + "m";
                }

                state.entries.push({ 
                    id: Date.now(), date: recordDate, startCount: start, endCount: end, dailyCount: diff, 
                    duration: finalDuration, 
                    mood, reflection, linkedPlanContent: planContent, linkedGoalName: goalName, linkedPlanId: planId, linkedGoalId: linkedGoalId
                });
                state.entries.sort((a,b)=> new Date(b.date)-new Date(a.date));
                
                state.currentSession = null;
                state.formData = { date: getTodayStr(), startCount: 0, endCount: 0, mood: 'neutral', reflection: '', chapter: '', linkedGoalId: '', duration: '', durationNum: 0 }; 
                state.feedbackData = { diff, linkedGoalName: goalName, encourageMsg }; 
                state.showFeedback = true;
                saveUserData(); await syncLeaderboard(); render();
            },
            cancelSession: () => { if(confirm("æ”¾å¼ƒæœ¬æ¬¡ä¸“æ³¨ï¼Ÿ")) { state.currentSession = null; saveUserData(); render(); } },
            setMood: (m) => { state.formData.mood = m; render(); },
            closeFeedback: () => { state.showFeedback = false; state.activeTab = 'history'; render(); },
            
            openAddGoal: () => { state.editingGoalId = null; state.newGoalData = { name: '', targetQty: 1, unit: 'ç¯‡', targetWords: 50000 }; state.showGoalModal = true; render(); },
            openEditGoal: (id) => { const g = state.customGoals.find(x => x.id === id); if (g) { state.editingGoalId = id; state.newGoalData = { ...g }; state.showGoalModal = true; render(); } },
            setNewGoal: (f, v) => state.newGoalData[f] = v,
            saveGoal: () => {
                if(!state.newGoalData.name) return;
                const goalData = { name: state.newGoalData.name, targetQty: parseInt(state.newGoalData.targetQty) || 1, unit: state.newGoalData.unit || 'ä¸ª', targetWords: parseInt(state.newGoalData.targetWords) || 0 };
                if (state.editingGoalId) state.customGoals = state.customGoals.map(g => g.id === state.editingGoalId ? { ...g, ...goalData } : g);
                else state.customGoals.push({ ...goalData, id: Date.now().toString(), currentQty: 0, accumulatedWords: 0 });
                state.showGoalModal = false; saveUserData(); render();
            },
            delGoal: (id) => { if(confirm("åˆ é™¤æ­¤ç›®æ ‡ï¼Ÿ")) { state.customGoals = state.customGoals.filter(x=>x.id!==id); saveUserData(); render(); } },
            addQty: (id) => { const g = state.customGoals.find(x=>x.id===id); if(g) { g.currentQty++; saveUserData(); render(); } },
            
            setGradDate: (d) => { /* ä¸å†ç«‹å³ä¿å­˜ï¼Œæ”¹ç”¨ SaveGradSettings */ },
            toggleGrad: () => { state.showGradSettings = !state.showGradSettings; render(); },
            // æ–°å¢: ä¸“é—¨ç”¨äºä¿å­˜æ—¥æœŸçš„å‡½æ•°ï¼Œé¿å… onchange å¯¼è‡´çš„é‡ç»˜å†²çª
            saveGradSettings: () => {
                const inputEl = document.getElementById('grad-date-input');
                if(inputEl) {
                    // åªæ¥å—æœ‰æ•ˆæ—¥æœŸ
                    const val = inputEl.value;
                    const parsed = parseSafeDate(val);
                    if (parsed) {
                        state.graduationDate = val;
                    } else if (val === '') {
                        state.graduationDate = ''; // å…è®¸æ¸…é™¤
                    }
                }
                state.showGradSettings = false;
                saveUserData();
                render();
            },
            
            toggleGoalModal: () => { state.showGoalModal = !state.showGoalModal; render(); },
            setTotalGoal: () => { const v = prompt("ç›®æ ‡å­—æ•°:", state.totalWordGoal); if(v) { state.totalWordGoal = Number(v); saveUserData(); render(); } },
            
            editProfile: () => { state.tempProfile = {...state.user}; state.showProfileModal = true; state.showSidebar = false; render(); },
            closeProfile: () => { state.showProfileModal = false; render(); },
            setTempProfile: (f,v) => state.tempProfile[f]=v,
            randAvatar: () => { state.tempProfile.avatar = `https://api.dicebear.com/7.x/notionists/svg?seed=${Date.now()}`; render(); },
            saveProfile: (e) => { e.preventDefault(); state.user = {...state.user, ...state.tempProfile}; state.showProfileModal = false; saveUserData(); syncLeaderboard(); render(); }
        };

        // --- Render ---
        const Icons = {
            Menu: `<i data-lucide="menu" class="w-6 h-6"></i>`, Target: `<i data-lucide="target" class="w-6 h-6"></i>`, History: `<i data-lucide="history" class="w-6 h-6"></i>`,
            Medal: `<i data-lucide="medal" class="w-6 h-6"></i>`, Edit: `<i data-lucide="pencil" class="w-4 h-4"></i>`, Plus: `<i data-lucide="plus" class="w-5 h-5"></i>`,
            Trash: `<i data-lucide="trash-2" class="w-4 h-4"></i>`, Check: `<i data-lucide="check-circle-2" class="w-5 h-5"></i>`, User: `<i data-lucide="user" class="w-5 h-5"></i>`,
            LogOut: `<i data-lucide="log-out" class="w-5 h-5"></i>`, Switch: `<i data-lucide="users" class="w-5 h-5"></i>`, Settings: `<i data-lucide="settings" class="w-5 h-5"></i>`,
            Play: `<i data-lucide="play" class="w-5 h-5"></i>`, X: `<i data-lucide="x" class="w-5 h-5"></i>`, Star: `<i data-lucide="star" class="w-4 h-4"></i>`,
            Wand: `<i data-lucide="wand-2" class="w-3 h-3"></i>`, Cal: `<i data-lucide="calendar" class="w-4 h-4"></i>`,
            Left: `<i data-lucide="chevron-left" class="w-5 h-5"></i>`, Right: `<i data-lucide="chevron-right" class="w-5 h-5"></i>`
        };

        function AppLogo(size = "w-12 h-12") {
            return `<div class="${size} logo-gradient rounded-xl flex items-center justify-center shadow-lg transform rotate-3"><i data-lucide="graduation-cap" class="text-white w-1/2 h-1/2"></i><div class="absolute -bottom-1 -right-1 bg-white rounded-full p-0.5 border-2 border-indigo-500"><i data-lucide="pen-tool" class="w-3 h-3 text-indigo-600"></i></div></div>`;
        }

        function MoodIcon(mood, selected) {
            const cls = `mood-icon w-6 h-6 ${selected ? 'selected' : 'opacity-60'}`;
            const emoji = {happy:'ğŸ˜Š', neutral:'ğŸ˜', sad:'ğŸ˜”', tired:'ğŸ˜´'};
            return `<div class="${cls} text-xl flex items-center justify-center cursor-pointer transition-transform hover:scale-110">${emoji[mood]}</div>`;
        }

        function renderProgressBar(current, target, label) {
            const pct = Math.max(0, Math.min(100, target > 0 ? (current / target) * 100 : 0));
            const isDone = pct >= 100;
            
            return `
            <div class="relative pt-6 pb-2">
                <div class="progress-track">
                    <div class="progress-jelly ${isDone?'done':''}" style="width: ${pct}%"></div>
                </div>
                ${isDone ? '<div class="absolute -top-1 right-0 animate-bounce-slow text-xl">ğŸ‰</div>' : ''}
                <div class="flex justify-between text-xs text-slate-400 mt-2 font-medium px-1">
                    <span>0</span>
                    <span class="${isDone?'text-green-600 font-bold':''}">${label} ${isDone?'å®Œæˆ!':''}</span>
                    <span>${target>1000?(target/10000).toFixed(1)+'w':target}</span>
                </div>
            </div>`;
        }

        function renderLogin() {
            return `
            <div class="flex flex-col items-center justify-center h-screen px-8 bg-white">
                <div class="mb-6 animate-float">${AppLogo("w-24 h-24")}</div>
                <h1 class="text-2xl font-bold text-slate-800 mb-2">åšå£«å†™ä½œåŠ©æ‰‹</h1>
                <p class="text-slate-400 text-sm mb-10">æš–å¿ƒé™ªä¼´ Â· å¿«ä¹å­¦æœ¯</p>
                <form onsubmit="actions.auth(event)" class="w-full space-y-4">
                    <input name="username" placeholder="ä¾‹å¦‚ï¼šæœªæ¥çš„æåšå£«" class="w-full bg-gray-50 border border-gray-200 p-4 rounded-2xl outline-none focus:border-indigo-500 text-center font-bold text-slate-700" required>
                    <input name="password" type="password" placeholder="è¯·è¾“å…¥å¯†ç " class="w-full bg-gray-50 border border-gray-200 p-4 rounded-2xl outline-none focus:border-indigo-500 text-center">
                    <button class="w-full primary-gradient text-white font-bold py-4 rounded-2xl shadow-lg shadow-indigo-200 active:scale-95 transition-transform">è¿›å…¥ä¹¦æˆ¿</button>
                </form>
                <p class="mt-8 text-xs text-slate-300">Tip: ä¸ç®¡è¾“å…¥ä»€ä¹ˆï¼Œç‚¹å‡»æŒ‰é’®éƒ½ä¼šè¿›å…¥å“¦</p>
            </div>`;
        }

        function renderDashboard() {
            const { total, today, avg } = calcStats(state.viewDate);
            const days = getDaysLeft();
            const isToday = state.viewDate === getTodayStr();
            
            // å®‰å…¨çš„æ—¥æœŸæ˜¾ç¤º
            let dateStr = state.viewDate;
            let weekStr = '';
            const d = parseSafeDate(state.viewDate);
            if (d) {
                dateStr = `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
                weekStr = d.toLocaleDateString('zh-CN', { weekday: 'long' });
            }
            
            const dayPlans = state.dailyPlans.filter(p => p.date === state.viewDate);
            
            let plansHtml = '';
            if (dayPlans.length > 0) {
                plansHtml = dayPlans.map(plan => {
                    const currentProgress = getPlanProgress(plan.id, state.viewDate);
                    const isDone = currentProgress >= plan.target;
                    const pct = Math.min(100, Math.round(((currentProgress || 0) / plan.target) * 100));
                    const goal = state.customGoals.find(g => g.id === plan.linkedGoalId);
                    const goalName = goal ? goal.name : 'è‡ªç”±å†™ä½œ';
                    const tagStyle = getGoalTagStyle(goalName);
                    const bgClass = isDone ? 'card-gradient-done border-green-200' : 'card-gradient-1 border-white';
                    
                    return `
                    <div class="${bgClass} rounded-[24px] p-6 shadow-[0_10px_30px_rgba(0,0,0,0.06)] mb-6 relative transition-all hover:scale-[1.01] border">
                        <div class="absolute top-5 right-5 flex gap-2">
                            <button onclick="actions.openEditPlan('${plan.id}')" class="text-slate-300 hover:text-indigo-500">${Icons.Edit}</button>
                            <button onclick="actions.deletePlan('${plan.id}')" class="text-slate-300 hover:text-red-500">${Icons.Trash}</button>
                        </div>
                        <div class="flex flex-col items-start mb-4 pr-16 mt-2">
                            <div class="mb-3">
                                <span class="goal-tag ${tagStyle.cls}">
                                    <span class="text-sm">${tagStyle.emoji}</span> ${goalName}
                                </span>
                            </div>
                            <h2 class="text-lg font-bold text-slate-800">${plan.content}</h2>
                        </div>
                        <div class="flex items-baseline gap-2 mb-3">
                            <span class="text-4xl font-black ${isDone ? 'text-green-600' : 'text-indigo-600'}">${currentProgress}</span>
                            <span class="text-xs text-slate-400 font-bold">/ ${plan.target} å­—</span>
                        </div>
                        <div class="progress-track mb-5">
                            <div class="progress-jelly ${isDone?'done':''}" style="width: ${pct}%"></div>
                        </div>
                        ${isDone ? 
                            `<div class="w-full py-3 text-center text-green-700 font-bold text-sm bg-white/60 rounded-xl flex items-center justify-center gap-2">ğŸ‰ æ­å–œè¾¾æˆï¼</div>` : 
                            `<button onclick="actions.start('${plan.id}')" class="w-full bg-white text-indigo-600 py-3 rounded-xl font-bold shadow-sm border border-indigo-100 flex items-center justify-center gap-2 active:scale-95 transition-transform hover:bg-indigo-50">${Icons.Play} å¼€å§‹ä¸“æ³¨</button>`
                        }
                    </div>`;
                }).join('');
            } else {
                plansHtml = `<div class="text-center py-12 text-slate-300"><div class="mb-2 text-4xl opacity-50">ğŸƒ</div><p class="text-xs font-medium">ä»Šå¤©è¿™é‡Œå¾ˆå®‰é™ï¼Œæ·»åŠ ä¸€ä¸ªç›®æ ‡å§</p></div>`;
            }

            const addPlanCard = `<button onclick="actions.openAddPlan()" class="w-full bg-white border-2 border-dashed border-indigo-100 rounded-[24px] p-4 text-indigo-400 font-bold flex items-center justify-center gap-2 hover:bg-indigo-50 transition-colors">${Icons.Plus} æ·»åŠ ${isToday?'ä»Šæ—¥':'è¯¥æ—¥'}ä¸“æ³¨</button>`;

            const goals = state.customGoals.map(g => {
                const qtyPct = Math.min(100, Math.round((g.currentQty / g.targetQty) * 100));
                const isQtyDone = g.currentQty >= g.targetQty;
                return `
                <div class="bg-white rounded-[20px] p-5 border border-slate-100 mb-4 relative group transition-all hover:shadow-lg shadow-sm">
                    <div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="actions.openEditGoal('${g.id}')" class="text-slate-300 hover:text-indigo-500"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                        <button onclick="actions.delGoal('${g.id}')" class="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-lg text-slate-800">${g.name}</span>
                            ${isQtyDone ? '<span class="text-[10px] bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full border border-yellow-200 font-bold">å·²è¾¾æˆ</span>' : ''}
                        </div>
                        <div class="text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded font-medium">ç›®æ ‡: ${g.targetQty} ${g.unit}</div>
                    </div>
                    ${renderProgressBar(g.accumulatedWords, g.targetWords, "å­—æ•°è¿›åº¦")}
                    <div class="flex items-center gap-3 mt-4 pt-3 border-t border-slate-50">
                        <span class="text-xs font-bold text-slate-400">æ•°é‡è¿›åº¦</span>
                        <div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full bg-yellow-400 rounded-full" style="width: ${qtyPct}%"></div>
                        </div>
                        <div class="text-xs font-mono text-slate-500 w-12 text-right">${g.currentQty}/${g.targetQty}</div>
                        <button onclick="actions.addQty('${g.id}')" class="w-8 h-8 bg-green-50 text-green-600 rounded-full flex items-center justify-center font-bold text-xs hover:bg-green-100 transition-colors shadow-sm border border-green-100">+1</button>
                    </div>
                </div>`;
            }).join('');

            // æ›´æ–°äº†æ—¥æœŸè®¾ç½®çš„DOMç»“æ„ï¼šInputå»é™¤onchangeï¼ŒButtonç»‘å®šsaveGradSettings
            return `
                <div class="flex flex-col h-full bg-gray-50 overflow-hidden">
                    <div class="bg-slate-800 text-white p-5 pb-8 rounded-b-[30px] shadow-lg shrink-0 -mb-6 z-10 relative">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="text-xs text-indigo-300 font-bold uppercase tracking-wider mb-1 flex items-center gap-1">ğŸ“ æ¯•ä¸šå€’è®¡æ—¶</div>
                                <div class="text-2xl font-bold tracking-tight">${days !== null ? `è¿˜æœ‰ <span class="text-yellow-400 font-black text-3xl mx-1">${days}</span> å¤©` : 'ç‚¹å‡»è®¾ç½®'}</div>
                            </div>
                            <button onclick="actions.toggleGrad()" class="bg-white/10 p-2 rounded-full text-white hover:bg-white/20 transition">${Icons.Settings}</button>
                        </div>
                        ${state.showGradSettings ? `<div class="absolute inset-x-4 -bottom-16 bg-white shadow-xl p-4 rounded-xl flex items-center z-30 animate-scale-in border border-slate-100"><input type="date" id="grad-date-input" value="${state.graduationDate}" class="bg-slate-50 text-slate-800 border border-slate-200 rounded-lg p-2 flex-1 outline-none"><button onclick="actions.saveGradSettings()" class="ml-2 bg-indigo-600 text-white font-bold px-4 py-2 rounded-lg">ç¡®å®š</button></div>` : ''}
                    </div>

                    <div class="flex-1 overflow-y-auto px-4 pt-10 pb-24 space-y-6">
                        
                        <!-- Date Navigation -->
                        <div class="flex justify-between items-center bg-white p-2 rounded-2xl shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-slate-50">
                            <button onclick="actions.changeDate(-1)" class="p-3 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition">${Icons.Left}</button>
                            <div class="flex flex-col items-center">
                                <span class="text-lg font-bold text-slate-800">${dateStr}</span>
                                <span class="text-xs text-indigo-400 font-bold bg-indigo-50 px-2 py-0.5 rounded-full mt-1">${isToday ? 'ä»Šå¤©' : weekStr}</span>
                            </div>
                            <button onclick="actions.changeDate(1)" class="p-3 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition">${Icons.Right}</button>
                        </div>

                        <!-- å¿ƒç†èƒ½é‡ç«™ -->
                        <div class="bg-gradient-psych p-4 rounded-[20px] flex gap-3 items-start shadow-sm relative overflow-hidden">
                            <div class="absolute -right-2 -top-2 text-6xl opacity-10">âœ¨</div>
                            <div class="mt-1 bg-white p-1.5 rounded-full shadow-sm text-indigo-500"><i data-lucide="sparkles" class="w-4 h-4"></i></div>
                            <div>
                                <h4 class="text-xs font-bold text-indigo-400 mb-1 uppercase tracking-wider">å¿ƒç†èƒ½é‡ç«™</h4>
                                <p class="text-sm text-slate-700 italic font-medium leading-relaxed">"${state.dailyQuote}"</p>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-sm font-bold text-slate-400 mb-4 uppercase tracking-wider px-1 flex items-center gap-2"><div class="w-1 h-4 bg-indigo-400 rounded-full"></div> ${isToday?'ä»Šæ—¥':'å½“æ—¥'}ä¸“æ³¨</h3>
                            ${plansHtml}
                            ${addPlanCard}
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white p-4 rounded-[20px] border border-indigo-50 shadow-sm flex flex-col justify-center items-center text-center">
                                <div class="text-xs text-slate-400 mb-1 font-bold">æ€»å­—æ•°ç´¯ç§¯</div>
                                <div class="text-2xl font-black text-slate-800">${total.toLocaleString()}</div>
                            </div>
                            <div class="bg-white p-4 rounded-[20px] border border-orange-50 shadow-sm flex flex-col justify-center items-center text-center">
                                <div class="text-xs text-slate-400 mb-1 font-bold">${isToday?'ä»Šæ—¥':'å½“æ—¥'}æ€»äº§å‡º</div>
                                <div class="text-2xl font-black text-slate-800">${today.toLocaleString()}</div>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-4 px-1">
                                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2"><div class="w-1 h-4 bg-yellow-400 rounded-full"></div> æ¯•ä¸šæ€»ç›®æ ‡</h3>
                                <button onclick="actions.openAddGoal()" class="text-xs text-indigo-600 font-bold bg-indigo-50 hover:bg-indigo-100 px-3 py-1.5 rounded-lg transition">+ æ–°å»ºç›®æ ‡</button>
                            </div>
                            ${goals}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Render Working/Add/Rank/History ---
        // (ä¿æŒä¹‹å‰çš„å®ç°ï¼Œç¡®ä¿ render èƒ½å¤Ÿè°ƒç”¨å®ƒä»¬)
        function renderWorking() {
            const plan = state.dailyPlans.find(p => p.id === state.currentSession.planId);
            const goalTitle = plan ? plan.content : 'è‡ªç”±å†™ä½œ';
            const net = (parseInt(state.formData.endCount)||state.currentSession.startCount) - state.currentSession.startCount;
            return `<div class="flex flex-col h-full bg-gray-50 pb-safe overflow-y-auto"><div class="bg-white p-6 pb-8 border-b border-slate-100 shadow-sm mb-4 relative overflow-hidden"><div class="absolute top-0 right-0 w-40 h-40 bg-indigo-50 rounded-full -mr-12 -mt-12 blur-3xl opacity-60"></div><div class="flex justify-between items-start mb-6 relative z-10"><div class="inline-flex items-center gap-1 bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold animate-pulse-soft border border-indigo-100"><span class="w-2 h-2 bg-indigo-500 rounded-full"></span> ä¸“æ³¨æ¨¡å¼</div><button onclick="actions.cancelSession()" class="text-slate-400 hover:text-red-500 bg-slate-50 p-2 rounded-full">${Icons.X}</button></div><h2 class="text-3xl font-bold text-slate-800 mb-2 relative z-10">${goalTitle}</h2><div class="text-slate-500 text-sm mb-6 relative z-10">å¼€å§‹äº <span class="font-mono font-bold text-indigo-500">${new Date(state.currentSession.start).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div><div class="flex items-center gap-2 text-sm text-slate-400 mb-6 relative z-10 bg-slate-50 p-3 rounded-xl border border-slate-100 inline-flex"><span>åˆå§‹å­—æ•°: ${state.currentSession.startCount}</span><button onclick="actions.adjustStart()" class="text-indigo-500 text-xs font-bold hover:underline bg-white px-2 py-1 rounded shadow-sm">ä¿®æ­£</button></div><div class="bg-gradient-to-br from-indigo-50 to-white rounded-2xl p-5 border border-indigo-100 relative z-10 text-center shadow-sm"><div class="text-xs text-indigo-400 font-bold mb-1 uppercase tracking-wider">æœ¬æ¬¡äº§å‡º</div><div class="text-5xl font-black text-indigo-600" id="net-word-display">${net > 0 ? '+' + net : net}</div></div></div><form onsubmit="actions.end(event)" class="px-4 space-y-4 flex-1 flex flex-col"><div class="bg-white p-5 rounded-[24px] shadow-sm border border-slate-100"><label class="text-sm font-bold text-slate-500 mb-3 block text-center">ç»“æŸå­—æ•°</label><input type="number" name="endCount" required value="${state.formData.endCount||''}" oninput="actions.setFormData('endCount',this.value)" class="text-5xl font-black text-slate-800 w-full text-center outline-none border-b-2 border-transparent focus:border-indigo-100 bg-transparent py-2 placeholder-slate-200" placeholder="${state.currentSession.startCount}"></div><div class="bg-white p-5 rounded-[24px] shadow-sm border border-slate-100 space-y-4 flex-1"><div><label class="text-sm font-bold text-slate-500 mb-3 block">çŠ¶æ€ & æ„Ÿæƒ³</label><div class="flex justify-around mb-6">${['happy','neutral','sad','tired'].map(m => `<button type="button" onclick="actions.setMood('${m}')"><i data-lucide="${{happy:'smile',neutral:'meh',sad:'frown',tired:'coffee'}[m]}" class="w-10 h-10 mood-icon ${state.formData.mood===m?'selected text-indigo-500':'text-slate-300'}"></i></button>`).join('')}</div><textarea name="reflection" placeholder="å†™å¾—æ€ä¹ˆæ ·ï¼Ÿè®°å½•ä¸€ä¸‹æ­¤åˆ»çš„å¿ƒæƒ…..." oninput="actions.setFormData('reflection',this.value)" class="w-full bg-slate-50 border border-slate-100 rounded-2xl p-4 text-sm h-32 resize-none outline-none focus:ring-2 focus:ring-indigo-100 transition">${state.formData.reflection}</textarea></div></div><button class="w-full primary-gradient text-white font-bold py-4 rounded-[20px] shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 mt-4 active:scale-95 transition-transform">${Icons.Check} å®Œæˆæ‰“å¡</button></form></div>`;
        }

        function renderAddEntry() {
            const goalOptions = state.customGoals.map(g => `<option value="${g.id}" ${g.id === state.formData.linkedGoalId ? 'selected' : ''}>${g.name} (ä¸Šæ¬¡ç»“æŸ: ${getLastCountForGoal(g.id)})</option>`).join('');
            const net = (parseInt(state.formData.endCount)||state.formData.startCount) - state.formData.startCount;
            return `<div class="pb-safe h-full overflow-y-auto bg-gray-50"><div class="px-5 pt-8 pb-24"><h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2">ğŸ“ è¡¥å½•æ‰“å¡</h2><form onsubmit="actions.end(event)" class="space-y-5"><div class="bg-white p-6 rounded-[24px] shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-slate-50"><div class="mb-5"><label class="text-xs font-bold text-slate-400 mb-2 block uppercase tracking-wider">æ—¥æœŸ</label><input type="date" name="date" value="${state.formData.date || getTodayStr()}" onchange="actions.setFormData('date',this.value)" class="w-full bg-slate-50 border border-slate-100 rounded-xl p-3 text-sm outline-none focus:border-indigo-500 font-medium"></div><div class="mb-5"><label class="text-xs font-bold text-slate-400 mb-2 block uppercase tracking-wider">å…³è”ç›®æ ‡</label><select onchange="actions.setFormData('linkedGoalId',this.value)" class="w-full bg-slate-50 border border-slate-100 rounded-xl p-3 text-sm outline-none focus:border-indigo-500 font-medium appearance-none">${goalOptions}</select></div><div class="grid grid-cols-2 gap-4 mb-5"><div><label class="text-xs font-bold text-slate-400 mb-2 block uppercase tracking-wider">å¼€å§‹å­—æ•°</label><div class="flex items-center"><button type="button" onclick="actions.adjustManualStart(-100)" class="p-3 bg-slate-100 rounded-l-xl text-slate-500 hover:bg-slate-200 font-bold">-</button><input type="number" name="startCount" value="${state.formData.startCount}" oninput="actions.setFormData('startCount',this.value)" class="w-full text-center bg-slate-50 border-y border-slate-100 py-3 text-sm font-bold outline-none"><button type="button" onclick="actions.adjustManualStart(100)" class="p-3 bg-slate-100 rounded-r-xl text-slate-500 hover:bg-slate-200 font-bold">+</button></div></div><div><label class="text-xs font-bold text-slate-400 mb-2 block uppercase tracking-wider">ç»“æŸå­—æ•°</label><input type="number" name="endCount" required value="${state.formData.endCount}" oninput="actions.setFormData('endCount',this.value)" class="w-full bg-white border-2 border-indigo-100 rounded-xl p-2.5 text-lg font-bold text-center outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-50 transition"></div></div><div class="flex justify-between items-center bg-indigo-50 p-4 rounded-xl"><span class="text-sm text-indigo-400 font-bold">æœ¬æ¬¡å‡€å¢</span><span id="net-word-display" class="font-black text-2xl text-indigo-600">${net} å­—</span></div></div><div class="bg-white p-6 rounded-[24px] shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-slate-50 space-y-6"><div><div class="flex justify-between items-center mb-4"><label class="text-xs font-bold text-slate-400 uppercase tracking-wider">çŠ¶æ€ & æ„Ÿæƒ³</label><button type="button" onclick="actions.autoGenReflection()" class="text-xs bg-purple-50 text-purple-600 px-3 py-1.5 rounded-lg flex items-center gap-1 font-bold hover:bg-purple-100 transition">${Icons.Wand} å¸®æˆ‘å†™</button></div><div class="flex justify-around mb-6">${['happy','neutral','sad','tired'].map(m => `<button type="button" onclick="actions.setMood('${m}')">${MoodIcon(m, state.formData.mood === m)}</button>`).join('')}</div><textarea name="reflection" placeholder="å¦‚æœä¸å†™ï¼Œæˆ‘å°±å¸®ä½ è‡ªåŠ¨ç”Ÿæˆå•¦~" oninput="actions.setFormData('reflection',this.value)" class="w-full bg-slate-50 border border-slate-100 rounded-xl p-4 text-sm h-28 resize-none outline-none focus:ring-2 focus:ring-indigo-100 transition">${state.formData.reflection}</textarea></div><div><div class="flex justify-between items-center mb-3"><label class="text-xs font-bold text-slate-400 uppercase tracking-wider">æŠ•å…¥æ—¶é•¿</label><span id="duration-display" class="text-sm font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded-lg min-w-[4rem] text-center">${state.formData.duration || '0 å°æ—¶'}</span></div><div class="px-2 py-2"><input type="range" min="0" max="12" step="0.5" value="${state.formData.durationNum || 0}" oninput="actions.updateDuration(this.value)"><div class="flex justify-between text-[10px] text-slate-300 mt-2 font-mono"><span>0h</span><span>6h</span><span>12h</span></div></div></div><div><label class="text-xs font-bold text-slate-400 mb-2 block uppercase tracking-wider">å®Œæˆå†…å®¹ (é€‰å¡«)</label><input type="text" name="chapter" value="${state.formData.chapter}" oninput="actions.setFormData('chapter',this.value)" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸‰ç« æ–‡çŒ®ç»¼è¿°" class="w-full bg-slate-50 border border-slate-100 rounded-xl p-3 text-sm outline-none focus:border-indigo-300"></div></div><button class="w-full primary-gradient text-white font-bold py-4 rounded-[20px] shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 active:scale-95 transition-transform">${Icons.Check} æäº¤æ‰“å¡</button></form></div></div>`;
        }

        function renderRank() {
            if(state.loadingLeaderboard) return `<div class="p-10 text-center text-slate-400 flex flex-col items-center gap-2"><div class="spinner"></div><p class="text-xs">æ¦œå•åˆ·æ–°ä¸­...</p></div>`;
            const list = state.leaderboard.map((u,i)=> {
                let rankBadge = `<span class="font-bold w-6 text-center text-slate-400">${i+1}</span>`;
                if(i===0) rankBadge = `<span class="text-xl">ğŸ¥‡</span>`;
                if(i===1) rankBadge = `<span class="text-xl">ğŸ¥ˆ</span>`;
                if(i===2) rankBadge = `<span class="text-xl">ğŸ¥‰</span>`;
                return `<div class="flex items-center gap-3 p-4 bg-white border border-slate-100 rounded-[20px] mb-3 shadow-[0_2px_10px_rgba(0,0,0,0.02)]"><div class="w-8 flex justify-center">${rankBadge}</div><img src="${u.avatar}" class="w-10 h-10 rounded-full border-2 border-white shadow-sm"><span class="flex-1 font-bold text-sm text-slate-700">${u.username}</span><div class="bg-indigo-50 px-3 py-1 rounded-full"><span class="font-black text-indigo-600 text-sm">${u.wordCount}</span> <span class="text-xs text-indigo-400">å­—</span></div></div>`;
            }).join('');
            return `<div class="p-4 bg-gray-50 h-full overflow-y-auto"><div class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white p-6 rounded-[24px] shadow-lg mb-6 relative overflow-hidden"><div class="absolute right-0 top-0 text-6xl opacity-20">ğŸ†</div><h2 class="font-bold text-xl mb-1">ä»Šæ—¥é¾™è™æ¦œ</h2><p class="text-xs opacity-90">çœ‹è§åšæŒçš„åŠ›é‡ Â· å…¨ç½‘åŒæ­¥</p></div>${list||'<div class="flex flex-col items-center justify-center py-20 opacity-50"><div class="text-4xl mb-2">ğŸƒ</div><p class="text-sm">ä»Šæ—¥è¿˜æ²¡æœ‰äººæ‰“å¡å“¦</p></div>'}</div>`;
        }

        function renderHistory() {
            const list = state.entries.slice().reverse().map(e=>`<div class="bg-white p-5 rounded-[24px] border border-slate-100 shadow-sm mb-4 relative overflow-hidden"><div class="absolute left-0 top-0 bottom-0 w-2 bg-indigo-500"></div><div class="pl-3"><div class="flex justify-between mb-2"><span class="text-xs font-bold text-slate-400 bg-slate-50 px-2 py-0.5 rounded">${e.date}</span><span class="text-green-600 font-bold bg-green-50 px-2 py-0.5 rounded">+${e.dailyCount}å­—</span></div><div class="text-base font-bold text-slate-800 mb-2">${e.linkedPlanContent || e.linkedGoalName || 'è‡ªç”±å†™ä½œ'}</div><div class="text-sm text-slate-500 bg-slate-50 p-3 rounded-xl italic">"${e.reflection||'æ— æ„Ÿæƒ³'}"</div>${e.duration ? `<div class="mt-2 text-xs text-slate-400 flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> æŠ•å…¥æ—¶é•¿: ${e.duration}</div>` : ''}</div></div>`).join('');
            return `<div class="p-4 bg-gray-50 h-full overflow-y-auto"><div class="flex justify-between items-center mb-6 px-1"><h2 class="font-bold text-xl text-slate-800">å†å²è¶³è¿¹</h2><span class="text-xs text-slate-400 bg-white px-2 py-1 rounded-full border border-slate-100 shadow-sm">å½“å‰è´¦å·: ${state.user.username}</span></div>${list||'<p class="text-center text-slate-400 mt-20">ç©ºç©ºå¦‚ä¹Ÿï¼Œå»å†™ä¸‹ç¬¬ä¸€ç¬”å§ï¼</p>'}</div>`;
        }

        // --- Render ---
        function render() {
            const app = document.getElementById('app');
            if (!app) return;
            cleanOldPlans();

            // ä¿®å¤ï¼šåªè¦ render è¢«è°ƒç”¨ï¼Œå°±è¦†ç›– innerHTMLï¼Œä¸å†åˆ¤æ–­ state.view === 'loading'
            // è¿™æ ·èƒ½ä¿è¯ loading ç•Œé¢ä¸€å®šä¼šè¢«ç§»é™¤
            
            let htmlContent = '';
            
            if (state.view === 'login') {
                htmlContent = renderLogin();
            } else if (state.view === 'app') {
                if (state.currentSession && state.currentSession.isActive) {
                    htmlContent = renderWorking();
                } else {
                    let content = '';
                    if (state.activeTab === 'dashboard') content = renderDashboard();
                    else if (state.activeTab === 'rank') content = renderRank();
                    else if (state.activeTab === 'add') content = renderAddEntry();
                    else content = renderHistory(); 
                    
                    const sidebar = state.showSidebar ? `<div class="fixed inset-0 bg-black/50 z-40 animate-fade-in" onclick="actions.toggleSidebar()"></div><div class="fixed top-0 left-0 h-full w-64 bg-white z-50 shadow-2xl p-0 flex flex-col animate-slide-up" style="animation-direction: normal; animation-name: slide-right;"><div class="p-6 border-b border-slate-100 bg-slate-50"><div class="flex items-center gap-3 mb-4"><img src="${state.user.avatar}" class="w-14 h-14 rounded-full border-2 border-white shadow-sm"><div><h3 class="font-bold text-slate-800">${state.user.username}</h3><button onclick="actions.editProfile()" class="text-xs text-indigo-500">ç¼–è¾‘èµ„æ–™</button></div></div><div class="bg-white p-3 rounded-lg border border-slate-200"><div class="text-xs text-slate-400 mb-1">ç´¯è®¡äº§å‡º</div><div class="text-sm font-bold text-slate-800">${state.entries.reduce((a,b)=>a+b.dailyCount,0).toLocaleString()} å­—</div></div></div><div class="p-2 space-y-1"><button onclick="actions.askLogout()" class="w-full flex items-center gap-3 p-3 text-slate-600 hover:bg-slate-50 rounded-xl"><span class="text-indigo-500">${Icons.Switch}</span> åˆ‡æ¢è´¦å·</button><button onclick="actions.askLogout()" class="w-full flex items-center gap-3 p-3 text-red-500 hover:bg-red-50 rounded-xl"><span class="text-red-500">${Icons.LogOut}</span> é€€å‡ºç™»å½•</button></div></div>` : '';

                    let modals = '';
                    // ... (Modal logic remains same but compacted for single file safety)
                    if (state.showPlanModal) {
                        const isEdit = !!state.editingPlanId;
                        const options = state.customGoals.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
                        modals += `<div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="actions.closePlanModal()"><div class="bg-white rounded-2xl p-6 w-full max-w-sm" onclick="event.stopPropagation()"><h3 class="font-bold text-lg mb-4 text-slate-800">${isEdit ? 'ç¼–è¾‘ç›®æ ‡' : 'æ·»åŠ ä»Šæ—¥ä¸“æ³¨'}</h3><form onsubmit="actions.savePlan(event)" class="space-y-3"><div><label class="text-xs text-slate-500 font-bold ml-1">å…³è”æ¯•ä¸šç›®æ ‡</label><select onchange="actions.setPlanForm('linkedGoalId',this.value)" class="w-full bg-gray-50 border p-2 rounded-lg text-sm">${options}</select></div><div><label class="text-xs text-slate-500 font-bold ml-1">å…·ä½“å†…å®¹</label><input value="${state.planFormData.content}" oninput="actions.setPlanForm('content',this.value)" class="w-full border p-2 rounded-lg" required></div><div><label class="text-xs text-slate-500 font-bold ml-1">é¢„è®¡å­—æ•°</label><input type="number" value="${state.planFormData.target}" oninput="actions.setPlanForm('target',this.value)" class="w-full border p-2 rounded-lg" required></div><button class="w-full primary-gradient text-white py-3 rounded-xl font-bold mt-2">ä¿å­˜</button></form></div></div>`;
                    }
                    if (state.showGoalModal) {
                        const isEdit = !!state.editingGoalId;
                        modals += `<div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="actions.toggleGoalModal()"><div class="bg-white rounded-2xl p-6 w-full max-w-sm" onclick="event.stopPropagation()"><h3 class="font-bold text-lg mb-4">${isEdit?'ç¼–è¾‘':'æ·»åŠ '}æ¯•ä¸šç›®æ ‡</h3><div class="space-y-3"><input placeholder="åç§° (å¦‚: SCIè®ºæ–‡)" value="${state.newGoalData.name}" oninput="actions.setNewGoal('name',this.value)" class="w-full border p-2 rounded"><div class="flex gap-2"><input type="number" placeholder="æ•°é‡ (3)" value="${state.newGoalData.targetQty}" oninput="actions.setNewGoal('targetQty',this.value)" class="w-full border p-2 rounded"><input placeholder="å•ä½ (ç¯‡)" value="${state.newGoalData.unit}" oninput="actions.setNewGoal('unit',this.value)" class="w-20 border p-2 rounded"></div><input type="number" placeholder="é¢„è®¡æ€»å­—æ•° (å¦‚: 50000)" value="${state.newGoalData.targetWords}" oninput="actions.setNewGoal('targetWords',this.value)" class="w-full border p-2 rounded"></div><div class="flex gap-2 mt-4"><button onclick="actions.toggleGoalModal()" class="flex-1 py-2 text-slate-500">å–æ¶ˆ</button><button onclick="actions.saveGoal()" class="flex-1 primary-gradient text-white rounded">ä¿å­˜</button></div></div></div>`;
                    }
                    if (state.showLogoutModal) {
                        modals += `<div class="fixed inset-0 bg-black/60 z-[80] flex items-center justify-center p-6 animate-fade-in" onclick="actions.cancelLogout()"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-xl animate-scale-in" onclick="event.stopPropagation()"><h3 class="text-lg font-bold text-center mb-2">ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ</h3><div class="flex gap-3 mt-6"><button onclick="actions.cancelLogout()" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold">å–æ¶ˆ</button><button onclick="actions.confirmLogout()" class="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold">ç¡®è®¤é€€å‡º</button></div></div></div>`;
                    }
                    if (state.showFeedback) {
                        modals += `<div class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-6"><div class="bg-white rounded-2xl p-6 w-full max-w-sm text-center"><div class="text-4xl mb-2">ğŸ‰</div><h3 class="font-bold text-xl mb-1">æ‰“å¡æˆåŠŸ!</h3><p class="text-slate-500 mb-4">æœ¬æ¬¡äº§å‡º <span class="font-bold text-indigo-600">${state.feedbackData.diff}</span> å­—</p><div class="bg-indigo-50 p-4 rounded-xl text-indigo-800 text-sm mb-4 italic">"${state.feedbackData.encourageMsg}"</div><button onclick="actions.closeFeedback()" class="w-full primary-gradient text-white py-3 rounded-xl font-bold">å¥½çš„</button></div></div>`;
                    }
                    if (state.showProfileModal) {
                        modals += `<div class="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-6" onclick="actions.closeProfile()"><div class="bg-white rounded-2xl p-6 w-full max-w-sm" onclick="event.stopPropagation()"><h3 class="font-bold text-lg mb-4">ç¼–è¾‘èµ„æ–™</h3><div class="text-center mb-4"><img src="${state.tempProfile.avatar}" class="w-20 h-20 rounded-full mx-auto mb-2"><button onclick="actions.randAvatar()" class="text-xs text-indigo-500">æ¢ä¸ªå¤´åƒ</button></div><input value="${state.tempProfile.name}" oninput="actions.setTempProfile('name',this.value)" class="w-full border p-2 rounded mb-4 text-center font-bold"><button onclick="actions.saveProfile(event)" class="w-full primary-gradient text-white py-3 rounded-xl">ä¿å­˜</button></div></div>`;
                    }

                    const nav = `<nav class="bg-white border-t border-slate-100 flex justify-around items-center h-16 shrink-0 z-20 pb-safe"><button onclick="actions.setTab('dashboard')" class="flex flex-col items-center gap-1 ${state.activeTab==='dashboard'?'text-indigo-600':'text-slate-400'}">${Icons.Target}<span class="text-[10px]">ä¸»é¡µ</span></button><button onclick="actions.setTab('add')" class="flex flex-col items-center gap-1 ${state.activeTab==='add'?'text-indigo-600':'text-slate-400'}"><div class="bg-indigo-600 text-white p-3 rounded-full shadow-lg shadow-indigo-200 -mt-6 mb-1 transform active:scale-95 transition"><span class="block">${Icons.Plus}</span></div><span class="text-[10px]">æ‰“å¡</span></button><button onclick="actions.setTab('rank')" class="flex flex-col items-center gap-1 ${state.activeTab==='rank'?'text-indigo-600':'text-slate-400'}">${Icons.Medal}<span class="text-[10px]">æ¦œå•</span></button></nav>`;

                    htmlContent = `<header class="bg-white px-6 py-4 flex justify-between items-center border-b border-slate-50 shadow-sm z-30"><div class="flex items-center gap-2"><button onclick="actions.toggleSidebar()" class="text-slate-600 hover:bg-slate-50 p-1 rounded-lg">${Icons.Menu}</button><span class="font-bold text-lg text-slate-800">åšå£«å†™ä½œåŠ©æ‰‹</span></div><div class="text-sm text-indigo-600 font-bold bg-indigo-50 px-3 py-1 rounded-full border border-indigo-100">${AppLogo("w-6 h-6")}</div></header><main class="flex-1 overflow-hidden relative">${content}</main>${nav}${sidebar}${modals}`;
                }
            }
            
            app.innerHTML = htmlContent;
            if (window.lucide) lucide.createIcons();
        }
        
        // --- åˆå§‹åŒ–å…¥å£ ---
        function initApp() {
            try {
                const savedUser = Storage.get('phd_current_user', null);
                
                if (savedUser) {
                    loadLocalUser(savedUser);
                } else {
                    state.view = 'login';
                    render();
                }
            } catch (error) {
                console.error("Init failed:", error);
                // ç»ˆæ Fallbackï¼šå¦‚æœä¸€åˆ‡éƒ½å¤±è´¥äº†ï¼Œå¼ºåˆ¶å»ç™»å½•é¡µï¼Œä¸å†æ˜¾ç¤º loading
                state.view = 'login';
                render();
            }
        }

        // --- å¯åŠ¨é€»è¾‘ ---
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            // å¦‚æœè„šæœ¬æ‰§è¡Œæ—¶ DOM å·²ç»å°±ç»ªï¼ˆä¾‹å¦‚ defer è„šæœ¬ï¼‰ï¼Œç›´æ¥æ‰§è¡Œ
            initApp();
        }
        
        // --- åŒé‡ä¿é™© ---
        // å¦‚æœ 1.5 ç§’åé¡µé¢è¿˜åœ¨ loading çŠ¶æ€ï¼ˆè¯´æ˜ initApp å¯èƒ½æŒ‚äº†ï¼‰ï¼Œå¼ºåˆ¶æ˜¾ç¤ºç™»å½•é¡µ
        setTimeout(() => {
            const loadingEl = document.getElementById('loading-screen');
            if (loadingEl && document.body.contains(loadingEl)) {
                console.warn("Forcing login view due to timeout");
                state.view = 'login';
                render();
            }
        }, 1500);

    </script>
</body>
</html>
